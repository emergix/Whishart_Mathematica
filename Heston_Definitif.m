(* ::Package:: *)

(************************************************************************)
(* This file was generated automatically by the Mathematica front end.  *)
(* It contains Initialization cells from a Notebook file, which         *)
(* typically will have the same name as this file except ending in      *)
(* ".nb" instead of ".m".                                               *)
(*                                                                      *)
(* This file is intended to be loaded into the Mathematica kernel using *)
(* the package loading commands Get or Needs.  Doing so is equivalent   *)
(* to using the Evaluate Initialization Cells menu command in the front *)
(* end.                                                                 *)
(*                                                                      *)
(* DO NOT EDIT THIS FILE.  This entire file is regenerated              *)
(* automatically each time the parent Notebook file is saved in the     *)
(* Mathematica front end.  Any changes you make to this file will be    *)
(* overwritten.                                                         *)
(************************************************************************)



<< "C:\\Documents and Settings\\ocroissant\\My Documents\\NumericalIntegration.m"


<< "C:\\Documents and Settings\\ocroissant\\My Documents\\BS.m"


<< "C:\\Documents and Settings\\ocroissant\\My Documents\\BiHeston\\BiHeston_Calibration.m"


Needs["PlotLegends`"]


NormalCallPayOff[S0_,k_,\[Lambda]_]:=\[ExponentialE]^(-\[Lambda] S0) (S0-k) UnitStep[S0-k]


NormalCallPayOff[S0_,k_,\[Alpha]_,a_,\[Lambda]_]:=\[ExponentialE]^(-\[Lambda] S0) (\[Alpha] S0^a-k) UnitStep[\[Alpha] S0^a-k]


NormalPutPayOff[S0_,k_,\[Lambda]_]:=NormalCallPayOff[-S0,-k,\[Lambda]]


NormalCallPayOffFourierTransform[k_,\[Omega]_]:=-((\[ExponentialE]^ (\[ImaginaryI] k \[Omega]))/  (\[Omega]^2))


NormalCallPayOffFourierTransform[k_,\[Alpha]_,a_,\[Omega]_]:=-((\[ImaginaryI] (\[ExponentialE]^(\[ImaginaryI] (k/\[Alpha])^(1/a) \[Omega]) k-\[Alpha] (-\[ImaginaryI] \[Omega])^-a Gamma[1+a,-\[ImaginaryI] (k/\[Alpha])^(1/a) \[Omega]]))/\[Omega])


LogNormalCallPayOff[S0_,k_]:= (\[ExponentialE]^S0-k)UnitStep[\[ExponentialE]^S0-k]


LogNormalCallPayOff[S0_,k_,\[Alpha]_,a_]:= (\[Alpha] \[ExponentialE]^(a S0)-k)UnitStep[\[Alpha] \[ExponentialE]^(a S0)-k]


LogNormalCallPayOffFourierTransform[k_,\[Omega]_]:=k^(1+\[ImaginaryI] \[Omega])/  (\[Omega]-\[ImaginaryI])\[Omega]


LogNormalCallPayOffFourierTransform[k_,n_,\[Omega]_]:=(k^(1+(\[ImaginaryI] \[Omega])/n) n)/(\[Omega]^2-\[ImaginaryI] \[Omega] n)


LogNormalCallPayOffFourierTransform[K_,\[Alpha]_,a_,\[Omega]_]:=(a K (K/\[Alpha])^((\[ImaginaryI] \[Omega])/a))/(\[Omega]^2-\[ImaginaryI] a \[Omega])


NormalHestonFondamentalTransform[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,\[Omega]_,\[Tau]_]:=Module[{\[Zeta],\[Psi]p ,\[Psi]m,A,B,arg\[Zeta],\[Eta]},
\[Eta]=\[Lambda]v+\[Rho] \[Kappa] \[ImaginaryI] \[Omega];
arg\[Zeta]=\[Eta]^2+\[Kappa]^2 \[Omega]^2;
\[Zeta]=Sqrt[arg\[Zeta]];
\[Psi]p =-\[Eta]+\[Zeta];
\[Psi]m =\[Eta]+\[Zeta];
A=-( \[Theta]v \[Lambda]v (\[Tau] \[Psi]p+2 Log[(\[Psi]m+\[ExponentialE]^(-\[Zeta] \[Tau]) \[Psi]p)/(2\[Zeta])])/ (\[Kappa]^2)   );
B= -\[Omega]^2(1-\[ExponentialE]^(-\[Zeta]  \[Tau]))/(\[Psi]m+\[Psi]p \[ExponentialE]^(-\[Zeta]  \[Tau]));
If[Re[A+B V]<-100,0,
\[ExponentialE]^(A+B V)]]


NormalHestonFondamentalTransform[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Omega]_,\[Tau]_]:=
Module[{\[Zeta]1,\[Psi]p1 ,\[Psi]m1,B1,arg\[Zeta]1,\[Eta]1,\[Zeta]2,\[Psi]p2 ,\[Psi]m2,A2,B2,arg\[Zeta]2,\[Eta]2,A},
\[Eta]1=\[Lambda]v1+\[Rho]1 \[Kappa]1 \[ImaginaryI] \[Omega];
arg\[Zeta]1=\[Eta]1^2+\[Kappa]1^2 \[Omega]^2;
\[Zeta]1=Sqrt[arg\[Zeta]1];
\[Psi]p1 =-\[Eta]1+\[Zeta]1;
\[Psi]m1 =\[Eta]1+\[Zeta]1;
B1= -\[Omega]^2(1-\[ExponentialE]^(-\[Zeta]1  \[Tau]))/(\[Psi]m1+\[Psi]p1 \[ExponentialE]^(-\[Zeta]1  \[Tau]));
\[Eta]2=\[Lambda]v2+\[Rho]2 \[Kappa]2 \[ImaginaryI] \[Omega];
arg\[Zeta]2=\[Eta]2^2+\[Kappa]2^2 \[Omega]^2;
\[Zeta]2=Sqrt[arg\[Zeta]2];
\[Psi]p2 =-\[Eta]2+\[Zeta]2;
\[Psi]m2 =\[Eta]2+\[Zeta]2;
B2= -\[Omega]^2(1-\[ExponentialE]^(-\[Zeta]2  \[Tau]))/(\[Psi]m2+\[Psi]p2 \[ExponentialE]^(-\[Zeta]2  \[Tau]));
A=-( \[Theta]v1 \[Lambda]v1 (\[Tau] \[Psi]p1+2 Log[(\[Psi]m1+\[ExponentialE]^(-\[Zeta]1 \[Tau]) \[Psi]p1)/(2\[Zeta]1)])/ (\[Kappa]1^2)   )- \[Theta]v2 \[Lambda]v2 (\[Tau] \[Psi]p2+2 Log[(\[Psi]m2+\[ExponentialE]^(-\[Zeta]2 \[Tau]) \[Psi]p2)/(2\[Zeta]2)])/ (\[Kappa]2^2)   ;
If[Re[A+B1 V1+B2 V2]<-100,0,
\[ExponentialE]^(A+B1 V1+B2 V2)]
]


NormalHestonFondamentalTransform[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,\[Omega]_,\[Tau]_]:=
Module[{\[Zeta]1,\[Psi]p1 ,\[Psi]m1,arg\[Zeta]1,\[Eta]1,\[Zeta]2,\[Psi]p2 ,\[Psi]m2,arg\[Zeta]2,\[Eta]2,\[Zeta]3,\[Psi]p3 ,\[Psi]m3,A3,arg\[Zeta]3,\[Eta]3,B1,B2,B3,A},
\[Eta]1=\[Lambda]v1+\[Rho]1 \[Kappa]1 \[ImaginaryI] \[Omega];
arg\[Zeta]1=(\[Lambda]v1+\[Rho]1 \[Kappa]1 \[ImaginaryI] \[Omega])^2+\[Kappa]1^2 \[Omega]^2;
\[Zeta]1=Sqrt[arg\[Zeta]1];
\[Psi]p1 =-\[Eta]1+\[Zeta]1;
\[Psi]m1 =\[Eta]1+\[Zeta]1;
B1= -\[Omega]^2(1-\[ExponentialE]^(-\[Zeta]1  \[Tau]))/(\[Psi]m1+\[Psi]p1 \[ExponentialE]^(-\[Zeta]1  \[Tau]));
\[Eta]2=\[Lambda]v2+\[Rho]2 \[Kappa]2 \[ImaginaryI] \[Omega];
arg\[Zeta]2=\[Eta]2^2+\[Kappa]2^2 \[Omega]^2;
\[Zeta]2=Sqrt[arg\[Zeta]2];
\[Psi]p2 =-\[Eta]2+\[Zeta]2;
\[Psi]m2 =\[Eta]2+\[Zeta]2;
B2= -\[Omega]^2(1-\[ExponentialE]^(-\[Zeta]2  \[Tau]))/(\[Psi]m2+\[Psi]p2 \[ExponentialE]^(-\[Zeta]2  \[Tau]));
\[Eta]3=\[Lambda]v3+\[Rho]3 \[Kappa]3 \[ImaginaryI] \[Omega];
arg\[Zeta]3=\[Eta]3^2+\[Kappa]3^2 \[Omega]^2;
\[Zeta]3=Sqrt[arg\[Zeta]3];
\[Psi]p3 =-\[Eta]3+\[Zeta]3;
\[Psi]m3 =\[Eta]3+\[Zeta]3;
B3= -\[Omega]^2(1-\[ExponentialE]^(-\[Zeta]3  \[Tau]))/(\[Psi]m3+\[Psi]p3 \[ExponentialE]^(-\[Zeta]3  \[Tau]));
A=-( \[Theta]v1 \[Lambda]v1 (\[Tau] \[Psi]p1+2 Log[(\[Psi]m1+\[ExponentialE]^(-\[Zeta]1 \[Tau]) \[Psi]p1)/(2\[Zeta]1)])/ (\[Kappa]1^2)   )- \[Theta]v2 \[Lambda]v2 (\[Tau] \[Psi]p2+2 Log[(\[Psi]m2+\[ExponentialE]^(-\[Zeta]2 \[Tau]) \[Psi]p2)/(2\[Zeta]2)])/ (\[Kappa]2^2)   - \[Theta]v3 \[Lambda]v3 (\[Tau] \[Psi]p3+2 Log[(\[Psi]m3+\[ExponentialE]^(-\[Zeta]3 \[Tau]) \[Psi]p3)/(2\[Zeta]3)])/ (\[Kappa]3^2)   ;
If[Re[A+B1 V1+B2 V2+B3 V3]<-100,0,
\[ExponentialE]^(A+B1 V1+B2 V2+B3 V3)]
]


NormalHestonShiftDiscriminator[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,\[Tau]_,\[Lambda]_]:=(\[Lambda]v-\[Rho] \[Kappa] \[Lambda])+Sqrt[(\[Lambda]v-\[Rho] \[Kappa] \[Lambda])^2-\[Kappa]^2 \[Lambda]^2]+(-(\[Lambda]v-\[Rho] \[Kappa] \[Lambda])+Sqrt[(\[Lambda]v-\[Rho] \[Kappa] \[Lambda])^2-\[Kappa]^2 \[Lambda]^2])\[ExponentialE]^(-Sqrt[(\[Lambda]v-\[Rho] \[Kappa] \[Lambda])^2-\[Kappa]^2 \[Lambda]^2] \[Tau])


NormalHestonOptimalShift[\[Lambda]v_,\[Rho]_,\[Kappa]_]:=Min[0.5, (\[Lambda]v (1-\[Rho]^2/2))/(2\[Kappa] )] 


NormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,S0_,K_,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  S0) NormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Omega],T]NormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]]]


NormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,K_,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  S0) NormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Omega],T]NormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]]]


NormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,K_,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  S0) NormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Omega],T]NormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]]]


NormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,S0_,K_List,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  S0) NormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Omega],T]Table[NormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]],{i,1,Length[K]}]]


NormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,K_List,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  S0) NormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Omega],T]Table[NormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]],{i,1,Length[K]}]]


NormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,K_List,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  S0) NormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Omega],T]Table[NormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]],{i,1,Length[K]}]]


HestonNormalCallN[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
NIntegrate[NormalHestonCallIntegrand[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


HestonNormalCallN[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,T_]:=1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
NIntegrate[NormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


HestonNormalCallN[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,T_]:=1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
NIntegrate[NormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


HestonNormalCallAux[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=1/\[Pi] Re[Module[{\[Lambda]=NormalHestonOptimalShift[\[Lambda]v,\[Rho],\[Kappa]],\[Omega]},
AdaptativeIntegrate[Function[\[Omega],NormalHestonCallIntegrand[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[8],
20\[Lambda],3\[Lambda],10^(-10),1000,2\[Lambda],LegendreCoeffs[20]][[2]]]]


HestonNormalCallAux[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,T_]:=1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],NormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,1,10^(-10),1000,1,LegendreCoeffs[20]][[2]]]]


HestonNormalCallAux[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,T_]:=1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],NormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,1,10^(-10),1000,1,LegendreCoeffs[20]][[2]]]]


HestonNormalCall[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=Module[{\[Theta]v1,\[Kappa]1,V1,S01,k1,L},
L=Sqrt[1./V];\[Theta]v1=L^2 \[Theta]v;\[Kappa]1=L \[Kappa];V1=1.0;S01=L S0;k1=L k;
HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1,V1,S01,k1,T]/L
]


HestonNormalCall[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_List,T_]:=Module[{\[Theta]v1,\[Kappa]1,V1,S01,k1,L},
L=Sqrt[1./V];\[Theta]v1=L^2 \[Theta]v;\[Kappa]1=L \[Kappa];V1=1.0;S01=L S0;k1=L k;
(HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1,V1,S01,#,T]/L)&  /@ k1
]


HestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,\[Theta]v2a,\[Kappa]2a,V2a,S0a,ka,L},
L=Sqrt[1./(V1+V2)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;V1a=L^2 V1;V2a=L^2 V2;S0a=L S0;ka=L k;
HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,S0,ka,T]/L
]


HestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_List,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,\[Theta]v2a,\[Kappa]2a,V2a,S0a,ka,L},
L=Sqrt[1./(V1+V2)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;V1a=L^2 V1;V2a=L^2 V2;S0a=L S0;ka=L k;
(HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,S0,#,T]/L)& /@ ka
]


HestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,\[Theta]v2a,\[Kappa]2a,V2a,\[Theta]v3a,\[Kappa]3a,V3a,S0a,ka,L},
L=Sqrt[1./(V1+V2+V3)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Theta]v3a=L^2 \[Theta]v3;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;\[Kappa]3a=L \[Kappa]3;V1a=L^2 V1;V2a=L^2 V2;V3a=L^2 V3;S0a=L S0;ka=L k;
HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,\[Rho]3,\[Lambda]v3,\[Theta]v3a,\[Kappa]3a,V3a,S0,ka,T]/L
]


HestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_List,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,\[Theta]v2a,\[Kappa]2a,V2a,\[Theta]v3a,\[Kappa]3a,V3a,S0a,ka,L},
L=Sqrt[1./(V1+V2+V3)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Theta]v3a=L^2 \[Theta]v3;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;\[Kappa]3a=L \[Kappa]3;V1a=L^2 V1;V2a=L^2 V2;V3a=L^2 V3;S0a=L S0;ka=L k;
(HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,\[Rho]3,\[Lambda]v3,\[Theta]v3a,\[Kappa]3a,V3a,S0,#,T]/L)& /@ ka
]


HestonNormalCallTrace[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=Module[{\[Theta]va,\[Kappa]a,Va,S0a,ka,L},
L=Sqrt[1./V];\[Theta]va=L^2 \[Theta]v;\[Kappa]a=L \[Kappa];Va=L^2 V;S0a=L S0;ka=L k;Print["L=",L," \[Kappa]a=",\[Kappa]a," S0a=",S0a," ka=",ka];
HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]va,\[Kappa]a,Va,S0a,ka,T]/L
]


HestonNormalCallTrace[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_List,T_]:=Module[{\[Theta]va,\[Kappa]a,Va,S0a,ka,L},
L=Sqrt[1./V];\[Theta]va=L^2 \[Theta]v;\[Kappa]a=L \[Kappa];Va=L^2 V;S0a=L S0;ka=L k;Print["L=",L," \[Kappa]a=",\[Kappa]a," S0a=",S0a," ka=",ka];
(HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]va,\[Kappa]a,Va,S0a,#,T]/L)& /@ ka
]


HestonNormalCallTrace[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,S0a,ka,\[Theta]v2a,\[Kappa]2a,V2a,L},
L=Sqrt[1./(V1+V2)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;V1a=L^2 V1;V2a=L^2 V2;S0a=L S0;ka=L k;Print["L=",L," V1a=",V1a," \[Kappa]a1=",\[Kappa]1a," V2a=",V2a," \[Kappa]a2=",\[Kappa]2a," S0a=",S0a," ka=",ka];
HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,S0a,ka,T]/L
]


HestonNormalCallTrace[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,S0a,ka,\[Theta]v2a,\[Kappa]2a,V2a,L},
L=Sqrt[1./(V1+V2)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;V1a=L^2 V1;V2a=L^2 V2;S0a=L S0;ka=L k;Print["L=",L," V1a=",V1a," \[Kappa]a1=",\[Kappa]1a," V2a=",V2a," \[Kappa]a2=",\[Kappa]2a," S0a=",S0a," ka=",ka];
(HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,S0a,#,T]/L)& /@ ka
]


HestonNormalCallTrace[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,\[Theta]v3a,\[Kappa]3a,V3a,S0a,ka,\[Theta]v2a,\[Kappa]2a,V2a,L},
L=Sqrt[1./(V1+V2+V3)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Theta]v3a=L^2 \[Theta]v3;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;\[Kappa]3a=L \[Kappa]3;V1a=L^2 V1;V2a=L^2 V2;V3a=L^2 V3;S0a=L S0;ka=L k;Print["L=",L," V1a=",V1a," \[Kappa]a1=",\[Kappa]1a," V2a=",V2a," \[Kappa]a2=",\[Kappa]2a," V3a=",V3a," \[Kappa]a3=",\[Kappa]3a," S0a=",S0a," ka=",ka];
HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,S0a,ka,T]/L
]


HestonNormalCallTrace[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,\[Theta]v3a,\[Kappa]3a,V3a,S0a,ka,\[Theta]v2a,\[Kappa]2a,V2a,L},
L=Sqrt[1./(V1+V2+V3)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Theta]v3a=L^2 \[Theta]v3;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;\[Kappa]3a=L \[Kappa]3;V1a=L^2 V1;V2a=L^2 V2;V3a=L^2 V3;S0a=L S0;ka=L k;Print["L=",L," V1a=",V1a," \[Kappa]a1=",\[Kappa]1a," V2a=",V2a," \[Kappa]a2=",\[Kappa]2a," V3a=",V3a," \[Kappa]a3=",\[Kappa]3a," S0a=",S0a," ka=",ka];
(HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,S0a,#,T]/L)& /@ ka
]


ThInterpolator[x1_,y1_,x2_,y2_,x_]:=Module[{a},
a=ArcTanh[1-y2/y1]/(x2-x1);
y1 (1-Tanh[a (x-y1)])]


LinInterpolator[x1_,y1_,x2_,y2_,x_]:=Module[{a},
a=(y2-y1)/(x2-x1);
y2+a (x-x2)]


QuadInterpolator[x1_,y1_,x2_,y2_,x3_,y3_,x_]:=Module[{a,b},
a=-((x2 y1-x3 y1-x1 y2+x3 y2+x1 y3-x2 y3)/((x1-x2) (x1-x3) (-x2+x3)));
b=-((-2 x1 x2 y1+x2^2 y1+2 x1 x3 y1-x3^2 y1+x1^2 y2-2 x1 x3 y2+x3^2 y2-x1^2 y3+2 x1 x2 y3-x2^2 y3)/((x2-x3) (x1^2-x1 x2-x1 x3+x2 x3)));
a (x-x1)^2+b (x-x1)+y1]


PowerInterpolator[x1_,y1_,x2_,y2_,x3_,y3_,x_]:=Module[{a,b},
b=Log[(y3-y1)/(y2-y1)]/Log[(x3-x1)/(x2-x1)];
a=(y3-y1)/(x3-x1)^b;
y1+a (x-x1)^b
]



(* interpolateur qui interpole une variable >0 par exemple la vol implicite en fonction de la vol de vol *)


SmartInterpolator[x1_,y1_,x2_,y2_,x3_,y3_,x_]:=Module[{a1,a2},
a1=(y2-y1)/(x2-x1);a2=(y3-y2)/(x3-x2);
Which[
a1>0&&a2<0,LinInterpolator[x1,y1,x3,y3,x],
a1>0&&a2>=0,PowerInterpolator[x1,y1,x2,y2,x3,y3,x],
a1<0&&a2>0,LinInterpolator[x1,y1,x3,y3,x],
a1<0&&a2<=0&&a2>a1, PowerInterpolator[x1,y1,x2,y2,x3,y3,x],
a1<0&&a2<=0&&a2<=a1,ThInterpolator[x1,y1,x3,y3,x]
]]



TransHestonNormalCall[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_,LimitGindinkin_]:=Module[{\[Theta]v1,\[Kappa]1,V1,S01,k1,L,\[Kappa]1Limit,\[Kappa]1test1,\[Kappa]1test2,vol1,vol2,vol},
L=Sqrt[1./V];\[Theta]v1=L^2 \[Theta]v;\[Kappa]1=L \[Kappa];V1=1.0;S01=L S0;k1=L k;
\[Kappa]1Limit=LimitGindinkin Sqrt[2 \[Lambda]v \[Theta]v1];
If[\[Kappa]1<0.9 \[Kappa]1Limit,
HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1,V1,S01,k1,T]/L,
\[Kappa]1test1=0.8 \[Kappa]1Limit;
\[Kappa]1test2=0.9 \[Kappa]1Limit;
vol1=NormalImplicitVol[S01,k1,T,HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1test1,V1,S01,k1,T]];
vol2=NormalImplicitVol[S01,k1,T,HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1test2,V1,S01,k1,T]];
If[vol2<vol1,
vol=ThInterpolator[\[Kappa]1test1,vol1,\[Kappa]1test2,vol2,\[Kappa]1],
vol=LinInterpolator[\[Kappa]1test1,vol1,\[Kappa]1test2,vol2,\[Kappa]1]
];
NormalCall[S01,vol,k1,T]/L
]
]


TransHestonNormalCall[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_,LimitGindinkin_,order_]:=Module[{\[Theta]v1,\[Kappa]1,V1,S01,k1,L,\[Kappa]1Limit,\[Kappa]1test1,\[Kappa]1test2,\[Kappa]1test3,vol1,vol2,vol3,vol},
L=Sqrt[1./V];\[Theta]v1=L^2 \[Theta]v;\[Kappa]1=L \[Kappa];V1=1.0;S01=L S0;k1=L k;
\[Kappa]1Limit=LimitGindinkin Sqrt[2 \[Lambda]v \[Theta]v1];
Print["LimitGindinkin=",\[Kappa]1Limit," \[Kappa]1=",\[Kappa]1];
If[\[Kappa]1<0.9 \[Kappa]1Limit,
HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1,V1,S01,k1,T]/L,
If[order==1,
\[Kappa]1test1=0.8 \[Kappa]1Limit;
\[Kappa]1test2=0.9 \[Kappa]1Limit;
vol1=NormalImplicitVol[S01,k1,T,HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1test1,V1,S01,k1,T]];
vol2=NormalImplicitVol[S01,k1,T,HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1test2,V1,S01,k1,T]];
If[vol2<vol1,
vol=ThInterpolator[\[Kappa]1test1,vol1,\[Kappa]1test2,vol2,\[Kappa]1],
vol=LinInterpolator[\[Kappa]1test1,vol1,\[Kappa]1test2,vol2,\[Kappa]1]
]
];
If[order==2,
\[Kappa]1test1=0.8 \[Kappa]1Limit;
\[Kappa]1test2=0.85 \[Kappa]1Limit;
\[Kappa]1test3=0.9 \[Kappa]1Limit;
vol1=NormalImplicitVol[S01,k1,T,HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1test1,V1,S01,k1,T]];
vol2=NormalImplicitVol[S01,k1,T,HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1test2,V1,S01,k1,T]];
vol3=NormalImplicitVol[S01,k1,T,HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1test3,V1,S01,k1,T]];
Print["\[Kappa]1test1=",\[Kappa]1test1," \[Kappa]1test2=",\[Kappa]1test2," \[Kappa]1test3=",\[Kappa]1test3," vol1=",vol1," vol2=",vol2," vol3=",vol3];
vol=SmartInterpolator[\[Kappa]1test1,vol1,\[Kappa]1test2,vol2,\[Kappa]1test3,vol3,\[Kappa]1];
Print["vol=",vol]
];
NormalCall[S01,vol,k1,T]/L
]]


TransHestonNormalCall[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_List,T_,LimitGindinkin_]:=Module[{\[Theta]v1,\[Kappa]1,V1,S01,k1,L,\[Kappa]1Limit,\[Kappa]1test1,\[Kappa]1test2,vol1,vol2,vol},
L=Sqrt[1./V];\[Theta]v1=L^2 \[Theta]v;\[Kappa]1=L \[Kappa];V1=1.0;S01=L S0;k1=L k;
\[Kappa]1Limit=LimitGindinkin Sqrt[2 \[Lambda]v \[Theta]v1];
Table[
If[\[Kappa]1<0.9 \[Kappa]1Limit,
HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1,V1,S01,k1[[i]],T]/L,
\[Kappa]1test1=0.8 \[Kappa]1Limit;
\[Kappa]1test2=0.9 \[Kappa]1Limit;
vol1=NormalImplicitVol[S01,k1[[i]],T,HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1test1,V1,S01,k1[[i]],T]];
vol2=NormalImplicitVol[S01,k1[[i]],T,HestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1test2,V1,S01,k1[[i]],T]];
If[vol2<vol1,
vol=ThInterpolator[\[Kappa]1test1,vol1,\[Kappa]1test2,vol2,\[Kappa]1],
vol=LinInterpolator[\[Kappa]1test1,vol1,\[Kappa]1test2,vol2,\[Kappa]1]
];
NormalCall[S01,vol,k1[[i]],T]/L
],{i,1,Length[k]}]
]


TransHestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,\[Theta]v2a,\[Kappa]2a,V2a,S0a,ka,L},
L=Sqrt[1./(V1+V2)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;V1a=L^2 V1;V2a=L^2 V2;S0a=L S0;ka=L k;
HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,S0,ka,T]/L
]


TransHestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_List,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,\[Theta]v2a,\[Kappa]2a,V2a,S0a,ka,L},
L=Sqrt[1./(V1+V2)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;V1a=L^2 V1;V2a=L^2 V2;S0a=L S0;ka=L k;
(HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,S0,#,T]/L)& /@ ka
]


TransHestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,\[Theta]v2a,\[Kappa]2a,V2a,\[Theta]v3a,\[Kappa]3a,V3a,S0a,ka,L},
L=Sqrt[1./(V1+V2+V3)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Theta]v3a=L^2 \[Theta]v3;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;\[Kappa]3a=L \[Kappa]3;V1a=L^2 V1;V2a=L^2 V2;V3a=L^2 V3;S0a=L S0;ka=L k;
HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,\[Rho]3,\[Lambda]v3,\[Theta]v3a,\[Kappa]3a,V3a,S0,ka,T]/L
]


TransHestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_List,T_]:=Module[{\[Theta]v1a,\[Kappa]1a,V1a,\[Theta]v2a,\[Kappa]2a,V2a,\[Theta]v3a,\[Kappa]3a,V3a,S0a,ka,L},
L=Sqrt[1./(V1+V2+V3)];\[Theta]v1a=L^2 \[Theta]v1;\[Theta]v2a=L^2 \[Theta]v2;\[Theta]v3a=L^2 \[Theta]v3;\[Kappa]1a=L \[Kappa]1;\[Kappa]2a=L \[Kappa]2;\[Kappa]3a=L \[Kappa]3;V1a=L^2 V1;V2a=L^2 V2;V3a=L^2 V3;S0a=L S0;ka=L k;
(HestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1a,\[Kappa]1a,V1a,\[Rho]2,\[Lambda]v2,\[Theta]v2a,\[Kappa]2a,V2a,\[Rho]3,\[Lambda]v3,\[Theta]v3a,\[Kappa]3a,V3a,S0,#,T]/L)& /@ ka
]


NormalPowerCallPayOffFourierTransform[k_,n_,\[Omega]_]:=If[k!=0,-((\[ImaginaryI] (\[ExponentialE]^(\[ImaginaryI] k^(1/n) \[Omega]) k-(-\[ImaginaryI] \[Omega])^-n Gamma[1+n,-\[ImaginaryI] k^(1/n) \[Omega]]))/\[Omega]),(-\[ImaginaryI] \[Omega])^(-1-n) Gamma[1+n]]


HestonPowerNormalCallN[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=n+0.5,\[Omega]},
NIntegrate[\[ExponentialE]^(-\[ImaginaryI] (\[Omega] +\[Lambda] \[ImaginaryI])S0) NormalHestonFondamentalTransform[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Omega]+\[ImaginaryI] \[Lambda],T]NormalPowerCallPayOffFourierTransform[k,n,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


HestonPowerNormalPutN[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=-0.5,\[Omega]},
NIntegrate[\[ExponentialE]^(-\[ImaginaryI] (\[Omega] +\[Lambda] \[ImaginaryI])S0) NormalHestonFondamentalTransform[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Omega]+\[ImaginaryI] \[Lambda],T]NormalPowerCallPayOffFourierTransform[k,n,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


HestonPowerNormalCallAux[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=n+0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],\[ExponentialE]^(-\[ImaginaryI] (\[Omega] +\[Lambda] \[ImaginaryI])S0) NormalHestonFondamentalTransform[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Omega] +\[Lambda] \[ImaginaryI],T]NormalPowerCallPayOffFourierTransform[k,n,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[20],
10/T,5/T,10^(-10),1000,1/T,LegendreCoeffs[60]][[2]]]]


HestonPowerNormalPutAux[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=-0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],\[ExponentialE]^(-\[ImaginaryI] (\[Omega] +\[Lambda] \[ImaginaryI])S0) NormalHestonFondamentalTransform[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Omega] +\[Lambda] \[ImaginaryI],T]NormalPowerCallPayOffFourierTransform[k,n,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[20],
10/T,5/T,10^(-10),1000,1/T,LegendreCoeffs[60]][[2]]]]


HestonPowerNormalCall[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=Module[{\[Theta]v1,\[Kappa]1,V1,S01,k1,L,prix},
L=Sqrt[1./V];\[Theta]v1=L^2 \[Theta]v;\[Kappa]1=L \[Kappa];V1=1.0;S01=L S0;k1=L^n k;
prix=HestonPowerNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1,V1,S01,k1,n,T];
L^-n*prix]


HestonPowerNormalPut[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=Module[{\[Theta]v1,\[Kappa]1,V1,S01,k1,L,prix},
L=Sqrt[1./V];\[Theta]v1=L^2 \[Theta]v;\[Kappa]1=L \[Kappa];V1=1.0;S01=L S0;k1=L^n k;
prix=HestonPowerNormalPutAux[\[Rho],\[Lambda]v,\[Theta]v1,\[Kappa]1,V1,S01,k1,n,T];
L^-n*prix]


HestonNormalVariance[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,T_]:=Module[{call,put},
call=HestonPowerNormalCall[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,S0^2,2,T];
put=HestonPowerNormalPut[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,S0^2,2,T];
call-put]


HestonNormalVarianceTrace[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,T_]:=Module[{call,put},
call=HestonPowerNormalCall[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,S0^2,2,T];
put=HestonPowerNormalPut[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,S0^2,2,T];
Print["T=",T," call=",call," put=",put];
call-put]


NormalHestonFondamentalTransformLog[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,\[Omega]_,\[Tau]_]:=Module[{\[Zeta],\[Psi]p ,\[Psi]m,A,B,arg\[Zeta]},
\[Zeta]=Sqrt[(\[Lambda]v+\[Rho] \[Kappa] \[ImaginaryI] \[Omega])^2+\[Kappa]^2 ( \[Omega]^2)];
\[Psi]p =-(\[Lambda]v+\[Rho] \[Kappa]  \[ImaginaryI] \[Omega])+\[Zeta];
\[Psi]m =(\[Lambda]v+\[Rho] \[Kappa]  \[ImaginaryI] \[Omega])+\[Zeta];
A=-( \[Theta]v \[Lambda]v (\[Tau] \[Psi]p+2 Log[(\[Psi]m+\[ExponentialE]^(-\[Zeta] \[Tau]) \[Psi]p)/(2\[Zeta])])/ (\[Kappa]^2)   );
B= -( \[Omega]^2)(1-\[ExponentialE]^(-\[Zeta]  \[Tau]))/(\[Psi]m+\[Psi]p \[ExponentialE]^(-\[Zeta]  \[Tau]));
A+B V]


D2=D[NormalHestonFondamentalTransformLog[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Omega],\[Tau]],{\[Omega],2}];
D2LogNormalHestonFondamentalTransform=Function[{\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Tau]},Evaluate[1/\[ImaginaryI]^2 D2/. \[Omega]->0]];


D2LogNormalHestonFondamentalTransform=Function[{\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Tau]},Evaluate[Simplify[D2LogNormalHestonFondamentalTransform[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Tau]],\[Lambda]v>0]]];


LogNormalHestonFondamentalTransform[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,\[Omega]_,\[Tau]_]:=Module[{\[Zeta],\[Psi]p ,\[Psi]m,A,B,arg\[Zeta],\[Eta]},
\[Eta]=\[Lambda]v+\[Rho] \[Kappa] \[ImaginaryI] \[Omega];
arg\[Zeta]=\[Eta]^2+\[Kappa]^2 (\[Omega]^2-\[ImaginaryI] \[Omega]);
\[Zeta]=Sqrt[arg\[Zeta]];
\[Psi]p =-\[Eta]+\[Zeta];
\[Psi]m =\[Eta]+\[Zeta];
A=-( \[Theta]v \[Lambda]v (\[Tau] \[Psi]p+2 Log[(\[Psi]m+\[ExponentialE]^(-\[Zeta] \[Tau]) \[Psi]p)/(2\[Zeta])])/ (\[Kappa]^2)   );
B= -(\[Omega]^2-\[ImaginaryI] \[Omega])(1-\[ExponentialE]^(-\[Zeta]  \[Tau]))/(\[Psi]m+\[Psi]p \[ExponentialE]^(-\[Zeta]  \[Tau]));
If[Re[A+B V]<-100,0,
\[ExponentialE]^(A+B V)]]


LogNormalHestonFondamentalTransform[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Omega]_,\[Tau]_]:=
Module[{\[Zeta]1,\[Psi]p1 ,\[Psi]m1,B1,arg\[Zeta]1,\[Eta]1,\[Zeta]2,\[Psi]p2 ,\[Psi]m2,A2,B2,arg\[Zeta]2,\[Eta]2,A},
\[Eta]1=\[Lambda]v1+\[Rho]1 \[Kappa]1 \[ImaginaryI] \[Omega];
arg\[Zeta]1=\[Eta]1^2+\[Kappa]1^2 (\[Omega]^2-\[ImaginaryI] \[Omega]);
\[Zeta]1=Sqrt[arg\[Zeta]1];
\[Psi]p1 =-\[Eta]1+\[Zeta]1;
\[Psi]m1 =\[Eta]1+\[Zeta]1;
B1= -(\[Omega]^2-\[ImaginaryI] \[Omega])(1-\[ExponentialE]^(-\[Zeta]1  \[Tau]))/(\[Psi]m1+\[Psi]p1 \[ExponentialE]^(-\[Zeta]1  \[Tau]));
\[Eta]2=\[Lambda]v2+\[Rho]2 \[Kappa]2 \[ImaginaryI] \[Omega];
arg\[Zeta]2=\[Eta]2^2+\[Kappa]2^2 (\[Omega]^2-\[ImaginaryI] \[Omega]);
\[Zeta]2=Sqrt[arg\[Zeta]2];
\[Psi]p2 =-\[Eta]2+\[Zeta]2;
\[Psi]m2 =\[Eta]2+\[Zeta]2;
B2= -(\[Omega]^2-\[ImaginaryI] \[Omega])(1-\[ExponentialE]^(-\[Zeta]2  \[Tau]))/(\[Psi]m2+\[Psi]p2 \[ExponentialE]^(-\[Zeta]2  \[Tau]));
A=-( \[Theta]v1 \[Lambda]v1 (\[Tau] \[Psi]p1+2 Log[(\[Psi]m1+\[ExponentialE]^(-\[Zeta]1 \[Tau]) \[Psi]p1)/(2\[Zeta]1)])/ (\[Kappa]1^2)   )- \[Theta]v2 \[Lambda]v2 (\[Tau] \[Psi]p2+2 Log[(\[Psi]m2+\[ExponentialE]^(-\[Zeta]2 \[Tau]) \[Psi]p2)/(2\[Zeta]2)])/ (\[Kappa]2^2)   ;
If[Re[A+B1 V1+B2 V2]<-100,0,
\[ExponentialE]^(A+B1 V1+B2 V2)]
]


LogNormalHestonFondamentalTransform[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,\[Omega]_,\[Tau]_]:=
Module[{\[Zeta]1,\[Psi]p1 ,\[Psi]m1,arg\[Zeta]1,\[Eta]1,\[Zeta]2,\[Psi]p2 ,\[Psi]m2,arg\[Zeta]2,\[Eta]2,\[Zeta]3,\[Psi]p3 ,\[Psi]m3,A3,arg\[Zeta]3,\[Eta]3,B1,B2,B3,A},
\[Eta]1=\[Lambda]v1+\[Rho]1 \[Kappa]1 \[ImaginaryI] \[Omega];
arg\[Zeta]1=(\[Lambda]v1+\[Rho]1 \[Kappa]1 \[ImaginaryI] \[Omega])^2+\[Kappa]1^2 (\[Omega]^2-\[ImaginaryI] \[Omega]);
\[Zeta]1=Sqrt[arg\[Zeta]1];
\[Psi]p1 =-\[Eta]1+\[Zeta]1;
\[Psi]m1 =\[Eta]1+\[Zeta]1;
B1= -(\[Omega]^2-\[ImaginaryI] \[Omega])(1-\[ExponentialE]^(-\[Zeta]1  \[Tau]))/(\[Psi]m1+\[Psi]p1 \[ExponentialE]^(-\[Zeta]1  \[Tau]));
\[Eta]2=\[Lambda]v2+\[Rho]2 \[Kappa]2 \[ImaginaryI] \[Omega];
arg\[Zeta]2=\[Eta]2^2+\[Kappa]2^2 (\[Omega]^2-\[ImaginaryI] \[Omega]);
\[Zeta]2=Sqrt[arg\[Zeta]2];
\[Psi]p2 =-\[Eta]2+\[Zeta]2;
\[Psi]m2 =\[Eta]2+\[Zeta]2;
B2= -(\[Omega]^2-\[ImaginaryI] \[Omega])(1-\[ExponentialE]^(-\[Zeta]2  \[Tau]))/(\[Psi]m2+\[Psi]p2 \[ExponentialE]^(-\[Zeta]2  \[Tau]));
\[Eta]3=\[Lambda]v3+\[Rho]3 \[Kappa]3 \[ImaginaryI] \[Omega];
arg\[Zeta]3=\[Eta]3^2+\[Kappa]3^2 (\[Omega]^2-\[ImaginaryI] \[Omega]);
\[Zeta]3=Sqrt[arg\[Zeta]3];
\[Psi]p3 =-\[Eta]3+\[Zeta]3;
\[Psi]m3 =\[Eta]3+\[Zeta]3;
B3= -(\[Omega]^2-\[ImaginaryI] \[Omega])(1-\[ExponentialE]^(-\[Zeta]3  \[Tau]))/(\[Psi]m3+\[Psi]p3 \[ExponentialE]^(-\[Zeta]3  \[Tau]));
A=-( \[Theta]v1 \[Lambda]v1 (\[Tau] \[Psi]p1+2 Log[(\[Psi]m1+\[ExponentialE]^(-\[Zeta]1 \[Tau]) \[Psi]p1)/(2\[Zeta]1)])/ (\[Kappa]1^2)   )- \[Theta]v2 \[Lambda]v2 (\[Tau] \[Psi]p2+2 Log[(\[Psi]m2+\[ExponentialE]^(-\[Zeta]2 \[Tau]) \[Psi]p2)/(2\[Zeta]2)])/ (\[Kappa]2^2)   - \[Theta]v3 \[Lambda]v3 (\[Tau] \[Psi]p3+2 Log[(\[Psi]m3+\[ExponentialE]^(-\[Zeta]3 \[Tau]) \[Psi]p3)/(2\[Zeta]3)])/ (\[Kappa]3^2)   ;
If[Re[A+B1 V1+B2 V2+B3 V3]<-100,0,
\[ExponentialE]^(A+B1 V1+B2 V2+B3 V3)]
]


LogNormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,S0_,K_,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  Log[S0]) LogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Omega],T]LogNormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]]]


LogNormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,K_,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  Log[S0])  LogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Omega],T]LogNormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]]]


LogNormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,K_,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  Log[S0])  LogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Omega],T]LogNormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]]]


LogNormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,S0_,K_List,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  Log[S0])  LogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Omega],T]Table[LogNormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]],{i,1,Length[K]}]]


LogNormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,K_List,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  Log[S0])  LogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Omega],T]Table[LogNormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]],{i,1,Length[K]}]]


LogNormalHestonCallIntegrand[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,K_List,\[Alpha]_,a_,T_,\[Omega]_]:=Re[\[ExponentialE]^(-\[ImaginaryI] \[Omega]  Log[S0])  LogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Omega],T]Table[LogNormalCallPayOffFourierTransform[K,\[Alpha],a,\[Omega]],{i,1,Length[K]}]]


LogHestonNormalCallN[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=S0-1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
NIntegrate[LogNormalHestonCallIntegrand[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


LogHestonNormalCallN[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,T_]:=S0-1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
NIntegrate[LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


LogHestonNormalCallN[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,T_]:=S0-1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
NIntegrate[LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


LogHestonNormalCallAux[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=S0-1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],LogNormalHestonCallIntegrand[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,2,10^(-10),1000,2,LegendreCoeffs[20]][[2]]]]


LogHestonNormalCallAux[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,T_]:=S0-1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,1,10^(-10),1000,1,LegendreCoeffs[20]][[2]]]]


LogHestonNormalCallAux[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,T_]:=S0-1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,1,10^(-10),1000,1,LegendreCoeffs[20]][[2]]]]


LogHestonNormalCall[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=Module[{},
S0 LogHestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,1,k/S0,T]
]


LogHestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,T_]:=Module[{},
S0 LogHestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,1,k/S0,T]
]


LogHestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,T_]:=Module[{},
S0 LogHestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,1,k/S0,T]
]


LogHestonNormalDensit\[EAcute][\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=Module[{shift=S0/1000},Max[0,(LogHestonNormalCall[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k+shift,T]+LogHestonNormalCall[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k-shift,T]-2LogHestonNormalCall[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,T])/(shift^2)]]


LogHestonNormalDensit\[EAcute][\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,T_]:=Module[{shift=S0/1000},Max[0,(LogHestonNormalCall[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k+shift,T]+LogHestonNormalCall[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k-shift,T]-2LogHestonNormalCall[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k,T])/(shift^2)]]


LogHestonNormalDensit\[EAcute][\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,T_]:=Module[{shift=S0/1000},Max[0,(LogHestonNormalCall[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k+shift,T]+LogHestonNormalCall[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k-shift,T]-2LogHestonNormalCall[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k,T])/(shift^2)]]


CoeffBasedVariance[density_,coeffs_]:=Module[{n=Length[coeffs],densitytable,Expectation=0,variance=0,normalisation=0,i},
densitytable=Table[density[coeffs[[i,1]]],{i,1,n}];
Do[normalisation+= densitytable[[i]] coeffs[[i,2]],{i,1,n}];
Do[Expectation+=coeffs[[i,1]] densitytable[[i]] coeffs[[i,2]],{i,1,n}];Expectation/=normalisation;
Do[variance+=(coeffs[[i,1]]-Expectation)^2 densitytable[[i]] coeffs[[i,2]],{i,1,n}];
Print["normalisation=",normalisation," Expectation=",Expectation," variance=",variance];
variance/=normalisation;
variance]


CoeffBasedVariance[density_,coeffs_,Expectation_]:=Module[{n=Length[coeffs],densitytable,variance=0,i},
densitytable=Table[density[coeffs[[i,1]]],{i,1,n}];
Do[variance+=(coeffs[[i,1]]-Expectation)^2 densitytable[[i]] coeffs[[i,2]],{i,1,n}];
variance]


LogHestonNormalVariance2[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=CoeffBasedIntegrate[((#-S0)^2 LogHestonNormalDensit\[EAcute][\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,#,T])&,LegendreCoeffs[20,S0/5,6S0]]


LogHestonNormalVariance3[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=CoeffBasedVariance[(LogHestonNormalDensit\[EAcute][\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,#,T])&,LegendreCoeffs[20,S0/5,6S0]]


LogHestonNormalEsperance[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=CoeffBasedIntegrate[((#)LogHestonNormalDensit\[EAcute][\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,#,T])&,LegendreCoeffs[20,S0/5,6S0]]


LogHestonNormalNormalisation[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=CoeffBasedIntegrate[(LogHestonNormalDensit\[EAcute][\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,#,T])&,LegendreCoeffs[20,S0/5,6S0]]


LogHestonNormalVarianceProxy[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,T_]:=Module[{Vlog},
Vlog=\[Theta]v T+(V -\[Theta]v)((1-\[ExponentialE]^(-\[Lambda]v T))/\[Lambda]v);
S0^2 \[ExponentialE]^Vlog (\[ExponentialE]^Vlog-1)]


LogHestonNormalVarianceProxy[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,T_]:=Module[{Vlog1,Vlog2},
Vlog1=\[Theta]v1 T+(V1 -\[Theta]v1)((1-\[ExponentialE]^(-\[Lambda]v1 T))/\[Lambda]v1);
Vlog2=\[Theta]v2 T+(V2 -\[Theta]v2)((1-\[ExponentialE]^(-\[Lambda]v2 T))/\[Lambda]v2);
S0^2 \[ExponentialE]^(Vlog1+Vlog2) (\[ExponentialE]^(Vlog1+Vlog2)-1)
]  


LogHestonNormalVarianceProxy[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,T_]:=Module[{Vlog1,Vlog2,Vlog3},
Vlog1=\[Theta]v1 T+(V1 -\[Theta]v1)((1-\[ExponentialE]^(-\[Lambda]v1 T))/\[Lambda]v1);
Vlog2=\[Theta]v2 T+(V2 -\[Theta]v2)((1-\[ExponentialE]^(-\[Lambda]v2 T))/\[Lambda]v2);
Vlog3=\[Theta]v3 T+(V3 -\[Theta]v3)((1-\[ExponentialE]^(-\[Lambda]v3 T))/\[Lambda]v3);
S0^2 \[ExponentialE]^(Vlog1+Vlog2+Vlog3) (\[ExponentialE]^(Vlog1+Vlog2+Vlog3)-1)
]  


LogHestonNormalVariance2[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_,n1_,n2_]:=CoeffBasedVariance[(LogHestonNormalDensit\[EAcute][\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,#,T])&,LegendreCoeffs[60,S0/n1,n2 S0]]


LogHestonNormalCallAux[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=S0-1/\[Pi] Re[Module[{\[Lambda]=0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],LogNormalHestonCallIntegrand[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[12],
10,2,10^(-10),1000,2,LegendreCoeffs[30]][[2]]]]


ShiftedLogHestonNormalCallAux[\[Beta]_,\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=Module[{},
LogHestonNormalCall[\[Rho],\[Lambda]v,\[Beta]^2 \[Theta]v,Abs[\[Beta]] \[Kappa],\[Beta]^2 V,S0+(1-\[Beta] )/\[Beta] S0,k+(1-\[Beta] )/\[Beta] S0,T]] /; \[Beta]>=0


ShiftedLogHestonNormalCallAux[\[Beta]_,\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=Module[{},
LogHestonNormalCall[-\[Rho],\[Lambda]v,\[Beta]^2 \[Theta]v,Abs[\[Beta]] \[Kappa],\[Beta]^2 V,-S0-(1-\[Beta] )/\[Beta] S0,-k-(1-\[Beta] )/\[Beta] S0,T]] /; \[Beta]<0


ShiftedLogHestonNormalCall1[\[Beta]_,\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=Module[{\[Beta]L=0.02},
If[(\[Beta]<\[Beta]L)&& (\[Beta]>=0),
(\[Beta]L-\[Beta])/\[Beta]L HestonNormalCall[\[Rho],\[Lambda]v,S0^2 \[Theta]v,S0 \[Kappa],S0^2 V,S0,k,T]+\[Beta]/\[Beta]L ShiftedLogHestonNormalCallAux[\[Beta]L,\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,T],
If[(\[Beta]>-\[Beta]L)&& (\[Beta]<0),
(\[Beta]L-Abs[\[Beta]])/\[Beta]L HestonNormalCall[\[Rho],\[Lambda]v,S0^2 \[Theta]v,S0 \[Kappa],S0^2 V,S0,k,T]+Abs[\[Beta]]/\[Beta]L ShiftedLogHestonNormalCallAux[-\[Beta]L,\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,T],
ShiftedLogHestonNormalCallAux[\[Beta],\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,T]]]]


BetaPositifApprox[\[Beta]ini_,\[Beta]L_,force_]:=\[Beta]L \[ExponentialE]^(-force \[Beta]ini)+(1-\[Beta]L \[ExponentialE]^-force) \[Beta]ini


BetaNegatifApprox[\[Beta]ini_,\[Beta]L_,force_]:=-\[Beta]L \[ExponentialE]^(force \[Beta]ini)+(1-\[Beta]L \[ExponentialE]^-force) \[Beta]ini


InterpolDenfer[x_,m_,q_]:=Module[{y,z},
y=2 (1.0-x)^q-1;
z= ArcTanh[y];
1-(Tanh[m z]+1)/2]


ShiftedLogHestonNormalCallAux[\[Beta]_,\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=Module[{},
LogHestonNormalCall[\[Rho],\[Lambda]v,\[Beta]^2 \[Theta]v,Abs[\[Beta]] \[Kappa],\[Beta]^2 V,S0+(1-\[Beta] )/\[Beta] S0,k+(1-\[Beta] )/\[Beta] S0,T]] /; \[Beta]>=0


ShiftedLogHestonNormalCallAux[\[Beta]_,\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=Module[{},
LogHestonNormalCall[-\[Rho],\[Lambda]v,\[Beta]^2 \[Theta]v,Abs[\[Beta]] \[Kappa],\[Beta]^2 V,S0-(1-\[Beta] )/\[Beta] S0,k-(1-\[Beta] )/\[Beta] S0,T]] /; \[Beta]<0


ShiftedLogHestonNormalCall2[\[Beta]_,\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=Module[{\[Beta]L=0.02,\[Beta]eff,\[Alpha]N,\[Alpha]LN,force=1,m=2,q=3},
If[ (\[Beta]>=0),\[Alpha]LN=InterpolDenfer[\[Beta],m,q];\[Alpha]N=1-\[Alpha]LN;
\[Beta]eff=BetaPositifApprox[\[Beta],\[Beta]L,force];
(*Print["\[Beta]>0 : \[Alpha]LN=",\[Alpha]LN," \[Beta]eff=",\[Beta]eff," HestonNormalCall[\[Rho],\[Lambda]v,S0^2\[Theta]v,S0 \[Kappa],S0^2V,S0,k,T]=", HestonNormalCall[\[Rho],\[Lambda]v,S0^2\[Theta]v,S0 \[Kappa],S0^2V,S0,k,T],"  ShiftedLogHestonNormalCallAux[\[Beta]eff,\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,T]=", ShiftedLogHestonNormalCallAux[\[Beta]eff,\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,T]];*);
\[Alpha]N HestonNormalCall[\[Rho],\[Lambda]v,S0^2 \[Theta]v,S0 \[Kappa],S0^2 V,S0,k,T]+\[Alpha]LN ShiftedLogHestonNormalCallAux[\[Beta]eff,\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,T],
If[ (\[Beta]<0),\[Alpha]LN=InterpolDenfer[-\[Beta],m,q];\[Alpha]N=1-\[Alpha]LN;
\[Beta]eff=BetaNegatifApprox[\[Beta],\[Beta]L,force];
(* Print["\[Beta]<0 : \[Alpha]LN=",\[Alpha]LN," \[Beta]eff=",\[Beta]eff];*)
\[Alpha]N HestonNormalCall[\[Rho],\[Lambda]v,S0^2 \[Theta]v,S0 \[Kappa],S0^2 V,S0,k,T]+\[Alpha]LN ShiftedLogHestonNormalCallAux[\[Beta]eff,\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,T],
ShiftedLogHestonNormalCallAux[\[Beta],\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,T]]]]


PowerLogHestonNormalCallN[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=n+0.5,\[Omega]},
NIntegrate[LogNormalHestonCallIntegrand[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


PowerLogHestonNormalCallN[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=n+0.5,\[Omega]},
NIntegrate[LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


PowerLogHestonNormalCallN[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=n+0.5,\[Omega]},
NIntegrate[LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


PowerLogHestonNormalPutN[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=-0.5,\[Omega]},
NIntegrate[LogNormalHestonCallIntegrand[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


PowerLogHestonNormalPutN[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=-0.5,\[Omega]},
NIntegrate[LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


PowerLogHestonNormalPutN[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=-0.5,\[Omega]},
NIntegrate[LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]],
{\[Omega],0,Infinity},MaxRecursion->30]]]


LogHestonNormalVarianceN[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,T_]:=Module[{call,put},
call=PowerLogHestonNormalCallN[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,S0^2,2,T];
put=PowerLogHestonNormalPutN[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,S0^2,2,T];
call-put
]  


LogHestonNormalVarianceN[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,T_]:=Module[{call,put},
call=PowerLogHestonNormalCallN[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,S0^2,2,T];
put=PowerLogHestonNormalPutN[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,S0^2,2,T];
call-put
]  


LogHestonNormalVarianceN[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,T_]:=Module[{call,put},
call=PowerLogHestonNormalCallN[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,S0^2,2,T];
put=PowerLogHestonNormalPutN[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,S0^2,2,T];
call-put
]  


PowerLogHestonNormalCallAux[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=n+0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],LogNormalHestonCallIntegrand[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,1,10^(-10),1000,1,LegendreCoeffs[20]][[2]]]]


PowerLogHestonNormalCallAux[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=n+0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,1,10^(-10),1000,1,LegendreCoeffs[20]][[2]]]]


PowerLogHestonNormalCallAux[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=n+0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,1,10^(-10),1000,1,LegendreCoeffs[20]][[2]]]]


PowerLogHestonNormalPutAux[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=-0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],LogNormalHestonCallIntegrand[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,1,10^(-10),1000,1,LegendreCoeffs[20]][[2]]]]


PowerLogHestonNormalPutAux[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=-0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,1,10^(-10),1000,1,LegendreCoeffs[20]][[2]]]]


PowerLogHestonNormalPutAux[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,n_,T_]:=S0^n-1/\[Pi] Re[Module[{\[Lambda]=-0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],LogNormalHestonCallIntegrand[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,k,1,n,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[60],LegendreCoeffs[3],
10,1,10^(-10),1000,1,LegendreCoeffs[20]][[2]]]]


PowerLogHestonNormalCall[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=Module[{},
S0^n PowerLogHestonNormalCallAux[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,1,k/S0^n,n,T]
]


PowerLogHestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,n_,T_]:=Module[{},
S0^n PowerLogHestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,1,k/S0^n,n,T]
]


PowerLogHestonNormalCall[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,n_,T_]:=Module[{},
S0^n PowerLogHestonNormalCallAux[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,1,k/S0^n,n,T]
]


PowerLogHestonNormalPut[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,n_,T_]:=Module[{},
S0^n PowerLogHestonNormalPutAux[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,1,k/S0^n,n,T]
]


PowerLogHestonNormalPut[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,k_,n_,T_]:=Module[{},
S0^n PowerLogHestonNormalPutAux[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,1,k/S0^n,n,T]
]


PowerLogHestonNormalPut[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,k_,n_,T_]:=Module[{},
S0^n PowerLogHestonNormalPutAux[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,1,k/S0^n,n,T]
]


LogHestonNormalVariance[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,T_]:=Module[{call,put},
call=PowerLogHestonNormalCall[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,S0^2,2,T];
put=PowerLogHestonNormalPut[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,S0^2,2,T];
call-put
]  


LogHestonNormalVariance[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,T_]:=Module[{call,put},
call=PowerLogHestonNormalCall[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,S0^2,2,T];
put=PowerLogHestonNormalPut[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,S0^2,2,T];
call-put
]  


LogHestonNormalVariance[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,T_]:=Module[{call,put},
call=PowerLogHestonNormalCall[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,S0^2,2,T];
put=PowerLogHestonNormalPut[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,S0^2,2,T];
call-put
]  


LogHestonNormalVarianceTrace[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,T_]:=Module[{call,put},
call=PowerLogHestonNormalCall[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,S0^2,2,T];
put=PowerLogHestonNormalPut[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,S0^2,2,T];
Print["call=",call," put=",put];
call-put
]  


LogHestonNormalVarianceTrace[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,S0_,T_]:=Module[{call,put},
call=PowerLogHestonNormalCall[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,S0^2,2,T];
put=PowerLogHestonNormalPut[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,S0,S0^2,2,T];
Print["call=",call," put=",put];
call-put
]  


LogHestonNormalVarianceTrace[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,S0_,T_]:=Module[{call,put},
call=PowerLogHestonNormalCall[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,S0^2,2,T];
put=PowerLogHestonNormalPut[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,S0,S0^2,2,T];
Print["call=",call," put=",put];
call-put
]  


LogaritmOfNormalHestonFondamentalTransform[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,\[Omega]_,\[Tau]_]:=Module[{\[Zeta],\[Psi]p ,\[Psi]m,A,B,arg\[Zeta]},
\[Zeta]=Sqrt[(\[Lambda]v+\[Rho] \[Kappa] \[ImaginaryI] \[Omega])^2+\[Kappa]^2 ( \[Omega]^2)];
\[Psi]p =-(\[Lambda]v+\[Rho] \[Kappa]  \[ImaginaryI] \[Omega])+\[Zeta];
\[Psi]m =(\[Lambda]v+\[Rho] \[Kappa]  \[ImaginaryI] \[Omega])+\[Zeta];
A=-( \[Theta]v \[Lambda]v (\[Tau] \[Psi]p+2 Log[(\[Psi]m+\[ExponentialE]^(-\[Zeta] \[Tau]) \[Psi]p)/(2\[Zeta])])/ (\[Kappa]^2)   );
B= -( \[Omega]^2)(1-\[ExponentialE]^(-\[Zeta]  \[Tau]))/(\[Psi]m+\[Psi]p \[ExponentialE]^(-\[Zeta]  \[Tau]));
A+B V]


D2=D[LogaritmOfNormalHestonFondamentalTransform[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Omega],\[Tau]],{\[Omega],2}];
D2LogNormalHestonFondamentalTransform=Function[{\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Tau]},Evaluate[1/\[ImaginaryI]^2 D2/. \[Omega]->0]];


D2LogNormalHestonFondamentalTransform=Function[{\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Tau]},Evaluate[Simplify[D2LogNormalHestonFondamentalTransform[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,\[Tau]]]]];


LogBiSuperLogNormalHestonFondamentalTransform[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,\[Alpha]2_,\[Beta]2_,Z1_,Z2_,\[Tau]_]:=
Module[{\[Zeta]1,\[Psi]p1 ,\[Psi]m1,A1,\[Zeta]2,\[Psi]p2 ,\[Psi]m2,A2,\[Zeta]3,\[Psi]p3 ,\[Psi]m3,A3,c},
\[Zeta]1=Sqrt[(\[Lambda]v1+\[Rho]1 \[Kappa]1 \[ImaginaryI] Z1)^2+\[Kappa]1^2 ( Z1^2-\[ImaginaryI] Z1)];
\[Psi]p1 =-(\[Lambda]v1+\[Rho]1 \[Kappa]1 \[ImaginaryI] Z1)+\[Zeta]1;
\[Psi]m1 =(\[Lambda]v1+\[Rho]1 \[Kappa]1  \[ImaginaryI] Z1)+\[Zeta]1;
A1= -( Z1^2-\[ImaginaryI] Z1)(1-\[ExponentialE]^(-\[Zeta]1  \[Tau]))/(\[Psi]m1+\[Psi]p1 \[ExponentialE]^(-\[Zeta]1  \[Tau]));
\[Zeta]2=\[Sqrt]((\[Lambda]v2+\[Rho]2 \[Kappa]2 \[ImaginaryI] (Z1 \[Alpha]2+Z2 \[Beta]2))^2+\[Kappa]2^2 ( Z1 (-\[ImaginaryI]+Z1) \[Alpha]2^2+2 Z1 Z2 \[Alpha]2 \[Beta]2+Z2 (-\[ImaginaryI]+Z2) \[Beta]2^2));
\[Psi]p2 =-(\[Lambda]v2+\[Rho]2 \[Kappa]2  \[ImaginaryI] (Z1 \[Alpha]2+Z2 \[Beta]2))+\[Zeta]2;
\[Psi]m2 =(\[Lambda]v2+\[Rho]2 \[Kappa]2  \[ImaginaryI] (Z1 \[Alpha]2+Z2 \[Beta]2))+\[Zeta]2;
A2= -( Z1 (-\[ImaginaryI]+Z1) \[Alpha]2^2+2 Z1 Z2 \[Alpha]2 \[Beta]2+Z2 (-\[ImaginaryI]+Z2) \[Beta]2^2)(1-\[ExponentialE]^(-\[Zeta]2  \[Tau]))/(\[Psi]m2+\[Psi]p2 \[ExponentialE]^(-\[Zeta]2  \[Tau]));
\[Zeta]3=Sqrt[(\[Lambda]v3+\[Rho]3 \[Kappa]3 \[ImaginaryI] Z2)^2+\[Kappa]3^2 ( Z2^2-\[ImaginaryI] Z2)];
\[Psi]p3 =-(\[Lambda]v3+\[Rho]3 \[Kappa]3  \[ImaginaryI] Z2)+\[Zeta]3;
\[Psi]m3 =(\[Lambda]v3+\[Rho]3 \[Kappa]3  \[ImaginaryI] Z2)+\[Zeta]3;
A3= -( Z2^2-\[ImaginaryI] Z2)(1-\[ExponentialE]^(-\[Zeta]3  \[Tau]))/(\[Psi]m3+\[Psi]p3 \[ExponentialE]^(-\[Zeta]3  \[Tau]));

c=-( \[Theta]v1 \[Lambda]v1 (\[Tau] \[Psi]p1+2 Log[(\[Psi]m1+\[ExponentialE]^(-\[Zeta]1 \[Tau]) \[Psi]p1)/(2\[Zeta]1)])/ (\[Kappa]1^2)   )- \[Theta]v2 \[Lambda]v2 (\[Tau] \[Psi]p2+2 Log[(\[Psi]m2+\[ExponentialE]^(-\[Zeta]2 \[Tau]) \[Psi]p2)/(2\[Zeta]2)])/ (\[Kappa]2^2)   - \[Theta]v3 \[Lambda]v3 (\[Tau] \[Psi]p3+2 Log[(\[Psi]m3+\[ExponentialE]^(-\[Zeta]3 \[Tau]) \[Psi]p3)/(2\[Zeta]3)])/ (\[Kappa]3^2)   ;
c+A1 V1+A2 V2+A3 V3]


D1X=D[LogBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,Z1,Z2,\[Tau]],Z1];
D1XBiSuperLogNormalHestonFondamentalTransform=Function[{\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]},Evaluate[Simplify[1/\[ImaginaryI] D1X /.{Z1->0,Z2->0},\[Lambda]v1>0&&\[Lambda]v2>0&&\[Lambda]v3>0]]];


D1Y=D[LogBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,Z1,Z2,\[Tau]],Z2];
D1YBiSuperLogNormalHestonFondamentalTransform=Function[{\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]},Evaluate[Simplify[1/\[ImaginaryI] D1Y/.{Z1->0,Z2->0},\[Lambda]v1>0&&\[Lambda]v2>0&&\[Lambda]v3>0]]];


D2XX=D[LogBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,Z1,Z2,\[Tau]],{Z1,2}];
D2XXBiSuperLogNormalHestonFondamentalTransform=Function[{\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]},Evaluate[Simplify[1/\[ImaginaryI]^2 D2XX/.{Z1->0,Z2->0},\[Lambda]v1>0&&\[Lambda]v2>0&&\[Lambda]v3>0]]];


D2YY=D[LogBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,Z1,Z2,\[Tau]],{Z2,2}];
D2YYBiSuperLogNormalHestonFondamentalTransform=Function[{\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]},Evaluate[Simplify[1/\[ImaginaryI]^2 D2YY/.{Z1->0,Z2->0},\[Lambda]v1>0&&\[Lambda]v2>0&&\[Lambda]v3>0]]];


D2XY=D[LogBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,Z1,Z2,\[Tau]],Z1,Z2];
D2XYBiSuperLogNormalHestonFondamentalTransform=Function[{\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]},Evaluate[Simplify[1/\[ImaginaryI]^2 D2XY/.{Z1->0,Z2->0},\[Lambda]v1>0&&\[Lambda]v2>0&&\[Lambda]v3>0]]];


Drift[x_]:=1/2 (D[x,S1,S1](Diff[S1].Diff[S1])+D[x,S1,S2](Diff[S1].Diff[S2])+D[x,S2,S2](Diff[S2].Diff[S2])+D[x,V1,V1](Diff[V1].Diff[V1])+D[x,V2,V2](Diff[V2].Diff[V2])+D[x,V3,V3](Diff[V3].Diff[V3]))



BiLogVarVsCoVar[S1_,S2_,V1_,V2_,\[Rho]_]:={4 (S1^4 V1^3+S2^4 V2^3-2 S1 S2^3 Sqrt[V1] V2^2 \[Rho] (Sqrt[V2]+Sqrt[V1] \[Rho])-2 S1^3 S2 (V1^(5/2) Sqrt[V2] \[Rho]+V1^2 V2 \[Rho]^2)+S1^2 S2^2 V1 V2 \[Rho] (V1 \[Rho]+V2 \[Rho]+2 Sqrt[V1] Sqrt[V2] (1+\[Rho]^2))),2 (S1^3 V1^2-S2^3 V2^2+S1 S2^2 Sqrt[V1] V2 \[Rho] (2 Sqrt[V2]+Sqrt[V1] \[Rho])-S1^2 S2 (2 V1^(3/2) Sqrt[V2] \[Rho]+V1 V2 \[Rho]^2))}


CorrelationExponentialAdjuster[V1_,V2_,\[Rho]_]:=(\[ExponentialE]^(\[Rho] Sqrt[V1 V2])-1)/Sqrt[(\[ExponentialE]^V1-1) (\[ExponentialE]^V2-1)]


\[Rho]projet\[EAcute][S1_,S2_, \[Rho]1_,\[Kappa]1_,V1_,\[Rho]2_,\[Kappa]2_,V2_,\[Rho]3_,\[Kappa]3_,V3_,\[Alpha]2_,\[Beta]2_]:=Module[{VarVS,VS,CoVarSVS},
VarVS=S1^2 V1 (2 S1 (V1+V2 \[Alpha]2^2)-2 S2 V2 \[Alpha]2 \[Beta]2) (2 S1 V1+2 V2 \[Alpha]2 (S1 \[Alpha]2-S2 \[Beta]2)+S1 \[Kappa]1 \[Rho]1)+S1^3 V1 \[Kappa]1 (-2 S2 V2 \[Alpha]2 \[Beta]2 \[Rho]1+S1 (\[Kappa]1+2 (V1+V2 \[Alpha]2^2) \[Rho]1))+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2 ((S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2+(2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) \[Rho]2)+V2 (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) (-2 S1 S2 \[Alpha]2 \[Beta]2 (V2 (\[Alpha]2+\[Beta]2)+\[Kappa]2 \[Rho]2)+S1^2 \[Alpha]2 (2 V1+\[Alpha]2 (2 V2 \[Alpha]2+\[Kappa]2 \[Rho]2))+S2^2 \[Beta]2 (2 V3+\[Beta]2 (2 V2 \[Beta]2+\[Kappa]2 \[Rho]2)))+S2^3 V3 \[Kappa]3 (-2 S1 V2 \[Alpha]2 \[Beta]2 \[Rho]3+S2 (\[Kappa]3+2 (V3+V2 \[Beta]2^2) \[Rho]3))+2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2)) (-2 S1 V2 \[Alpha]2 \[Beta]2+S2 (2 V3+2 V2 \[Beta]2^2+\[Kappa]3 \[Rho]3));
CoVarSVS=2 S1^2 V1 (S1 (V1+V2 \[Alpha]2^2)-S2 V2 \[Alpha]2 \[Beta]2)-2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2))+V2 (S1 \[Alpha]2-S2 \[Beta]2) (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2))+S1^3 V1 \[Kappa]1 \[Rho]1+V2 (S1 \[Alpha]2-S2 \[Beta]2)^3 \[Kappa]2 \[Rho]2-S2^3 V3 \[Kappa]3 \[Rho]3;
VS=S1^2 V1+S2^2 V3+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2;CoVarSVS/Sqrt[VS VarVS]]



\[Nu]projet\[EAcute][S1_,S2_, \[Rho]1_,\[Kappa]1_,V1_,\[Rho]2_,\[Kappa]2_,V2_,\[Rho]3_,\[Kappa]3_,V3_,\[Alpha]2_,\[Beta]2_]:=Module[{VarVS,VS},
VarVS=S1^2 V1 (2 S1 (V1+V2 \[Alpha]2^2)-2 S2 V2 \[Alpha]2 \[Beta]2) (2 S1 V1+2 V2 \[Alpha]2 (S1 \[Alpha]2-S2 \[Beta]2)+S1 \[Kappa]1 \[Rho]1)+S1^3 V1 \[Kappa]1 (-2 S2 V2 \[Alpha]2 \[Beta]2 \[Rho]1+S1 (\[Kappa]1+2 (V1+V2 \[Alpha]2^2) \[Rho]1))+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2 ((S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2+(2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) \[Rho]2)+V2 (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) (-2 S1 S2 \[Alpha]2 \[Beta]2 (V2 (\[Alpha]2+\[Beta]2)+\[Kappa]2 \[Rho]2)+S1^2 \[Alpha]2 (2 V1+\[Alpha]2 (2 V2 \[Alpha]2+\[Kappa]2 \[Rho]2))+S2^2 \[Beta]2 (2 V3+\[Beta]2 (2 V2 \[Beta]2+\[Kappa]2 \[Rho]2)))+S2^3 V3 \[Kappa]3 (-2 S1 V2 \[Alpha]2 \[Beta]2 \[Rho]3+S2 (\[Kappa]3+2 (V3+V2 \[Beta]2^2) \[Rho]3))+2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2)) (-2 S1 V2 \[Alpha]2 \[Beta]2+S2 (2 V3+2 V2 \[Beta]2^2+\[Kappa]3 \[Rho]3));
VS=S1^2 V1+S2^2 V3+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2;Sqrt[VarVS/VS]]


SmileBiSuperHestonNormalCorrelation[S1_,S2_, \[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,\[Alpha]2_,\[Beta]2_,LTFactorS_,\[Lambda]S_,SpreadStrikes_,\[Tau]_,LimitGindinkin_,printflag_]:=Module[{Z1,Z2,VarExpX,VarExpY,VarRealSpead,\[Rho]projet\[EAcute],\[Nu]projet\[EAcute],ExpcorreLT,driftVarVS,
\[Mu]X,\[Mu]Y,\[Mu]XX,\[Mu]YY,\[Mu]XY,\[Mu]XXX,\[Mu]XXY,\[Mu]XYY,\[Mu]YYY,\[Mu]XXXX,\[Mu]XXXY,\[Mu]XXYY,\[Mu]XYYY,\[Mu]YYYY,
\[Mu]1,\[Mu]2,\[Mu]3,\[Mu]4,V0Generateur,TrueIniVarSpread,x,prices,NormalTerminalcorrelT,\[Rho]model,VarVS,CoVarSVS,VS,\[Nu]final,\[Nu]normalized},

(*   determination de la correl  *)
{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}=
{{D1XBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D1YBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]},
{D2XXBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2YYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2XYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]}};
If[printflag==1 || MemberQ[printflag,1] ,Print["moments=",{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}]];
NormalTerminalcorrelT=\[Mu]XY/Sqrt[\[Mu]XX \[Mu]YY ];NormalTerminalcorrelT]



SmileBiSuperHestonLogNormalCorrelation[S1_,S2_, \[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,\[Alpha]2_,\[Beta]2_,LTFactorS_,\[Lambda]S_,SpreadStrikes_,\[Tau]_,LimitGindinkin_,printflag_]:=Module[{Z1,Z2,VarExpX,VarExpY,VarRealSpead,\[Rho]projet\[EAcute],\[Nu]projet\[EAcute],ExpcorreLT,driftVarVS,
\[Mu]X,\[Mu]Y,\[Mu]XX,\[Mu]YY,\[Mu]XY,\[Mu]XXX,\[Mu]XXY,\[Mu]XYY,\[Mu]YYY,\[Mu]XXXX,\[Mu]XXXY,\[Mu]XXYY,\[Mu]XYYY,\[Mu]YYYY,
\[Mu]1,\[Mu]2,\[Mu]3,\[Mu]4,V0Generateur,TrueIniVarSpread,x,prices,NormalTerminalcorrelT,\[Rho]model,VarVS,CoVarSVS,VS,\[Nu]final,\[Nu]normalized},

(*   determination de la correl  *)
{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}=
{{D1XBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D1YBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]},
{D2XXBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2YYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2XYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]}};
If[printflag==1 || MemberQ[printflag,1] ,Print["moments=",{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}]];
NormalTerminalcorrelT=\[Mu]XY/Sqrt[\[Mu]XX \[Mu]YY ];
(-1+\[ExponentialE]^(NormalTerminalcorrelT Sqrt[\[Mu]XX \[Mu]YY]))/Sqrt[(-1+\[ExponentialE]^\[Mu]XX) (-1+\[ExponentialE]^\[Mu]YY)]]



SmileBiSuperHestonVanillaSpreadOption[S1_,S2_, \[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,\[Alpha]2_,\[Beta]2_,LTFactorS_,\[Lambda]S_,SpreadStrikes_,\[Tau]_,LimitGindinkin_,printflag_]:=Module[{Z1,Z2,VarExpX,VarExpY,VarRealSpead,\[Rho]projet\[EAcute],\[Nu]projet\[EAcute],ExpcorreLT,driftVarVS,
\[Mu]X,\[Mu]Y,\[Mu]XX,\[Mu]YY,\[Mu]XY,\[Mu]XXX,\[Mu]XXY,\[Mu]XYY,\[Mu]YYY,\[Mu]XXXX,\[Mu]XXXY,\[Mu]XXYY,\[Mu]XYYY,\[Mu]YYYY,
\[Mu]1,\[Mu]2,\[Mu]3,\[Mu]4,V0Generateur,TrueIniVarSpread,x,prices,NormalTerminalcorrelT,\[Rho]model,VarVS,CoVarSVS,VS,
\[Nu]final,\[Nu]normalized,Sig1,Sig2,Correl12,numinimum,\[Nu]brut,TrueImpliedCorr,rhominimum,V0minimim,\[Rho]projet\[EAcute]Ini},

(*   determination de la correl  *)
{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}=
{{D1XBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D1YBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]},
{D2XXBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2YYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2XYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]}};
If[printflag==1 || MemberQ[printflag,1] ,Print["moments=",{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}]];
NormalTerminalcorrelT=\[Mu]XY/Sqrt[\[Mu]XX \[Mu]YY ];
ExpcorreLT=CorrelationExponentialAdjuster[\[Mu]XX,\[Mu]YY,NormalTerminalcorrelT];

If[printflag==1 || MemberQ[printflag,1] ,Print["NormalTerminalcorrelT=",NormalTerminalcorrelT," ExpcorreLT=",ExpcorreLT]];
(* determination de la variance *)
VarExpX=LogHestonNormalVarianceProxy[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Alpha]2^2 \[Theta]v2,\[Alpha]2 \[Kappa]2,\[Alpha]2^2 V2,S1,\[Tau]];
VarExpY=LogHestonNormalVarianceProxy[\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Rho]2,\[Lambda]v2,\[Beta]2 ^2 \[Theta]v2,\[Beta]2 \[Kappa]2,\[Beta]2^2 V2,S2,\[Tau]];
If[printflag==1 || MemberQ[printflag,1] ,Print["VarExpX=",VarExpX," VarExpY=",VarExpY]];
VarRealSpead=VarExpX+VarExpY-2ExpcorreLT Sqrt[VarExpX VarExpY];
If[printflag==1 || MemberQ[printflag,1] ,Print["VarRealSpead (Goal)=",VarRealSpead]];

(* determination de la variance normale initiale equvalente *)
TrueIniVarSpread=(\[ExponentialE]^(\[Lambda]S \[Tau]) VarRealSpead \[Lambda]S)/(-1+LTFactorS+\[ExponentialE]^(\[Lambda]S \[Tau]) (1+LTFactorS (-1+\[Lambda]S \[Tau])));
If[printflag==1 || MemberQ[printflag,1] ,Print["TrueIniVarSpread=",TrueIniVarSpread]];

(* determination des parametres de smile initial grace au generateur*)
VarVS=S1^2 V1 (2 S1 (V1+V2 \[Alpha]2^2)-2 S2 V2 \[Alpha]2 \[Beta]2) (2 S1 V1+2 V2 \[Alpha]2 (S1 \[Alpha]2-S2 \[Beta]2)+S1 \[Kappa]1 \[Rho]1)+S1^3 V1 \[Kappa]1 (-2 S2 V2 \[Alpha]2 \[Beta]2 \[Rho]1+S1 (\[Kappa]1+2 (V1+V2 \[Alpha]2^2) \[Rho]1))+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2 ((S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2+(2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) \[Rho]2)+V2 (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) (-2 S1 S2 \[Alpha]2 \[Beta]2 (V2 (\[Alpha]2+\[Beta]2)+\[Kappa]2 \[Rho]2)+S1^2 \[Alpha]2 (2 V1+\[Alpha]2 (2 V2 \[Alpha]2+\[Kappa]2 \[Rho]2))+S2^2 \[Beta]2 (2 V3+\[Beta]2 (2 V2 \[Beta]2+\[Kappa]2 \[Rho]2)))+S2^3 V3 \[Kappa]3 (-2 S1 V2 \[Alpha]2 \[Beta]2 \[Rho]3+S2 (\[Kappa]3+2 (V3+V2 \[Beta]2^2) \[Rho]3))+2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2)) (-2 S1 V2 \[Alpha]2 \[Beta]2+S2 (2 V3+2 V2 \[Beta]2^2+\[Kappa]3 \[Rho]3));
CoVarSVS=2 S1^2 V1 (S1 (V1+V2 \[Alpha]2^2)-S2 V2 \[Alpha]2 \[Beta]2)-2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2))+V2 (S1 \[Alpha]2-S2 \[Beta]2) (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2))+S1^3 V1 \[Kappa]1 \[Rho]1+V2 (S1 \[Alpha]2-S2 \[Beta]2)^3 \[Kappa]2 \[Rho]2-S2^3 V3 \[Kappa]3 \[Rho]3;

VS=S1^2 V1+S2^2 V3+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2;

driftVarVS=2 (S1^4 (12 V1^4+12 V1^3 (4 V2 \[Alpha]2^2+\[Kappa]1 \[Rho]1)+V2 \[Alpha]2^5 (12 V2^3 \[Alpha]2^3+9 V2 \[Alpha]2 \[Kappa]2^2+12 V2^2 \[Alpha]2^2 \[Kappa]2 \[Rho]2+2 \[Kappa]2^3 \[Rho]2)+
3 V1^2 (24 V2^2 \[Alpha]2^4+3 \[Kappa]1^2+4 V2 \[Alpha]2^2 (2 \[Kappa]1 \[Rho]1+\[Alpha]2 \[Kappa]2 \[Rho]2))+V1 (48 V2^3 \[Alpha]2^6+9 V2 \[Alpha]2^2 (\[Kappa]1^2+\[Alpha]2^2 \[Kappa]2^2)+2 \[Kappa]1^3 \[Rho]1+12 V2^2 \[Alpha]2^4 (\[Kappa]1 \[Rho]1+2 \[Alpha]2 \[Kappa]2 \[Rho]2)))-S1^3 S2 V2 \[Alpha]2 \[Beta]2 (12 V1^3+6 V1^2 (3 V2 \[Alpha]2 (2 \[Alpha]2+\[Beta]2)+\[Kappa]1 \[Rho]1+2 \[Alpha]2 \[Kappa]2 \[Rho]2)+\[Alpha]2^2 (6 V2^3 \[Alpha]2^2 (2 \[Alpha]2^2+3 \[Alpha]2 \[Beta]2+\[Beta]2^2)+3 V2 \[Alpha]2 (6 \[Alpha]2+5 \[Beta]2) \[Kappa]2^2+3 V2^2 \[Alpha]2 (6 \[Alpha]2^2+5 \[Alpha]2 \[Beta]2+\[Beta]2^2) \[Kappa]2 \[Rho]2+2 (3 \[Alpha]2+\[Beta]2) \[Kappa]2^3 \[Rho]2)+V1 (6 V2^2 \[Alpha]2^2 (6 \[Alpha]2^2+6 \[Alpha]2 \[Beta]2+\[Beta]2^2)+4 \[Kappa]1^2+2 \[Alpha]2 (7 \[Alpha]2+2 \[Beta]2) \[Kappa]2^2+3 V2 \[Alpha]2 (2 \[Alpha]2 \[Kappa]1 \[Rho]1+\[Beta]2 \[Kappa]1 \[Rho]1+10 \[Alpha]2^2 \[Kappa]2 \[Rho]2+4 \[Alpha]2 \[Beta]2 \[Kappa]2 \[Rho]2)))+S1^2 S2^2 V2 \[Alpha]2 \[Beta]2 (2 V1^2 (2 V3+\[Beta]2 (V2 \[Alpha]2+2 V2 \[Beta]2+\[Kappa]2 \[Rho]2))+V1 (4 V3^2+2 V3 (V2 (4 \[Alpha]2^2+6 \[Alpha]2 \[Beta]2+4 \[Beta]2^2)+(\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2)+\[Beta]2 (4 V2^2 (\[Alpha]2^3+4 \[Alpha]2^2 \[Beta]2+3 \[Alpha]2 \[Beta]2^2+\[Beta]2^3)+(5 \[Alpha]2+4 \[Beta]2) \[Kappa]2^2+2 V2 (4 \[Alpha]2^2+5 \[Alpha]2 \[Beta]2+\[Beta]2^2) \[Kappa]2 \[Rho]2))+\[Alpha]2 (2 V2^3 \[Beta]2 (\[Alpha]2+\[Beta]2)^2 (\[Alpha]2^2+4 \[Alpha]2 \[Beta]2+\[Beta]2^2)+2 V2^2 (2 V3 (\[Alpha]2^3+3 \[Alpha]2^2 \[Beta]2+4 \[Alpha]2 \[Beta]2^2+\[Beta]2^3)+3 \[Beta]2 (\[Alpha]2+\[Beta]2)^3 \[Kappa]2 \[Rho]2)+V2 (2 V3^2 (2 \[Alpha]2+\[Beta]2)+3 \[Beta]2 (3 \[Alpha]2^2+10 \[Alpha]2 \[Beta]2+3 \[Beta]2^2) \[Kappa]2^2+2 V3 (\[Alpha]2^2+5 \[Alpha]2 \[Beta]2+4 \[Beta]2^2) \[Kappa]2 \[Rho]2)+\[Kappa]2 (V3 (4 \[Alpha]2+5 \[Beta]2) \[Kappa]2+2 V3^2 \[Rho]2+6 \[Beta]2 (\[Alpha]2+\[Beta]2) \[Kappa]2^2 \[Rho]2)))+S2^4 (12 V3^4+V2 \[Beta]2^5 (12 V2^3 \[Beta]2^3+9 V2 \[Beta]2 \[Kappa]2^2+12 V2^2 \[Beta]2^2 \[Kappa]2 \[Rho]2+2 \[Kappa]2^3 \[Rho]2)+12 V3^3 (4 V2 \[Beta]2^2+\[Kappa]3 \[Rho]3)+V3 (48 V2^3 \[Beta]2^6+9 V2 \[Beta]2^2 (\[Beta]2^2 \[Kappa]2^2+\[Kappa]3^2)+2 \[Kappa]3^3 \[Rho]3+12 V2^2 \[Beta]2^4 (2 \[Beta]2 \[Kappa]2 \[Rho]2+\[Kappa]3 \[Rho]3))+3 V3^2 (24 V2^2 \[Beta]2^4+3 \[Kappa]3^2+4 V2 \[Beta]2^2 (\[Beta]2 \[Kappa]2 \[Rho]2+2 \[Kappa]3 \[Rho]3)))-S1 S2^3 V2 \[Alpha]2 \[Beta]2 (12 V3^3+\[Beta]2^2 (6 V2^3 \[Beta]2^2 (\[Alpha]2^2+3 \[Alpha]2 \[Beta]2+2 \[Beta]2^2)+3 V2 \[Beta]2 (5 \[Alpha]2+6 \[Beta]2) \[Kappa]2^2+3 V2^2 \[Beta]2 (\[Alpha]2^2+5 \[Alpha]2 \[Beta]2+6 \[Beta]2^2) \[Kappa]2 \[Rho]2+2 (\[Alpha]2+3 \[Beta]2) \[Kappa]2^3 \[Rho]2)+6 V3^2 (3 V2 \[Beta]2 (\[Alpha]2+2 \[Beta]2)+2 \[Beta]2 \[Kappa]2 \[Rho]2+\[Kappa]3 \[Rho]3)+V3 (6 V2^2 \[Beta]2^2 (\[Alpha]2^2+6 \[Alpha]2 \[Beta]2+6 \[Beta]2^2)+4 \[Alpha]2 \[Beta]2 \[Kappa]2^2+14 \[Beta]2^2 \[Kappa]2^2+4 \[Kappa]3^2+3 V2 \[Beta]2 (4 \[Alpha]2 \[Beta]2 \[Kappa]2 \[Rho]2+10 \[Beta]2^2 \[Kappa]2 \[Rho]2+\[Alpha]2 \[Kappa]3 \[Rho]3+2 \[Beta]2 \[Kappa]3 \[Rho]3))));

If[printflag==1 || MemberQ[printflag,1] ,Print["VS=",VS," VarVS=",VarVS," CoVarSVS=",CoVarSVS," driftVarVS=",driftVarVS]];
\[Rho]projet\[EAcute]=CoVarSVS/Sqrt[VS VarVS];\[Nu]projet\[EAcute]=Sqrt[VarVS/VS];

(* ajustement du kurtosis par effet de vol *)
\[Nu]brut= \[Nu]projet\[EAcute] Sqrt[VS/VarRealSpead];\[Nu]normalized=\[Nu]brut/Sqrt[TrueIniVarSpread];
Sig1=Sqrt[\[Alpha]2^2 V2+V1];Sig2=Sqrt[\[Beta]2^2 V2+V3];Correl12=\[Alpha]2 \[Beta]2 V2/(Sig1 Sig2);
Print[" {Numinimum,\[Rho]minimim}=",Timing[{numinimum,rhominimum,V0minimim}=NuRhoV0MinimunNormalHestonFromBilog[S1,S2,Sig1,Sig2,Correl12,\[Tau],\[Rho]projet\[EAcute],\[Lambda]S,LTFactorS ]]];
\[Nu]final=\[Nu]brut+numinimum;
If[printflag==1 || MemberQ[printflag,1] ,Print["\[Rho]projet\[EAcute]=",rhominimum," \[Nu]projet\[EAcute]=",\[Nu]projet\[EAcute]," \[Nu]brut=",\[Nu]brut," \[Nu]final/\[Nu]projet\[EAcute]=",\[Nu]final/\[Nu]projet\[EAcute]," \[Nu]normalized=",\[Nu]normalized]];
If[printflag==1 || MemberQ[printflag,1] ,Print["Normal Heston Parameters=",{{"S0",S1-S2},{"V0",TrueIniVarSpread},{"\[Theta]",LTFactorS TrueIniVarSpread},{"\[Lambda]v",\[Lambda]S},{"\[Rho]",rhominimum},{"\[Nu]",\[Nu]final},
{"\[Nu] normalized",\[Nu]final/Sqrt[TrueIniVarSpread]},{"standard dev equi.",Sqrt[TrueIniVarSpread]}} //MatrixForm]];
prices=TransHestonNormalCall[rhominimum,\[Lambda]S,LTFactorS V0minimim,\[Nu]final,V0minimim,S1-S2,SpreadStrikes,\[Tau],LimitGindinkin];
If[printflag==1 || MemberQ[printflag,1] ,Print["prices=",prices]];
prices
]


SmileBiSuperHestonVanillaSpreadOption[S1_,S2_, \[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,\[Alpha]2_,\[Beta]2_,LTFactorS_,\[Lambda]S_,SpreadStrikes_,\[Tau]_,LimitGindinkin_,printflag_]:=Module[{Z1,Z2,VarExpX,VarExpY,VarRealSpead,\[Rho]projet\[EAcute],\[Nu]projet\[EAcute],ExpcorreLT,driftVarVS,
\[Mu]X,\[Mu]Y,\[Mu]XX,\[Mu]YY,\[Mu]XY,\[Mu]XXX,\[Mu]XXY,\[Mu]XYY,\[Mu]YYY,\[Mu]XXXX,\[Mu]XXXY,\[Mu]XXYY,\[Mu]XYYY,\[Mu]YYYY,
\[Mu]1,\[Mu]2,\[Mu]3,\[Mu]4,V0Generateur,TrueIniVarSpread,x,prices,NormalTerminalcorrelT,\[Rho]model,VarVS,CoVarSVS,VS,\[Nu]final,\[Nu]normalized,Sig1,Sig2,Correl12,numinimum,\[Nu]brut,rhominimum,V0minimim,VarVSTotal,CoVarSVSTotal,\[Rho]projet\[EAcute]Ini},

(*   determination de la correl  *)
{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}=
{{D1XBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D1YBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]},
{D2XXBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2YYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2XYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]}};
If[printflag==1 || MemberQ[printflag,1] ,Print["moments=",{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}]];
NormalTerminalcorrelT=\[Mu]XY/Sqrt[\[Mu]XX \[Mu]YY ];
ExpcorreLT=CorrelationExponentialAdjuster[\[Mu]XX,\[Mu]YY,NormalTerminalcorrelT];

If[printflag==1 || MemberQ[printflag,1] ,Print["NormalTerminalcorrelT=",NormalTerminalcorrelT," ExpcorreLT=",ExpcorreLT]];
(* determination de la variance *)
VarExpX=LogHestonNormalVarianceProxy[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Alpha]2^2 \[Theta]v2,\[Alpha]2 \[Kappa]2,\[Alpha]2^2 V2,S1,\[Tau]];
VarExpY=LogHestonNormalVarianceProxy[\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Rho]2,\[Lambda]v2,\[Beta]2 ^2 \[Theta]v2,\[Beta]2 \[Kappa]2,\[Beta]2^2 V2,S2,\[Tau]];
If[printflag==1 || MemberQ[printflag,1] ,Print["VarExpX=",VarExpX," VarExpY=",VarExpY]];
VarRealSpead=VarExpX+VarExpY-2ExpcorreLT Sqrt[VarExpX VarExpY];
If[printflag==1 || MemberQ[printflag,1] ,Print["VarRealSpead (Goal)=",VarRealSpead]];

(* determination de la variance normale initiale equvalente *)
TrueIniVarSpread=(\[ExponentialE]^(\[Lambda]S \[Tau]) VarRealSpead \[Lambda]S)/(-1+LTFactorS+\[ExponentialE]^(\[Lambda]S \[Tau]) (1+LTFactorS (-1+\[Lambda]S \[Tau])));
If[printflag==1 || MemberQ[printflag,1] ,Print["TrueIniVarSpread=",TrueIniVarSpread]];

(* determination des parametres de smile initial grace au generateur*)
VarVS=S1^2 V1 (2 S1 (V1+V2 \[Alpha]2^2)-2 S2 V2 \[Alpha]2 \[Beta]2) (2 S1 V1+2 V2 \[Alpha]2 (S1 \[Alpha]2-S2 \[Beta]2)+S1 \[Kappa]1 \[Rho]1)+S1^3 V1 \[Kappa]1 (-2 S2 V2 \[Alpha]2 \[Beta]2 \[Rho]1+S1 (\[Kappa]1+2 (V1+V2 \[Alpha]2^2) \[Rho]1))+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2 ((S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2+(2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) \[Rho]2)+V2 (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) (-2 S1 S2 \[Alpha]2 \[Beta]2 (V2 (\[Alpha]2+\[Beta]2)+\[Kappa]2 \[Rho]2)+S1^2 \[Alpha]2 (2 V1+\[Alpha]2 (2 V2 \[Alpha]2+\[Kappa]2 \[Rho]2))+S2^2 \[Beta]2 (2 V3+\[Beta]2 (2 V2 \[Beta]2+\[Kappa]2 \[Rho]2)))+S2^3 V3 \[Kappa]3 (-2 S1 V2 \[Alpha]2 \[Beta]2 \[Rho]3+S2 (\[Kappa]3+2 (V3+V2 \[Beta]2^2) \[Rho]3))+2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2)) (-2 S1 V2 \[Alpha]2 \[Beta]2+S2 (2 V3+2 V2 \[Beta]2^2+\[Kappa]3 \[Rho]3));
CoVarSVS=2 S1^2 V1 (S1 (V1+V2 \[Alpha]2^2)-S2 V2 \[Alpha]2 \[Beta]2)-2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2))+V2 (S1 \[Alpha]2-S2 \[Beta]2) (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2))+S1^3 V1 \[Kappa]1 \[Rho]1+V2 (S1 \[Alpha]2-S2 \[Beta]2)^3 \[Kappa]2 \[Rho]2-S2^3 V3 \[Kappa]3 \[Rho]3;

VS=S1^2 V1+S2^2 V3+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2;

If[printflag==1 || MemberQ[printflag,1] ,Print["VS=",VS," VarVS=",VarVS," CoVarSVS=",CoVarSVS]];
Sig1=Sqrt[\[Alpha]2^2 V2+V1];Sig2=Sqrt[\[Beta]2^2 V2+V3];Correl12=\[Alpha]2 \[Beta]2 V2/(Sig1 Sig2);\[Rho]projet\[EAcute]Ini=-0.2;
{numinimum,rhominimum,V0minimim}=NuRhoV0MinimunNormalHestonFromBilog[S1,S2,Sig1,Sig2,Correl12,\[Tau],\[Rho]projet\[EAcute]Ini,\[Lambda]S,LTFactorS ];
Print[" {Numinimum,\[Rho]minimim,V0ATM}=",{numinimum,rhominimum,V0minimim}];
VarVSTotal=VarVS+numinimum^2 V0minimim;
CoVarSVSTotal=CoVarSVS+rhominimum Sqrt[V0minimim (numinimum^2) V0minimim ];
\[Rho]projet\[EAcute]=CoVarSVSTotal/Sqrt[V0minimim VarVSTotal];\[Nu]projet\[EAcute]=Sqrt[VarVSTotal/V0minimim];

(* ajustement du kurtosis par effet de vol *)
(* \[Nu]brut= \[Nu]projet\[EAcute] Sqrt[VS/VarRealSpead];\[Nu]normalized=\[Nu]brut/Sqrt[TrueIniVarSpread];*)
If[printflag==1 || MemberQ[printflag,1] ,Print["\[Rho]projet\[EAcute]=",\[Rho]projet\[EAcute]," \[Nu]projet\[EAcute]=",\[Nu]projet\[EAcute]]];
If[printflag==1 || MemberQ[printflag,1] ,Print["Normal Heston Parameters=",{{"S0",S1-S2},{"V0",V0minimim},{"\[Theta]",LTFactorS V0minimim},{"\[Lambda]v",\[Lambda]S},{"\[Rho]",\[Rho]projet\[EAcute]},{"\[Nu]",\[Nu]projet\[EAcute]},
{"\[Nu] normalized",\[Nu]projet\[EAcute]/Sqrt[V0minimim]},{"standard dev equi.",Sqrt[V0minimim]}} //MatrixForm]];

prices=TransHestonNormalCall[\[Rho]projet\[EAcute],\[Lambda]S,LTFactorS V0minimim,\[Nu]projet\[EAcute],V0minimim,S1-S2,SpreadStrikes,\[Tau],LimitGindinkin];
If[printflag==1 || MemberQ[printflag,1] ,Print["prices=",prices]];
prices
]


PackagedSmileBiSuperHestonVanillaSpreadoptionRapide[S1_,S2_,SpreadStrikes_,\[Tau]_,
VolS1_,VolS2_,Correl12_,\[Rho]S1_,\[Rho]S2_,\[Rho]S3_,\[Kappa]S1_,\[Kappa]S2_,\[Kappa]S3_,\[Lambda]_,LTVarianceFactor_,LimitGindinkin_,
printflag_]:=
Module[{S,\[Rho]1,\[Kappa]1,V1,V2,\[Rho]2,\[Kappa]2,\[Rho]3,\[Kappa]3,V3,VarApprox,\[Alpha]2,\[Beta]2},
\[Beta]2=((1+Correl12)Sqrt[VolS2])/2;\[Alpha]2=(2Correl12)/(1+Correl12) Sqrt[VolS1];V1=VolS1-\[Alpha]2^2;V3=VolS2-\[Beta]2^2;V2=1;
\[Kappa]1=\[Kappa]S1;\[Kappa]2=\[Kappa]S2;\[Kappa]3=\[Kappa]S3;
\[Rho]1=\[Rho]S1;\[Rho]2=\[Rho]S2;\[Rho]3=\[Rho]S3;
If[printflag==1 || MemberQ[printflag,1]  ,
Print["Initial:",{{"S1",S1},{"VolSquareS1",VolS1},{"S2",S2},{"VolSquareS2",VolS2}} // MatrixForm,
" Process V1=",{{"V1",V1},{"\[Kappa]1",\[Kappa]1},{"\[Rho]1",\[Rho]1},{" \[Kappa]1 norm.",\[Kappa]1/Sqrt[V1]}} //MatrixForm,
" Process V2=",{{"\[Alpha]2",\[Alpha]2},{"\[Beta]2",\[Beta]2},{"\[Kappa]2",\[Kappa]2},{"\[Rho]2",\[Rho]2},{" \[Kappa]21 norm.",\[Kappa]2/\[Alpha]2},{" \[Kappa]22 norm.",\[Kappa]2/\[Beta]2}} //MatrixForm,
" Process V3=",{{"V3",V3},{"\[Kappa]3",\[Kappa]3},{"\[Rho]3",\[Rho]3},{" \[Kappa]3 norm.",\[Kappa]3/Sqrt[V3]}} //MatrixForm,
" T=",\[Tau]]];
VarApprox=((S1 Sqrt[VolS1])^2+(S2 Sqrt[VolS2])^2-2Correl12 S1 Sqrt[VolS1] S2 Sqrt[VolS2])\[Tau];
If[printflag==1 || MemberQ[printflag,1]  ,Print["variance attendue du spread:", VarApprox, " ecart type equivalent: ",Sqrt[VarApprox]];
Print["S1 ", S1, " S2 ",S2," VolS1=",VolS1," VolS2=",VolS2, " Correl12= ",Correl12];Print["entering   SmileBiSuperHestonVanillaSpreadOption **************"]];
SmileBiSuperHestonVanillaSpreadOption[S1,S2, \[Rho]1,\[Lambda],V1 LTVarianceFactor,\[Kappa]1,V1,\[Rho]2,\[Lambda],V2 LTVarianceFactor,\[Kappa]2,V2,\[Rho]3,\[Lambda],V3 LTVarianceFactor,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,LTVarianceFactor,\[Lambda],SpreadStrikes,\[Tau],LimitGindinkin,printflag]]


PackagedSmileBiSuperHestonUnderlyingOption2[S1_,S2_,KList_,T_,
VolS1_,VolS2_,Correl12_,\[Rho]1_,\[Rho]2_,\[Rho]3_,\[Kappa]1_,\[Kappa]2_,\[Kappa]3_,\[Lambda]_,LTVarianceFactor_,
printflag_]:=
Module[{S,V1,\[Alpha]2,\[Beta]2,V3,V2},
\[Beta]2=((1+Correl12)Sqrt[VolS2])/2;\[Alpha]2=(2Correl12)/(1+Correl12) Sqrt[VolS1];V1=VolS1-\[Alpha]2^2;V3=VolS2-\[Beta]2^2;V2=1;
If[printflag==1 || MemberQ[printflag,1]  ,
Print["Initial:",{{"S1",S1},{"VolS1",VolS1},{"S2",S2},{"VolS2",VolS2}} // MatrixForm,
" repartition=",{{"\[Beta]2",\[Beta]2},{"\[Alpha]2",\[Alpha]2},{"V1",V1},{"V3",V3}}//MatrixForm,
" Process V2=",{{"\[Alpha]2",\[Alpha]2},{"\[Beta]2",\[Beta]2},{"\[Lambda]v2",\[Lambda]},{"\[Theta]v2",\[Beta]2^2 LTVarianceFactor},{"\[Kappa]2",\[Kappa]2},{"\[Rho]2",\[Rho]2}} //MatrixForm,
" Process V3=",{{"V3",V3},{"\[Lambda]v2",\[Lambda]},{"\[Theta]v3",V3 LTVarianceFactor},{"\[Kappa]3",\[Kappa]3},{"\[Rho]3",\[Rho]3}} //MatrixForm,
" T=",T]];
Table[LogHestonNormalCall[\[Rho]3,\[Lambda],V3 LTVarianceFactor,\[Kappa]3,V3,\[Rho]2,\[Lambda],\[Beta]2^2 LTVarianceFactor,\[Beta]2 \[Kappa]2,\[Beta]2^2,S2,KList[[i]],T],{i,1,Length[KList]}]]


PackagedSmileBiSuperHestonUnderlyingOption1[S1_,S2_,KList_,T_,
VolS1_,VolS2_,Correl12_,\[Rho]1_,\[Rho]2_,\[Rho]3_,\[Kappa]1_,\[Kappa]2_,\[Kappa]3_,\[Lambda]_,LTVarianceFactor_,
printflag_]:=
Module[{S,V1,\[Alpha]2,\[Beta]2,V3},
\[Beta]2=((1+Correl12)Sqrt[VolS2])/2;\[Alpha]2=(2Correl12)/(1+Correl12) Sqrt[VolS1];V1=VolS1-\[Alpha]2^2;V3=VolS2-\[Beta]2^2;V2=1;
If[printflag==1 || MemberQ[printflag,1]  ,
Print["Initial:",{{"S1",S1},{"VolS1",VolS1},{"S2",S2},{"VolS2",VolS2}} // MatrixForm,
" repartition=",{{"\[Beta]2",\[Beta]2},{"\[Alpha]2",\[Alpha]2},{"V1",V1},{"V3",V3}}//MatrixForm,
" Process V1=",{{"V1",V1},{"\[Lambda]v1",\[Lambda]},{"\[Theta]v1",V1 LTVarianceFactor },{"\[Kappa]1",\[Kappa]1},{"\[Rho]1",\[Rho]1}} //MatrixForm,
" Process V2=",{{"\[Alpha]2",\[Alpha]2},{"\[Beta]2",\[Beta]2},{"\[Lambda]v2",\[Lambda]},{"\[Theta]v2",\[Alpha]2^2 LTVarianceFactor},{"\[Kappa]2",\[Kappa]2},{"\[Rho]2",\[Rho]2}} //MatrixForm," T=",T]];
Table[LogHestonNormalCall[\[Rho]1,\[Lambda],V1 LTVarianceFactor,\[Kappa]1,V1,\[Rho]2,\[Lambda],\[Alpha]2^2 LTVarianceFactor,\[Alpha]2 \[Kappa]2,\[Alpha]2^2,S1,KList[[i]],T],{i,1,Length[KList]}]]


(* HestonNormalCallAux[\[Rho]_,\[Lambda]v_,\[Theta]v_,\[Kappa]_,V_,S0_,k_,T_]:=1/\[Pi]Re[Module[{\[Lambda]=0.5,\[Omega]},
AdaptativeIntegrate[Function[\[Omega],NormalHestonCallIntegrand[\[Rho],\[Lambda]v,\[Theta]v,\[Kappa],V,S0,k,1,1,T,\[Omega] +\[Lambda] \[ImaginaryI]]],LegendreCoeffs[100],LegendreCoeffs[30],
10,1,10^(-10),1000,1,LegendreCoeffs[100]][[2]]]]
*)


Drift[x_]:=1/2 (D[x,S1,S1](Diff[S1].Diff[S1])+D[x,S1,S2](Diff[S1].Diff[S2])+D[x,S2,S2](Diff[S2].Diff[S2])+D[x,V1,V1](Diff[V1].Diff[V1])+D[x,V2,V2](Diff[V2].Diff[V2])+D[x,V3,V3](Diff[V3].Diff[V3]))



\[Nu]projet\[EAcute]Packaged[S1_,S2_,VolS1_,VolS2_,Correl12_, \[Rho]1_,\[Kappa]1_,\[Rho]2_,\[Kappa]2_,\[Rho]3_,\[Kappa]3_]:=Module[{VarVS,VS,\[Alpha]2,\[Beta]2,V1,V2,V3},
\[Beta]2=((1+Correl12)Sqrt[VolS2])/2;\[Alpha]2=(2Correl12)/(1+Correl12) Sqrt[VolS1];V1=VolS1-\[Alpha]2^2;V3=VolS2-\[Beta]2^2;V2=1;
VarVS=S1^2 V1 (2 S1 (V1+V2 \[Alpha]2^2)-2 S2 V2 \[Alpha]2 \[Beta]2) (2 S1 V1+2 V2 \[Alpha]2 (S1 \[Alpha]2-S2 \[Beta]2)+S1 \[Kappa]1 \[Rho]1)+S1^3 V1 \[Kappa]1 (-2 S2 V2 \[Alpha]2 \[Beta]2 \[Rho]1+S1 (\[Kappa]1+2 (V1+V2 \[Alpha]2^2) \[Rho]1))+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2 ((S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2+(2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) \[Rho]2)+V2 (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) (-2 S1 S2 \[Alpha]2 \[Beta]2 (V2 (\[Alpha]2+\[Beta]2)+\[Kappa]2 \[Rho]2)+S1^2 \[Alpha]2 (2 V1+\[Alpha]2 (2 V2 \[Alpha]2+\[Kappa]2 \[Rho]2))+S2^2 \[Beta]2 (2 V3+\[Beta]2 (2 V2 \[Beta]2+\[Kappa]2 \[Rho]2)))+S2^3 V3 \[Kappa]3 (-2 S1 V2 \[Alpha]2 \[Beta]2 \[Rho]3+S2 (\[Kappa]3+2 (V3+V2 \[Beta]2^2) \[Rho]3))+2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2)) (-2 S1 V2 \[Alpha]2 \[Beta]2+S2 (2 V3+2 V2 \[Beta]2^2+\[Kappa]3 \[Rho]3));
VS=S1^2 V1+S2^2 V3+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2;Sqrt[VarVS/VS]]


BiSuperHestonFondamentalTransform[\[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,Z1_,Z2_,\[Alpha]2_,\[Beta]2_,\[Tau]_]:=
Module[{\[Zeta]1,\[Psi]p1 ,\[Psi]m1,A1,arg\[Zeta]1,\[Zeta]2,\[Psi]p2 ,\[Psi]m2,A2,arg\[Zeta]2,\[Zeta]3,\[Psi]p3 ,\[Psi]m3,A3,arg\[Zeta]3,c},
arg\[Zeta]1=(\[Lambda]v1+\[Rho]1 \[Kappa]1 \[ImaginaryI] Z1)^2+\[Kappa]1^2 ( Z1^2-\[ImaginaryI] Z1);
\[Zeta]1=Sqrt[arg\[Zeta]1];
\[Psi]p1 =-(\[Lambda]v1+\[Rho]1 \[Kappa]1 \[ImaginaryI] Z1)+\[Zeta]1;
\[Psi]m1 =(\[Lambda]v1+\[Rho]1 \[Kappa]1  \[ImaginaryI] Z1)+\[Zeta]1;
A1= -( Z1^2-\[ImaginaryI] Z1)(1-\[ExponentialE]^(-\[Zeta]1  \[Tau]))/(\[Psi]m1+\[Psi]p1 \[ExponentialE]^(-\[Zeta]1  \[Tau]));
arg\[Zeta]2=(\[Lambda]v2+\[Rho]2 \[Kappa]2 \[ImaginaryI] (Z1 \[Alpha]2+Z2 \[Beta]2))^2+\[Kappa]2^2 ( Z1 (-\[ImaginaryI]+Z1) \[Alpha]2^2+2 Z1 Z2 \[Alpha]2 \[Beta]2+Z2 (-\[ImaginaryI]+Z2) \[Beta]2^2);
\[Zeta]2=Sqrt[arg\[Zeta]2];
\[Psi]p2 =-(\[Lambda]v2+\[Rho]2 \[Kappa]2  \[ImaginaryI] (Z1 \[Alpha]2+Z2 \[Beta]2))+\[Zeta]2;
\[Psi]m2 =(\[Lambda]v2+\[Rho]2 \[Kappa]2  \[ImaginaryI] (Z1 \[Alpha]2+Z2 \[Beta]2))+\[Zeta]2;
A2= -( Z1 (-\[ImaginaryI]+Z1) \[Alpha]2^2+2 Z1 Z2 \[Alpha]2 \[Beta]2+Z2 (-\[ImaginaryI]+Z2) \[Beta]2^2)(1-\[ExponentialE]^(-\[Zeta]2  \[Tau]))/(\[Psi]m2+\[Psi]p2 \[ExponentialE]^(-\[Zeta]2  \[Tau]));
arg\[Zeta]3=(\[Lambda]v3+\[Rho]3 \[Kappa]3 \[ImaginaryI] Z2)^2+\[Kappa]3^2 ( Z2^2-\[ImaginaryI] Z2);
\[Zeta]3=Sqrt[arg\[Zeta]3];
\[Psi]p3 =-(\[Lambda]v3+\[Rho]3 \[Kappa]3  \[ImaginaryI] Z2)+\[Zeta]3;
\[Psi]m3 =(\[Lambda]v3+\[Rho]3 \[Kappa]3  \[ImaginaryI] Z2)+\[Zeta]3;
A3= -( Z2^2-\[ImaginaryI] Z2)(1-\[ExponentialE]^(-\[Zeta]3  \[Tau]))/(\[Psi]m3+\[Psi]p3 \[ExponentialE]^(-\[Zeta]3  \[Tau]));

c=-( \[Theta]v1 \[Lambda]v1 (\[Tau] \[Psi]p1+2 Log[(\[Psi]m1+\[ExponentialE]^(-\[Zeta]1 \[Tau]) \[Psi]p1)/(2\[Zeta]1)])/ (\[Kappa]1^2)   )- \[Theta]v2 \[Lambda]v2 (\[Tau] \[Psi]p2+2 Log[(\[Psi]m2+\[ExponentialE]^(-\[Zeta]2 \[Tau]) \[Psi]p2)/(2\[Zeta]2)])/ (\[Kappa]2^2)   - \[Theta]v3 \[Lambda]v3 (\[Tau] \[Psi]p3+2 Log[(\[Psi]m3+\[ExponentialE]^(-\[Zeta]3 \[Tau]) \[Psi]p3)/(2\[Zeta]3)])/ (\[Kappa]3^2)   ;
If[Re[c+A1 V1+A2 V2+A3 V3]<-100,0,
\[ExponentialE]^(c+A1 V1+A2 V2+A3 V3)]
]


SmileBiSuperHestonVanillaSmileParameters[S1_,S2_, \[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,\[Alpha]2_,\[Beta]2_,LTFactorS_,\[Lambda]S_,\[Tau]_]:=Module[
{Z1,Z2,VarExpX,VarExpY,VarRealSpead,\[Rho]projet\[EAcute],\[Nu]projet\[EAcute],ExpcorreLT,driftVarVS,
\[Mu]X,\[Mu]Y,\[Mu]XX,\[Mu]YY,\[Mu]XY,\[Mu]XXX,\[Mu]XXY,\[Mu]XYY,\[Mu]YYY,\[Mu]XXXX,\[Mu]XXXY,\[Mu]XXYY,\[Mu]XYYY,\[Mu]YYYY,
\[Mu]1,\[Mu]2,\[Mu]3,\[Mu]4,V0Generateur,TrueIniVarSpread,x,prices,NormalTerminalcorrelT,\[Rho]model,VarVS,CoVarSVS,VS,\[Nu]final},

(*   determination de la correl  *)
{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}=
{{D1XBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D1YBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]},
{D2XXBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2YYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2XYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]}};
NormalTerminalcorrelT=\[Mu]XY/Sqrt[\[Mu]XX \[Mu]YY ];
ExpcorreLT=CorrelationExponentialAdjuster[\[Mu]XX,\[Mu]YY,NormalTerminalcorrelT];
VarExpX=LogHestonNormalVarianceProxy[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Alpha]2^2 \[Theta]v2,\[Alpha]2 \[Kappa]2,\[Alpha]2^2 V2,S1,\[Tau]];
VarExpY=LogHestonNormalVarianceProxy[\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Rho]2,\[Lambda]v2,\[Beta]2 ^2 \[Theta]v2,\[Beta]2 \[Kappa]2,\[Beta]2^2 V2,S2,\[Tau]];
VarRealSpead=VarExpX+VarExpY-2ExpcorreLT Sqrt[VarExpX VarExpY];
TrueIniVarSpread=(\[ExponentialE]^(\[Lambda]S \[Tau]) VarRealSpead \[Lambda]S)/(-1+LTFactorS+\[ExponentialE]^(\[Lambda]S \[Tau]) (1+LTFactorS (-1+\[Lambda]S \[Tau])));
VarVS=S1^2 V1 (2 S1 (V1+V2 \[Alpha]2^2)-2 S2 V2 \[Alpha]2 \[Beta]2) (2 S1 V1+2 V2 \[Alpha]2 (S1 \[Alpha]2-S2 \[Beta]2)+S1 \[Kappa]1 \[Rho]1)+S1^3 V1 \[Kappa]1 (-2 S2 V2 \[Alpha]2 \[Beta]2 \[Rho]1+S1 (\[Kappa]1+2 (V1+V2 \[Alpha]2^2) \[Rho]1))+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2 ((S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2+(2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) \[Rho]2)+V2 (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) (-2 S1 S2 \[Alpha]2 \[Beta]2 (V2 (\[Alpha]2+\[Beta]2)+\[Kappa]2 \[Rho]2)+S1^2 \[Alpha]2 (2 V1+\[Alpha]2 (2 V2 \[Alpha]2+\[Kappa]2 \[Rho]2))+S2^2 \[Beta]2 (2 V3+\[Beta]2 (2 V2 \[Beta]2+\[Kappa]2 \[Rho]2)))+S2^3 V3 \[Kappa]3 (-2 S1 V2 \[Alpha]2 \[Beta]2 \[Rho]3+S2 (\[Kappa]3+2 (V3+V2 \[Beta]2^2) \[Rho]3))+2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2)) (-2 S1 V2 \[Alpha]2 \[Beta]2+S2 (2 V3+2 V2 \[Beta]2^2+\[Kappa]3 \[Rho]3));
CoVarSVS=2 S1^2 V1 (S1 (V1+V2 \[Alpha]2^2)-S2 V2 \[Alpha]2 \[Beta]2)-2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2))+V2 (S1 \[Alpha]2-S2 \[Beta]2) (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2))+S1^3 V1 \[Kappa]1 \[Rho]1+V2 (S1 \[Alpha]2-S2 \[Beta]2)^3 \[Kappa]2 \[Rho]2-S2^3 V3 \[Kappa]3 \[Rho]3;
VS=S1^2 V1+S2^2 V3+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2;
\[Rho]projet\[EAcute]=CoVarSVS/Sqrt[VS VarVS];\[Nu]projet\[EAcute]=Sqrt[VarVS/VS];\[Nu]final=\[Nu]projet\[EAcute] Sqrt[VS/TrueIniVarSpread];{TrueIniVarSpread,\[Rho]projet\[EAcute],\[Nu]final}
]


CalibrateKappaSpecifBiSuperHestonSmileParams[S1_,S2_,\[Lambda]v1_,\[Theta]v1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Lambda]v3_,\[Theta]v3_,V3_,\[Alpha]2_,\[Beta]2_,LTFactorS_,\[Lambda]S_,\[Tau]_,TrueIniVarSpread_,\[Nu]final_,\[Rho]projet\[EAcute]_,kappaFact1_,kappaFact2_,rhobase1_,rhobase3_]:=
Module[{VarVS,CoVarSVS,\[Kappa]specif,\[Rho]specif,\[Kappa]1,\[Kappa]3,VS,\[Rho]1,\[Rho]3,\[Kappa]specif1,\[Kappa]specif2},
VS=S1^2 V1+S2^2 V3+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2;
VarVS=\[Nu]final^2 TrueIniVarSpread;CoVarSVS=\[Rho]projet\[EAcute] Sqrt[VS VarVS];
Print["VS=",VS," VarVS=",VarVS," CoVarSVS=",CoVarSVS];
\[Kappa]specif1=-(2 kappaFact1 kappaFact2 rhobase1 S1^4 S2^3 V1^2 V3+2 kappaFact1 kappaFact2 rhobase3 S1^4 S2^3 V1^2 V3+2 kappaFact1 kappaFact2 rhobase1 S1^3 S2^4 V1 V3^2+2 kappaFact1 kappaFact2 rhobase3 S1^3 S2^4 V1 V3^2+2 kappaFact1 kappaFact2 rhobase1 S1^4 S2^3 V1 V2 V3 \[Alpha]2^2+2 kappaFact1 kappaFact2 rhobase3 S1^4 S2^3 V1 V2 V3 \[Alpha]2^2-2 kappaFact1 kappaFact2 rhobase1 S1^4 S2^3 V1 V2 V3 \[Alpha]2 \[Beta]2-2 kappaFact1 kappaFact2 rhobase3 S1^4 S2^3 V1 V2 V3 \[Alpha]2 \[Beta]2-2 kappaFact1 kappaFact2 rhobase1 S1^3 S2^4 V1 V2 V3 \[Alpha]2 \[Beta]2-2 kappaFact1 kappaFact2 rhobase3 S1^3 S2^4 V1 V2 V3 \[Alpha]2 \[Beta]2+2 kappaFact1 kappaFact2 rhobase1 S1^3 S2^4 V1 V2 V3 \[Beta]2^2+2 kappaFact1 kappaFact2 rhobase3 S1^3 S2^4 V1 V2 V3 \[Beta]2^2-1/2 \[Sqrt](16 kappaFact1^2 kappaFact2^2 (rhobase1+rhobase3)^2 S1^6 S2^6 V1^2 V3^2 (S1 (V1+V2 \[Alpha]2 (\[Alpha]2-\[Beta]2))+S2 (V3+V2 \[Beta]2 (-\[Alpha]2+\[Beta]2)))^2-4 (kappaFact1^3 S1^7 V1^2+kappaFact1^2 kappaFact2 S1^4 S2^3 V1 V3+kappaFact1 kappaFact2^2 S1^3 S2^4 V1 V3+kappaFact2^3 S2^7 V3^2) (4 CoVarSVS (kappaFact1 S1^3 V1 (S1 (V1+V2 \[Alpha]2^2)-S2 V2 \[Alpha]2 \[Beta]2)-kappaFact2 S2^3 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2)))+kappaFact1 S1^3 V1 (-VarVS-S1^4 (4 V1^3+12 V1^2 V2 \[Alpha]2^2+12 V1 V2^2 \[Alpha]2^4+4 V2^3 \[Alpha]2^6-V2 \[Alpha]2^4 \[Kappa]2^2)+4 S1^3 S2 V2 \[Alpha]2 \[Beta]2 (4 V1^2+V1 \[Alpha]2 (8 V2 \[Alpha]2+\[Kappa]2 \[Rho]2)+\[Alpha]2^2 (4 V2^2 \[Alpha]2^2-\[Kappa]2^2+V2 (\[Alpha]2-\[Beta]2) \[Kappa]2 \[Rho]2))+S2^4 (4 V3^3+4 V2 V3^2 \[Beta]2 (-2 \[Alpha]2+3 \[Beta]2)+4 V2 V3 \[Beta]2^3 (-4 V2 \[Alpha]2+3 V2 \[Beta]2+\[Kappa]2 \[Rho]2)+V2 \[Beta]2^4 (4 V2^2 \[Beta]2 (-2 \[Alpha]2+\[Beta]2)+\[Kappa]2^2+4 V2 (-\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2))-2 S1^2 S2^2 V2 \[Alpha]2 \[Beta]2 (2 V1 (2 V3+\[Beta]2 (5 V2 \[Alpha]2+2 V2 \[Beta]2+2 \[Kappa]2 \[Rho]2))+\[Alpha]2 (-2 V2^2 \[Beta]2 (-5 \[Alpha]2^2-2 \[Alpha]2 \[Beta]2+\[Beta]2^2)-\[Kappa]2 (3 \[Beta]2 \[Kappa]2+2 V3 \[Rho]2)+V2 (V3 (4 \[Alpha]2-2 \[Beta]2)+6 (\[Alpha]2-\[Beta]2) \[Beta]2 \[Kappa]2 \[Rho]2)))+4 S1 S2^3 (V1 (2 V3^2+4 V2 V3 \[Beta]2^2+V2 \[Beta]2^3 (2 V2 \[Beta]2+\[Kappa]2 \[Rho]2))+V2 \[Alpha]2 (2 V3^2 (\[Alpha]2-\[Beta]2)-2 V3 \[Beta]2^2 (-3 V2 \[Alpha]2+2 V2 \[Beta]2+\[Kappa]2 \[Rho]2)-\[Beta]2^3 (-2 V2^2 (\[Alpha]2^2+2 \[Alpha]2 \[Beta]2-\[Beta]2^2)+\[Kappa]2^2+3 V2 (-\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2))))+kappaFact2 S2^3 V3 (-VarVS-S2^4 (4 V3^3+12 V2 V3^2 \[Beta]2^2+12 V2^2 V3 \[Beta]2^4+4 V2^3 \[Beta]2^6-V2 \[Beta]2^4 \[Kappa]2^2)+S1^4 (4 V1^3+4 V1^2 V2 \[Alpha]2 (3 \[Alpha]2-2 \[Beta]2)+4 V1 V2 \[Alpha]2^3 (3 V2 \[Alpha]2-4 V2 \[Beta]2+\[Kappa]2 \[Rho]2)+V2 \[Alpha]2^4 (4 V2^2 \[Alpha]2 (\[Alpha]2-2 \[Beta]2)+\[Kappa]2^2+4 V2 (\[Alpha]2-\[Beta]2) \[Kappa]2 \[Rho]2))+4 S1 S2^3 V2 \[Alpha]2 \[Beta]2 (4 V3^2+V3 \[Beta]2 (8 V2 \[Beta]2+\[Kappa]2 \[Rho]2)+\[Beta]2^2 (4 V2^2 \[Beta]2^2-\[Kappa]2^2+V2 (-\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2))+4 S1^3 S2 (2 V1^2 (V3+V2 \[Beta]2 (-\[Alpha]2+\[Beta]2))-2 V1 V2 \[Alpha]2^2 (-2 V3+\[Beta]2 (2 V2 \[Alpha]2-3 V2 \[Beta]2+\[Kappa]2 \[Rho]2))+V2 \[Alpha]2^3 (2 V2^2 \[Beta]2 (-\[Alpha]2^2+2 \[Alpha]2 \[Beta]2+\[Beta]2^2)+\[Kappa]2 (-\[Beta]2 \[Kappa]2+V3 \[Rho]2)+V2 (2 V3 \[Alpha]2+3 \[Beta]2 (-\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2)))+2 S1^2 S2^2 V2 \[Alpha]2 \[Beta]2 (2 V1 (-2 V3+\[Beta]2 (V2 \[Alpha]2-2 V2 \[Beta]2+\[Kappa]2 \[Rho]2))+\[Alpha]2 (2 V2^2 \[Beta]2 (\[Alpha]2^2-2 \[Alpha]2 \[Beta]2-5 \[Beta]2^2)+\[Kappa]2 (3 \[Beta]2 \[Kappa]2-4 V3 \[Rho]2)-2 V2 (V3 (2 \[Alpha]2+5 \[Beta]2)+3 \[Beta]2 (-\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2)))))))/(kappaFact1^3 S1^7 V1^2+kappaFact1^2 kappaFact2 S1^4 S2^3 V1 V3+kappaFact1 kappaFact2^2 S1^3 S2^4 V1 V3+kappaFact2^3 S2^7 V3^2);
\[Kappa]specif2=-(2 kappaFact1 kappaFact2 rhobase1 S1^4 S2^3 V1^2 V3+2 kappaFact1 kappaFact2 rhobase3 S1^4 S2^3 V1^2 V3+2 kappaFact1 kappaFact2 rhobase1 S1^3 S2^4 V1 V3^2+2 kappaFact1 kappaFact2 rhobase3 S1^3 S2^4 V1 V3^2+2 kappaFact1 kappaFact2 rhobase1 S1^4 S2^3 V1 V2 V3 \[Alpha]2^2+2 kappaFact1 kappaFact2 rhobase3 S1^4 S2^3 V1 V2 V3 \[Alpha]2^2-2 kappaFact1 kappaFact2 rhobase1 S1^4 S2^3 V1 V2 V3 \[Alpha]2 \[Beta]2-2 kappaFact1 kappaFact2 rhobase3 S1^4 S2^3 V1 V2 V3 \[Alpha]2 \[Beta]2-2 kappaFact1 kappaFact2 rhobase1 S1^3 S2^4 V1 V2 V3 \[Alpha]2 \[Beta]2-2 kappaFact1 kappaFact2 rhobase3 S1^3 S2^4 V1 V2 V3 \[Alpha]2 \[Beta]2+2 kappaFact1 kappaFact2 rhobase1 S1^3 S2^4 V1 V2 V3 \[Beta]2^2+2 kappaFact1 kappaFact2 rhobase3 S1^3 S2^4 V1 V2 V3 \[Beta]2^2+1/2 \[Sqrt](16 kappaFact1^2 kappaFact2^2 (rhobase1+rhobase3)^2 S1^6 S2^6 V1^2 V3^2 (S1 (V1+V2 \[Alpha]2 (\[Alpha]2-\[Beta]2))+S2 (V3+V2 \[Beta]2 (-\[Alpha]2+\[Beta]2)))^2-4 (kappaFact1^3 S1^7 V1^2+kappaFact1^2 kappaFact2 S1^4 S2^3 V1 V3+kappaFact1 kappaFact2^2 S1^3 S2^4 V1 V3+kappaFact2^3 S2^7 V3^2) (4 CoVarSVS (kappaFact1 S1^3 V1 (S1 (V1+V2 \[Alpha]2^2)-S2 V2 \[Alpha]2 \[Beta]2)-kappaFact2 S2^3 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2)))+kappaFact1 S1^3 V1 (-VarVS-S1^4 (4 V1^3+12 V1^2 V2 \[Alpha]2^2+12 V1 V2^2 \[Alpha]2^4+4 V2^3 \[Alpha]2^6-V2 \[Alpha]2^4 \[Kappa]2^2)+4 S1^3 S2 V2 \[Alpha]2 \[Beta]2 (4 V1^2+V1 \[Alpha]2 (8 V2 \[Alpha]2+\[Kappa]2 \[Rho]2)+\[Alpha]2^2 (4 V2^2 \[Alpha]2^2-\[Kappa]2^2+V2 (\[Alpha]2-\[Beta]2) \[Kappa]2 \[Rho]2))+S2^4 (4 V3^3+4 V2 V3^2 \[Beta]2 (-2 \[Alpha]2+3 \[Beta]2)+4 V2 V3 \[Beta]2^3 (-4 V2 \[Alpha]2+3 V2 \[Beta]2+\[Kappa]2 \[Rho]2)+V2 \[Beta]2^4 (4 V2^2 \[Beta]2 (-2 \[Alpha]2+\[Beta]2)+\[Kappa]2^2+4 V2 (-\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2))-2 S1^2 S2^2 V2 \[Alpha]2 \[Beta]2 (2 V1 (2 V3+\[Beta]2 (5 V2 \[Alpha]2+2 V2 \[Beta]2+2 \[Kappa]2 \[Rho]2))+\[Alpha]2 (-2 V2^2 \[Beta]2 (-5 \[Alpha]2^2-2 \[Alpha]2 \[Beta]2+\[Beta]2^2)-\[Kappa]2 (3 \[Beta]2 \[Kappa]2+2 V3 \[Rho]2)+V2 (V3 (4 \[Alpha]2-2 \[Beta]2)+6 (\[Alpha]2-\[Beta]2) \[Beta]2 \[Kappa]2 \[Rho]2)))+4 S1 S2^3 (V1 (2 V3^2+4 V2 V3 \[Beta]2^2+V2 \[Beta]2^3 (2 V2 \[Beta]2+\[Kappa]2 \[Rho]2))+V2 \[Alpha]2 (2 V3^2 (\[Alpha]2-\[Beta]2)-2 V3 \[Beta]2^2 (-3 V2 \[Alpha]2+2 V2 \[Beta]2+\[Kappa]2 \[Rho]2)-\[Beta]2^3 (-2 V2^2 (\[Alpha]2^2+2 \[Alpha]2 \[Beta]2-\[Beta]2^2)+\[Kappa]2^2+3 V2 (-\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2))))+kappaFact2 S2^3 V3 (-VarVS-S2^4 (4 V3^3+12 V2 V3^2 \[Beta]2^2+12 V2^2 V3 \[Beta]2^4+4 V2^3 \[Beta]2^6-V2 \[Beta]2^4 \[Kappa]2^2)+S1^4 (4 V1^3+4 V1^2 V2 \[Alpha]2 (3 \[Alpha]2-2 \[Beta]2)+4 V1 V2 \[Alpha]2^3 (3 V2 \[Alpha]2-4 V2 \[Beta]2+\[Kappa]2 \[Rho]2)+V2 \[Alpha]2^4 (4 V2^2 \[Alpha]2 (\[Alpha]2-2 \[Beta]2)+\[Kappa]2^2+4 V2 (\[Alpha]2-\[Beta]2) \[Kappa]2 \[Rho]2))+4 S1 S2^3 V2 \[Alpha]2 \[Beta]2 (4 V3^2+V3 \[Beta]2 (8 V2 \[Beta]2+\[Kappa]2 \[Rho]2)+\[Beta]2^2 (4 V2^2 \[Beta]2^2-\[Kappa]2^2+V2 (-\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2))+4 S1^3 S2 (2 V1^2 (V3+V2 \[Beta]2 (-\[Alpha]2+\[Beta]2))-2 V1 V2 \[Alpha]2^2 (-2 V3+\[Beta]2 (2 V2 \[Alpha]2-3 V2 \[Beta]2+\[Kappa]2 \[Rho]2))+V2 \[Alpha]2^3 (2 V2^2 \[Beta]2 (-\[Alpha]2^2+2 \[Alpha]2 \[Beta]2+\[Beta]2^2)+\[Kappa]2 (-\[Beta]2 \[Kappa]2+V3 \[Rho]2)+V2 (2 V3 \[Alpha]2+3 \[Beta]2 (-\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2)))+2 S1^2 S2^2 V2 \[Alpha]2 \[Beta]2 (2 V1 (-2 V3+\[Beta]2 (V2 \[Alpha]2-2 V2 \[Beta]2+\[Kappa]2 \[Rho]2))+\[Alpha]2 (2 V2^2 \[Beta]2 (\[Alpha]2^2-2 \[Alpha]2 \[Beta]2-5 \[Beta]2^2)+\[Kappa]2 (3 \[Beta]2 \[Kappa]2-4 V3 \[Rho]2)-2 V2 (V3 (2 \[Alpha]2+5 \[Beta]2)+3 \[Beta]2 (-\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2)))))))/(kappaFact1^3 S1^7 V1^2+kappaFact1^2 kappaFact2 S1^4 S2^3 V1 V3+kappaFact1 kappaFact2^2 S1^3 S2^4 V1 V3+kappaFact2^3 S2^7 V3^2);
Print["\[Kappa]specif1=",\[Kappa]specif1," \[Kappa]specif2=",\[Kappa]specif2];
\[Kappa]specif=\[Kappa]specif1;
\[Kappa]1=kappaFact1 \[Kappa]specif;\[Kappa]3=kappaFact2 \[Kappa]specif;
\[Rho]specif=1/(S1^3 V1 \[Kappa]1+S2^3 V3 \[Kappa]3) (-CoVarSVS+2 S1^3 V1^2-2 S2^3 V3^2+4 S1^3 V1 V2 \[Alpha]2^2+2 S1^3 V2^2 \[Alpha]2^4-4 S1^2 S2 V1 V2 \[Alpha]2 \[Beta]2+4 S1 S2^2 V2 V3 \[Alpha]2 \[Beta]2-4 S1^2 S2 V2^2 \[Alpha]2^3 \[Beta]2-4 S2^3 V2 V3 \[Beta]2^2-2 S1^2 S2 V2^2 \[Alpha]2^2 \[Beta]2^2+2 S1 S2^2 V2^2 \[Alpha]2^2 \[Beta]2^2+4 S1 S2^2 V2^2 \[Alpha]2 \[Beta]2^3-2 S2^3 V2^2 \[Beta]2^4+rhobase1 S1^3 V1 \[Kappa]1-rhobase3 S2^3 V3 \[Kappa]3+S1^3 V2 \[Alpha]2^3 \[Kappa]2 \[Rho]2-3 S1^2 S2 V2 \[Alpha]2^2 \[Beta]2 \[Kappa]2 \[Rho]2+3 S1 S2^2 V2 \[Alpha]2 \[Beta]2^2 \[Kappa]2 \[Rho]2-S2^3 V2 \[Beta]2^3 \[Kappa]2 \[Rho]2);
\[Rho]1=rhobase1-\[Rho]specif;\[Rho]3=rhobase3+\[Rho]specif;
(* verification *)
Print["verif1=",{VarVS,S1^2 V1 (2 S1 (V1+V2 \[Alpha]2^2)-2 S2 V2 \[Alpha]2 \[Beta]2) (2 S1 V1+2 V2 \[Alpha]2 (S1 \[Alpha]2-S2 \[Beta]2)+S1 \[Kappa]1 \[Rho]1)+S1^3 V1 \[Kappa]1 (-2 S2 V2 \[Alpha]2 \[Beta]2 \[Rho]1+S1 (\[Kappa]1+2 (V1+V2 \[Alpha]2^2) \[Rho]1))+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2 ((S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2+(2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) \[Rho]2)+V2 (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) (-2 S1 S2 \[Alpha]2 \[Beta]2 (V2 (\[Alpha]2+\[Beta]2)+\[Kappa]2 \[Rho]2)+S1^2 \[Alpha]2 (2 V1+\[Alpha]2 (2 V2 \[Alpha]2+\[Kappa]2 \[Rho]2))+S2^2 \[Beta]2 (2 V3+\[Beta]2 (2 V2 \[Beta]2+\[Kappa]2 \[Rho]2)))+S2^3 V3 \[Kappa]3 (-2 S1 V2 \[Alpha]2 \[Beta]2 \[Rho]3+S2 (\[Kappa]3+2 (V3+V2 \[Beta]2^2) \[Rho]3))+2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2)) (-2 S1 V2 \[Alpha]2 \[Beta]2+S2 (2 V3+2 V2 \[Beta]2^2+\[Kappa]3 \[Rho]3))}];
Print["verif 2=",{CoVarSVS,2 S1^2 V1 (S1 (V1+V2 \[Alpha]2^2)-S2 V2 \[Alpha]2 \[Beta]2)-2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2))+V2 (S1 \[Alpha]2-S2 \[Beta]2) (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2))+V2 (S1 \[Alpha]2-S2 \[Beta]2)^3 \[Kappa]2 \[Rho]2+S1^3 V1 \[Kappa]1 (rhobase1-\[Rho]specif)-S2^3 V3 \[Kappa]3 (rhobase3+\[Rho]specif)}];
{\[Kappa]specif,\[Rho]specif}]


PackagedSmileBiSuperHestonLogNormalCorrelation[S1_,S2_,\[Tau]_,
VolS1_,VolS2_,Correl12_,\[Rho]S1_,\[Rho]S2_,\[Rho]S3_,\[Kappa]S1_,\[Kappa]S2_,\[Kappa]S3_,\[Lambda]_,LTVarianceFactor_]:=
Module[{S,V1,V2,V3,VarApprox,\[Alpha]2,\[Beta]2,\[Mu]X,\[Mu]Y,\[Mu]XX,\[Mu]YY,\[Mu]XY,x,NormalTerminalcorrelT},
\[Beta]2=((1+Correl12)Sqrt[VolS2])/2;\[Alpha]2=(2Correl12)/(1+Correl12) Sqrt[VolS1];V1=VolS1-\[Alpha]2^2;V3=VolS2-\[Beta]2^2;V2=1;
{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}=
{{D1XBiSuperLogNormalHestonFondamentalTransform[\[Rho]S1,\[Lambda],LTVarianceFactor V1,\[Kappa]S1,V1,\[Rho]S2,\[Lambda],LTVarianceFactor V2,\[Kappa]S2,V2,\[Rho]S3,\[Lambda],LTVarianceFactor V3,\[Kappa]S3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D1YBiSuperLogNormalHestonFondamentalTransform[\[Rho]S1,\[Lambda],LTVarianceFactor V1,\[Kappa]S1,V1,\[Rho]S2,\[Lambda],LTVarianceFactor V2,\[Kappa]S2,V2,\[Rho]S3,\[Lambda],LTVarianceFactor V3,\[Kappa]S3,V3,\[Alpha]2,\[Beta]2,\[Tau]]},
{D2XXBiSuperLogNormalHestonFondamentalTransform[\[Rho]S1,\[Lambda],LTVarianceFactor V1,\[Kappa]S1,V1,\[Rho]S2,\[Lambda],LTVarianceFactor V2,\[Kappa]S2,V2,\[Rho]S3,\[Lambda],LTVarianceFactor V3,\[Kappa]S3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2YYBiSuperLogNormalHestonFondamentalTransform[\[Rho]S1,\[Lambda],LTVarianceFactor V1,\[Kappa]S1,V1,\[Rho]S2,\[Lambda],LTVarianceFactor V2,\[Kappa]S2,V2,\[Rho]S3,\[Lambda],LTVarianceFactor V3,\[Kappa]S3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2XYBiSuperLogNormalHestonFondamentalTransform[\[Rho]S1,\[Lambda],LTVarianceFactor V1,\[Kappa]S1,V1,\[Rho]S2,\[Lambda],LTVarianceFactor V2,\[Kappa]S2,V2,\[Rho]S3,\[Lambda],LTVarianceFactor V3,\[Kappa]S3,V3,\[Alpha]2,\[Beta]2,\[Tau]]}};
NormalTerminalcorrelT=\[Mu]XY/Sqrt[\[Mu]XX \[Mu]YY ];
(-1+\[ExponentialE]^(NormalTerminalcorrelT Sqrt[\[Mu]XX \[Mu]YY]))/Sqrt[(-1+\[ExponentialE]^\[Mu]XX) (-1+\[ExponentialE]^\[Mu]YY)]]


PackagedSmileBiSuperHestonLogNormalCorrelationFromV0[S1_,S2_,\[Tau]_,
VolS1_,VolS2_,Correl12_,V0_,\[Rho]S1_,\[Rho]S2_,\[Rho]S3_,\[Kappa]S1_,\[Kappa]S2_,\[Kappa]S3_,\[Lambda]_,LTVarianceFactor_]:=Module[{VarRealSpead,ExpcorreLT,\[Alpha]2,\[Beta]2,V1,V2,V3,VarExpX,VarExpY,LimVarDown,LimVarUp},
VarRealSpead=V0 ((-1+LTVarianceFactor+\[ExponentialE]^(\[Lambda] \[Tau]) (1+LTVarianceFactor (-1+\[Lambda] \[Tau])))/\[Lambda])\[ExponentialE]^(-\[Lambda] \[Tau]);
\[Beta]2=((1+Correl12)Sqrt[VolS2])/2;\[Alpha]2=(2Correl12)/(1+Correl12) Sqrt[VolS1];V1=VolS1-\[Alpha]2^2;V3=VolS2-\[Beta]2^2;V2=1;
VarExpX=LogHestonNormalVarianceProxy[\[Rho]S1,\[Lambda],LTVarianceFactor V1,\[Kappa]S1,V1,\[Rho]S2,\[Lambda],\[Alpha]2^2 LTVarianceFactor V2,\[Alpha]2 \[Kappa]S2,\[Alpha]2^2 V2,S1,\[Tau]];
VarExpY=LogHestonNormalVarianceProxy[\[Rho]S3,\[Lambda],LTVarianceFactor V3,\[Kappa]S3,V3,\[Rho]S2,\[Lambda],\[Beta]2 ^2 LTVarianceFactor V2,\[Beta]2 \[Kappa]S2,\[Beta]2^2 V2,S2,\[Tau]];
ExpcorreLT=(VarRealSpead-VarExpX-VarExpY)/((-2) Sqrt[VarExpX VarExpY]);
LimVarDown=(Sqrt[VarExpX]-Sqrt[VarExpY])^2;LimVarUp=(Sqrt[VarExpX]+Sqrt[VarExpY])^2;
{LimVarDown,LimVarUp,ExpcorreLT}]


PackagedSmileBiSuperHestonLogNormalImplicitCorrelationFromV0[S1_,S2_,\[Tau]_,
VolS1_,VolS2_,V0_,\[Rho]S1_,\[Rho]S2_,\[Rho]S3_,\[Kappa]S1_,\[Kappa]S2_,\[Kappa]S3_,\[Lambda]_,LTVarianceFactor_]:=Module[{x},
x/. FindRoot[PackagedSmileBiSuperHestonLogNormalCorrelation[S1,S2,\[Tau],
VolS1,VolS2,x,\[Rho]S1,\[Rho]S2,\[Rho]S3,\[Kappa]S1,\[Kappa]S2,\[Kappa]S3,\[Lambda],LTVarianceFactor]==
PackagedSmileBiSuperHestonLogNormalCorrelationFromV0[S1,S2,\[Tau],
VolS1,VolS2,x,V0,\[Rho]S1,\[Rho]S2,\[Rho]S3,\[Kappa]S1,\[Kappa]S2,\[Kappa]S3,\[Lambda],LTVarianceFactor][[3]],{x,0.8}]]



BiSuperHestonPackaging[VolS1_,VolS2_,Correl12_]:=Module[{\[Alpha]2,\[Beta]2,V1,V2,V3},
\[Beta]2=((1+Correl12)Sqrt[VolS2])/2;\[Alpha]2=(2Correl12)/(1+Correl12) Sqrt[VolS1];V1=VolS1-\[Alpha]2^2;V3=VolS2-\[Beta]2^2;
{\[Alpha]2,\[Beta]2,V1,V3}]


BiSuperHestonPackagingInverse[\[Alpha]2_,\[Beta]2_,V1_,V3_]:=Module[{VolS1,VolS2,Correl12},
VolS1=V1+\[Alpha]2^2;VolS2=V3+\[Beta]2^2;
Correl12=(2\[Beta]2)/Sqrt[V3+\[Beta]2^2]-1;(* ou bien Correl12=\[Alpha]2/(2 Sqrt[V1+\[Alpha]2^2]-\[Alpha]2); *)
{VolS1,VolS2,Correl12}]


phi[x_]:=Exp[-x^2/2]/Sqrt[2Pi]


Nd[x_]:=(Erf[x/Sqrt[2]]+1)/2


LogNormalSpreadDigitaleCall[S1_,S2_,sig1_,sig2_,rho_,k_,t_]:=NIntegrate[phi[x]Nd[-(Log[(k+S2 E^(-1/2 sig2^2 t+sig2 Sqrt[t] x))/(S1 E^(-1/2 sig1^2 t))]-rho sig1 Sqrt[t] x)/(Sqrt[1-rho^2] sig1 Sqrt[t])],{x,-\[Infinity],-1,+\[Infinity]}]


LogNormalSpreadDigitaleCall[S1_,S2_,sig1_,sig2_,rho_,k_,t_]:=CoeffBasedIntegrate[(Nd[-(Log[(k+S2 E^(-1/2 sig2^2 t+sig2 Sqrt[t] #))/(S1 E^(-1/2 sig1^2 t))]-rho sig1 Sqrt[t] #)/(Sqrt[1-rho^2] sig1 Sqrt[t])])&,ModifiedHermiteCoeffs[20]]


(* ::Input:: *)
MesureQTLogNormalSpreadDigitale[S1_,S2_,sig1_,sig2_,rho_,k_,t_]:=LogNormalSpreadDigitaleCall[S1 ,S2 ,sig1,sig2,rho,k,t]


(* ::Input:: *)
MesureQ1LogNormalSpreadDigitale[S1_,S2_,sig1_,sig2_,rho_,k_,t_]:=LogNormalSpreadDigitaleCall[S1 Exp[sig1^2 t],S2 Exp[rho sig1 sig2 t],sig1,sig2,rho,k,t]


(* ::Input:: *)
MesureQ2LogNormalSpreadDigitale[S1_,S2_,sig1_,sig2_,rho_,k_,t_]:=LogNormalSpreadDigitaleCall[S1 Exp[rho sig1 sig2 t],S2 Exp[sig2^2 t],sig1,sig2,rho,k,t]


(* ::Input:: *)
LogNormalSpreadOption[S1_,S2_,sig1_,sig2_,rho_,k_,t_]:=S1 MesureQ1LogNormalSpreadDigitale[S1,S2,sig1,sig2,rho,k,t]-S2 MesureQ2LogNormalSpreadDigitale[S1,S2,sig1,sig2,rho,k,t]-k MesureQTLogNormalSpreadDigitale[S1,S2,sig1,sig2,rho,k,t]


SmileBiSuperHestonVanillaSpreadOption[S1_,S2_, \[Rho]1_,\[Lambda]v1_,\[Theta]v1_,\[Kappa]1_,V1_,\[Rho]2_,\[Lambda]v2_,\[Theta]v2_,\[Kappa]2_,V2_,\[Rho]3_,\[Lambda]v3_,\[Theta]v3_,\[Kappa]3_,V3_,\[Alpha]2_,\[Beta]2_,LTFactorS_,\[Lambda]S_,SpreadStrikes_,\[Tau]_,LimitGindinkin_,printflag_]:=Module[{Z1,Z2,VarExpX,VarExpY,VarRealSpead,\[Rho]projet\[EAcute],\[Nu]projet\[EAcute],ExpcorreLT,driftVarVS,
\[Mu]X,\[Mu]Y,\[Mu]XX,\[Mu]YY,\[Mu]XY,\[Mu]XXX,\[Mu]XXY,\[Mu]XYY,\[Mu]YYY,\[Mu]XXXX,\[Mu]XXXY,\[Mu]XXYY,\[Mu]XYYY,\[Mu]YYYY,
\[Mu]1,\[Mu]2,\[Mu]3,\[Mu]4,V0Generateur,TrueIniVarSpread,x,prices,NormalTerminalcorrelT,\[Rho]model,VarVS,CoVarSVS,VS,\[Nu]final,\[Nu]normalized,Sig1,Sig2,Correl12,numinimum,\[Nu]brut,TrueImpliedCorr,rhominimum},

(*   determination de la correl  *)
{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}=
{{D1XBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D1YBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]},
{D2XXBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2YYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]],
D2XYBiSuperLogNormalHestonFondamentalTransform[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Theta]v2,\[Kappa]2,V2,\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Alpha]2,\[Beta]2,\[Tau]]}};
If[printflag==1 || MemberQ[printflag,1] ,Print["moments=",{{\[Mu]X,\[Mu]Y},{\[Mu]XX,\[Mu]YY,\[Mu]XY}}]];
NormalTerminalcorrelT=\[Mu]XY/Sqrt[\[Mu]XX \[Mu]YY ];
ExpcorreLT=CorrelationExponentialAdjuster[\[Mu]XX,\[Mu]YY,NormalTerminalcorrelT];

If[printflag==1 || MemberQ[printflag,1] ,Print["NormalTerminalcorrelT=",NormalTerminalcorrelT," ExpcorreLT=",ExpcorreLT]];
(* determination de la variance *)
VarExpX=LogHestonNormalVarianceProxy[\[Rho]1,\[Lambda]v1,\[Theta]v1,\[Kappa]1,V1,\[Rho]2,\[Lambda]v2,\[Alpha]2^2 \[Theta]v2,\[Alpha]2 \[Kappa]2,\[Alpha]2^2 V2,S1,\[Tau]];
VarExpY=LogHestonNormalVarianceProxy[\[Rho]3,\[Lambda]v3,\[Theta]v3,\[Kappa]3,V3,\[Rho]2,\[Lambda]v2,\[Beta]2 ^2 \[Theta]v2,\[Beta]2 \[Kappa]2,\[Beta]2^2 V2,S2,\[Tau]];
If[printflag==1 || MemberQ[printflag,1] ,Print["VarExpX=",VarExpX," VarExpY=",VarExpY]];
VarRealSpead=VarExpX+VarExpY-2ExpcorreLT Sqrt[VarExpX VarExpY];
If[printflag==1 || MemberQ[printflag,1] ,Print["VarRealSpead (Goal)=",VarRealSpead]];

(* determination de la variance normale initiale equvalente *)
TrueIniVarSpread=(\[ExponentialE]^(\[Lambda]S \[Tau]) VarRealSpead \[Lambda]S)/(-1+LTFactorS+\[ExponentialE]^(\[Lambda]S \[Tau]) (1+LTFactorS (-1+\[Lambda]S \[Tau])));
If[printflag==1 || MemberQ[printflag,1] ,Print["TrueIniVarSpread=",TrueIniVarSpread]];

(* determination des parametres de smile initial grace au generateur*)
VarVS=S1^2 V1 (2 S1 (V1+V2 \[Alpha]2^2)-2 S2 V2 \[Alpha]2 \[Beta]2) (2 S1 V1+2 V2 \[Alpha]2 (S1 \[Alpha]2-S2 \[Beta]2)+S1 \[Kappa]1 \[Rho]1)+S1^3 V1 \[Kappa]1 (-2 S2 V2 \[Alpha]2 \[Beta]2 \[Rho]1+S1 (\[Kappa]1+2 (V1+V2 \[Alpha]2^2) \[Rho]1))+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2 ((S1 \[Alpha]2-S2 \[Beta]2)^2 \[Kappa]2+(2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) \[Rho]2)+V2 (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2)) (-2 S1 S2 \[Alpha]2 \[Beta]2 (V2 (\[Alpha]2+\[Beta]2)+\[Kappa]2 \[Rho]2)+S1^2 \[Alpha]2 (2 V1+\[Alpha]2 (2 V2 \[Alpha]2+\[Kappa]2 \[Rho]2))+S2^2 \[Beta]2 (2 V3+\[Beta]2 (2 V2 \[Beta]2+\[Kappa]2 \[Rho]2)))+S2^3 V3 \[Kappa]3 (-2 S1 V2 \[Alpha]2 \[Beta]2 \[Rho]3+S2 (\[Kappa]3+2 (V3+V2 \[Beta]2^2) \[Rho]3))+2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2)) (-2 S1 V2 \[Alpha]2 \[Beta]2+S2 (2 V3+2 V2 \[Beta]2^2+\[Kappa]3 \[Rho]3));
CoVarSVS=2 S1^2 V1 (S1 (V1+V2 \[Alpha]2^2)-S2 V2 \[Alpha]2 \[Beta]2)-2 S2^2 V3 (-S1 V2 \[Alpha]2 \[Beta]2+S2 (V3+V2 \[Beta]2^2))+V2 (S1 \[Alpha]2-S2 \[Beta]2) (2 S1^2 \[Alpha]2 (V1+V2 \[Alpha]2^2)-2 S1 S2 V2 \[Alpha]2 \[Beta]2 (\[Alpha]2+\[Beta]2)+2 S2^2 \[Beta]2 (V3+V2 \[Beta]2^2))+S1^3 V1 \[Kappa]1 \[Rho]1+V2 (S1 \[Alpha]2-S2 \[Beta]2)^3 \[Kappa]2 \[Rho]2-S2^3 V3 \[Kappa]3 \[Rho]3;

VS=S1^2 V1+S2^2 V3+V2 (S1 \[Alpha]2-S2 \[Beta]2)^2;

driftVarVS=2 (S1^4 (12 V1^4+12 V1^3 (4 V2 \[Alpha]2^2+\[Kappa]1 \[Rho]1)+V2 \[Alpha]2^5 (12 V2^3 \[Alpha]2^3+9 V2 \[Alpha]2 \[Kappa]2^2+12 V2^2 \[Alpha]2^2 \[Kappa]2 \[Rho]2+2 \[Kappa]2^3 \[Rho]2)+
3 V1^2 (24 V2^2 \[Alpha]2^4+3 \[Kappa]1^2+4 V2 \[Alpha]2^2 (2 \[Kappa]1 \[Rho]1+\[Alpha]2 \[Kappa]2 \[Rho]2))+V1 (48 V2^3 \[Alpha]2^6+9 V2 \[Alpha]2^2 (\[Kappa]1^2+\[Alpha]2^2 \[Kappa]2^2)+2 \[Kappa]1^3 \[Rho]1+12 V2^2 \[Alpha]2^4 (\[Kappa]1 \[Rho]1+2 \[Alpha]2 \[Kappa]2 \[Rho]2)))-S1^3 S2 V2 \[Alpha]2 \[Beta]2 (12 V1^3+6 V1^2 (3 V2 \[Alpha]2 (2 \[Alpha]2+\[Beta]2)+\[Kappa]1 \[Rho]1+2 \[Alpha]2 \[Kappa]2 \[Rho]2)+\[Alpha]2^2 (6 V2^3 \[Alpha]2^2 (2 \[Alpha]2^2+3 \[Alpha]2 \[Beta]2+\[Beta]2^2)+3 V2 \[Alpha]2 (6 \[Alpha]2+5 \[Beta]2) \[Kappa]2^2+3 V2^2 \[Alpha]2 (6 \[Alpha]2^2+5 \[Alpha]2 \[Beta]2+\[Beta]2^2) \[Kappa]2 \[Rho]2+2 (3 \[Alpha]2+\[Beta]2) \[Kappa]2^3 \[Rho]2)+V1 (6 V2^2 \[Alpha]2^2 (6 \[Alpha]2^2+6 \[Alpha]2 \[Beta]2+\[Beta]2^2)+4 \[Kappa]1^2+2 \[Alpha]2 (7 \[Alpha]2+2 \[Beta]2) \[Kappa]2^2+3 V2 \[Alpha]2 (2 \[Alpha]2 \[Kappa]1 \[Rho]1+\[Beta]2 \[Kappa]1 \[Rho]1+10 \[Alpha]2^2 \[Kappa]2 \[Rho]2+4 \[Alpha]2 \[Beta]2 \[Kappa]2 \[Rho]2)))+S1^2 S2^2 V2 \[Alpha]2 \[Beta]2 (2 V1^2 (2 V3+\[Beta]2 (V2 \[Alpha]2+2 V2 \[Beta]2+\[Kappa]2 \[Rho]2))+V1 (4 V3^2+2 V3 (V2 (4 \[Alpha]2^2+6 \[Alpha]2 \[Beta]2+4 \[Beta]2^2)+(\[Alpha]2+\[Beta]2) \[Kappa]2 \[Rho]2)+\[Beta]2 (4 V2^2 (\[Alpha]2^3+4 \[Alpha]2^2 \[Beta]2+3 \[Alpha]2 \[Beta]2^2+\[Beta]2^3)+(5 \[Alpha]2+4 \[Beta]2) \[Kappa]2^2+2 V2 (4 \[Alpha]2^2+5 \[Alpha]2 \[Beta]2+\[Beta]2^2) \[Kappa]2 \[Rho]2))+\[Alpha]2 (2 V2^3 \[Beta]2 (\[Alpha]2+\[Beta]2)^2 (\[Alpha]2^2+4 \[Alpha]2 \[Beta]2+\[Beta]2^2)+2 V2^2 (2 V3 (\[Alpha]2^3+3 \[Alpha]2^2 \[Beta]2+4 \[Alpha]2 \[Beta]2^2+\[Beta]2^3)+3 \[Beta]2 (\[Alpha]2+\[Beta]2)^3 \[Kappa]2 \[Rho]2)+V2 (2 V3^2 (2 \[Alpha]2+\[Beta]2)+3 \[Beta]2 (3 \[Alpha]2^2+10 \[Alpha]2 \[Beta]2+3 \[Beta]2^2) \[Kappa]2^2+2 V3 (\[Alpha]2^2+5 \[Alpha]2 \[Beta]2+4 \[Beta]2^2) \[Kappa]2 \[Rho]2)+\[Kappa]2 (V3 (4 \[Alpha]2+5 \[Beta]2) \[Kappa]2+2 V3^2 \[Rho]2+6 \[Beta]2 (\[Alpha]2+\[Beta]2) \[Kappa]2^2 \[Rho]2)))+S2^4 (12 V3^4+V2 \[Beta]2^5 (12 V2^3 \[Beta]2^3+9 V2 \[Beta]2 \[Kappa]2^2+12 V2^2 \[Beta]2^2 \[Kappa]2 \[Rho]2+2 \[Kappa]2^3 \[Rho]2)+12 V3^3 (4 V2 \[Beta]2^2+\[Kappa]3 \[Rho]3)+V3 (48 V2^3 \[Beta]2^6+9 V2 \[Beta]2^2 (\[Beta]2^2 \[Kappa]2^2+\[Kappa]3^2)+2 \[Kappa]3^3 \[Rho]3+12 V2^2 \[Beta]2^4 (2 \[Beta]2 \[Kappa]2 \[Rho]2+\[Kappa]3 \[Rho]3))+3 V3^2 (24 V2^2 \[Beta]2^4+3 \[Kappa]3^2+4 V2 \[Beta]2^2 (\[Beta]2 \[Kappa]2 \[Rho]2+2 \[Kappa]3 \[Rho]3)))-S1 S2^3 V2 \[Alpha]2 \[Beta]2 (12 V3^3+\[Beta]2^2 (6 V2^3 \[Beta]2^2 (\[Alpha]2^2+3 \[Alpha]2 \[Beta]2+2 \[Beta]2^2)+3 V2 \[Beta]2 (5 \[Alpha]2+6 \[Beta]2) \[Kappa]2^2+3 V2^2 \[Beta]2 (\[Alpha]2^2+5 \[Alpha]2 \[Beta]2+6 \[Beta]2^2) \[Kappa]2 \[Rho]2+2 (\[Alpha]2+3 \[Beta]2) \[Kappa]2^3 \[Rho]2)+6 V3^2 (3 V2 \[Beta]2 (\[Alpha]2+2 \[Beta]2)+2 \[Beta]2 \[Kappa]2 \[Rho]2+\[Kappa]3 \[Rho]3)+V3 (6 V2^2 \[Beta]2^2 (\[Alpha]2^2+6 \[Alpha]2 \[Beta]2+6 \[Beta]2^2)+4 \[Alpha]2 \[Beta]2 \[Kappa]2^2+14 \[Beta]2^2 \[Kappa]2^2+4 \[Kappa]3^2+3 V2 \[Beta]2 (4 \[Alpha]2 \[Beta]2 \[Kappa]2 \[Rho]2+10 \[Beta]2^2 \[Kappa]2 \[Rho]2+\[Alpha]2 \[Kappa]3 \[Rho]3+2 \[Beta]2 \[Kappa]3 \[Rho]3))));

If[printflag==1 || MemberQ[printflag,1] ,Print["VS=",VS," VarVS=",VarVS," CoVarSVS=",CoVarSVS," driftVarVS=",driftVarVS]];
\[Rho]projet\[EAcute]=CoVarSVS/Sqrt[VS VarVS];\[Nu]projet\[EAcute]=Sqrt[VarVS/VS];

(* ajustement du kurtosis par effet de vol *)
\[Nu]brut= \[Nu]projet\[EAcute] Sqrt[VS/VarRealSpead];\[Nu]normalized=\[Nu]brut/Sqrt[TrueIniVarSpread];
Sig1=Sqrt[\[Alpha]2^2 V2+V1];Sig2=Sqrt[\[Beta]2^2 V2+V3];Correl12=\[Alpha]2 \[Beta]2 V2/(Sig1 Sig2);
Print[" {Numinimum,\[Rho]minimim}=",Timing[{numinimum,rhominimum}=NuRhoMinimunNormalHestonFromBilog[S1,S2,Sig1,Sig2,Correl12,\[Tau],\[Rho]projet\[EAcute],\[Lambda]S,LTFactorS ]]];
\[Nu]final=\[Nu]brut+numinimum;
If[printflag==1 || MemberQ[printflag,1] ,Print["\[Rho]projet\[EAcute]=",rhominimum," \[Nu]projet\[EAcute]=",\[Nu]projet\[EAcute]," \[Nu]brut=",\[Nu]brut," \[Nu]final/\[Nu]projet\[EAcute]=",\[Nu]final/\[Nu]projet\[EAcute]," \[Nu]normalized=",\[Nu]normalized]];
If[printflag==1 || MemberQ[printflag,1] ,Print["Normal Heston Parameters=",{{"S0",S1-S2},{"V0",TrueIniVarSpread},{"\[Theta]",LTFactorS TrueIniVarSpread},{"\[Lambda]v",\[Lambda]S},{"\[Rho]",rhominimum},{"\[Nu]",\[Nu]final},
{"\[Nu] normalized",\[Nu]final/Sqrt[TrueIniVarSpread]},{"standard dev equi.",Sqrt[TrueIniVarSpread]}} //MatrixForm]];


prices=TransHestonNormalCall[rhominimum,\[Lambda]S,LTFactorS TrueIniVarSpread,\[Nu]final,TrueIniVarSpread,S1-S2,SpreadStrikes,\[Tau],LimitGindinkin];
If[printflag==1 || MemberQ[printflag,1] ,Print["prices=",prices]];
prices
]


NuRhoV0MinimunNormalHestonFromBilog[S1_,S2_,sig1_,sig2_,Correl12_,\[Tau]_,\[Rho]_,\[Lambda]v_,LT_]:=
Module[{convexity,convexityTable,VS,DeltaS=0.005,\[Kappa]table,\[Kappa],\[Kappa]inter,prices,\[Kappa]sol,opt1,opt2,opt3,vol1,vol2,vol3,
pente,vols,\[Rho]table,penteTable,\[Rho]inter,\[Rho]sol,\[Rho]s,V0Table,V0inter,V0sol,V0},
opt1=LogNormalSpreadOption[S1,S2,sig1,sig2,Correl12,S1-S2-DeltaS,\[Tau]];
opt2=LogNormalSpreadOption[S1,S2,sig1,sig2,Correl12,S1-S2+DeltaS,\[Tau]];
opt3=LogNormalSpreadOption[S1,S2,sig1,sig2,Correl12,S1-S2,\[Tau]];
vol1=NormalImplicitVol[S1-S2,S1-S2-DeltaS,\[Tau],opt1];
vol2=NormalImplicitVol[S1-S2,S1-S2,\[Tau],opt3];
vol3=NormalImplicitVol[S1-S2,S1-S2+DeltaS,\[Tau],opt2];
Print["opt1=",opt1," opt2=",opt2," opt3=",opt3];
convexity=vol1+vol3-2*vol2;
pente=vol3-vol1;
Print["convexity=",convexity, " pente=",pente," ATMprix=",opt3];
VS=S1^2 sig1^2+S2^2 sig2^2-2 S1 S2 sig1 sig2  Correl12;
\[Kappa]table={0.0005,0.001,0.002,0.003,0.01};
prices=Timing[Table[{\[Kappa]table[[i]],HestonNormalCall[\[Rho],\[Lambda]v,LT VS,\[Kappa]table[[i]],VS,S1-S2,{S1-S2-DeltaS,S1-S2,S1-S2+DeltaS},\[Tau]]},{i,1,Length[\[Kappa]table]}]];
vols=Map[({#[[1]],
{NormalImplicitVol[S1-S2,S1-S2-DeltaS,\[Tau],#[[2,1]]],
NormalImplicitVol[S1-S2,S1-S2,\[Tau],#[[2,2]]],
NormalImplicitVol[S1-S2,S1-S2+DeltaS,\[Tau],#[[2,3]]]}})&,
prices[[2]]];
convexityTable=Map[({#[[1]],#[[2,1]]+#[[2,3]]-2#[[2,2]]})&,vols];
\[Kappa]inter=Interpolation[convexityTable];
Print["convexityTable=",convexityTable // MatrixForm];
\[Kappa]sol=\[Kappa] /. FindRoot[\[Kappa]inter[\[Kappa]]==convexity,{\[Kappa],0.002,0.0005,0.01}];
\[Rho]table={-0.8,-0.6,-0.4,-0.2,0,0.5,0.8};
prices=Timing[Table[{\[Rho]table[[i]],HestonNormalCall[\[Rho]table[[i]],\[Lambda]v,LT VS,\[Kappa]sol,VS,S1-S2,{S1-S2-DeltaS,S1-S2+DeltaS},\[Tau]]},{i,1,Length[\[Rho]table]}]];
Print["prices=",prices];
vols=Map[({#[[1]],
{NormalImplicitVol[S1-S2,S1-S2-DeltaS,\[Tau],#[[2,1]]],
NormalImplicitVol[S1-S2,S1-S2+DeltaS,\[Tau],#[[2,2]]]}})&,
prices[[2]]];
Print["vols=",vols];
penteTable=Map[({#[[1]],#[[2,2]]-#[[2,1]]})&,vols];
\[Rho]inter=Interpolation[penteTable];
Print["penteTable=",penteTable // MatrixForm];
\[Rho]sol=\[Rho]s /. FindRoot[\[Rho]inter[\[Rho]s]==pente,{\[Rho]s,0.,-0.8,0.8}];
V0Table={0.1 VS,0.8 VS,0.9 VS, 1.5 VS,5 VS};
prices=Table[{V0Table[[i]],HestonNormalCall[\[Rho]sol,\[Lambda]v,LT V0Table[[i]],\[Kappa]sol,V0Table[[i]],S1-S2,S1-S2,\[Tau]]},{i,1,Length[V0Table]}];
Print["VOptionATM=",prices // MatrixForm];
V0inter=Interpolation[prices];
V0sol=V0 /. FindRoot[V0inter[V0]==opt3,{V0,0.1 VS,5 VS}];
{\[Kappa]sol,\[Rho]sol,V0sol}]



