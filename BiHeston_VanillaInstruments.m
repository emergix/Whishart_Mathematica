(* ::Package:: *)

(************************************************************************)
(* This file was generated automatically by the Mathematica front end.  *)
(* It contains Initialization cells from a Notebook file, which         *)
(* typically will have the same name as this file except ending in      *)
(* ".nb" instead of ".m".                                               *)
(*                                                                      *)
(* This file is intended to be loaded into the Mathematica kernel using *)
(* the package loading commands Get or Needs.  Doing so is equivalent   *)
(* to using the Evaluate Initialization Cells menu command in the front *)
(* end.                                                                 *)
(*                                                                      *)
(* DO NOT EDIT THIS FILE.  This entire file is regenerated              *)
(* automatically each time the parent Notebook file is saved in the     *)
(* Mathematica front end.  Any changes you make to this file will be    *)
(* overwritten.                                                         *)
(************************************************************************)



<< "C:\\Documents and Settings\\ocroissant\\My Documents\\BiHeston\\BiHeston_CompiledFunctions.m"


SmileBiHestonVanilla[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,Q,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"VanillaSpreadoption",printflag];
KListPositive=Select[KList,#>=0&];KListNegative=Select[KList,#<0&];
If[Length[KListPositive]>0,KPositivePrices=SmileBiHestonVanillaPositiveK[S,\[Alpha]1,\[Beta]1,a,b,KListPositive,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag]];
If[(printflag==1)||(MemberQ[printflag ,1]),Print["Fin partie positive"]];
If[Length[KListNegative]>0,KNegativePrices=SmileBiHestonVanillaNegativeK[S,\[Alpha]1,\[Beta]1,a,b,KListNegative,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag]];
prices=Join[KNegativePrices,KPositivePrices];
Table[Max[\[Alpha]1 S[[1]]^a-\[Beta]1 S[[2]]^b-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


SmileBiHestonVanilla3[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor,\[CapitalSigma]inf},
\[CapitalSigma]inf=\[CapitalSigma]inf=SolveSymetricEquation[M,-2\[Beta]^2 Transpose[Q].Q] ;
If[Length[KList1]==0,KList={KList1},KList=KList1];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"VanillaSpreadoption",printflag];
KListPositive=Select[KList,#>=0&];KListNegative=Select[KList,#<0&];
If[Length[KListPositive]>0,KPositivePrices=SmileBiHestonVanillaPositiveK[S,\[Alpha]1,\[Beta]1,a,b,KListPositive,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag]];
If[(printflag==1)||(MemberQ[printflag ,1]),Print["Fin partie positive"]];
If[Length[KListNegative]>0,KNegativePrices=SmileBiHestonVanillaNegativeK[S,\[Alpha]1,\[Beta]1,a,b,KListNegative,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag]];
prices=Join[KNegativePrices,KPositivePrices];
Table[Max[\[Alpha]1 S[[1]]^a-\[Beta]1 S[[2]]^b-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


TestBiHestonVanilla[S_,\[Alpha]1_,\[Beta]1_,a_,b_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,scope_]:=
Module[{KList,Q,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
Plot[SmileSymetrizedBiHestonVanillaIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2scope},PlotPoints->50,PlotRange->All,PlotLabel->"Integrand spreadoption : K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


Test2BiHestonVanilla[S_,\[Alpha]1_,\[Beta]1_,a_,b_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_},scope_]:=Module[{period,Q,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]},tt,Y0},
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
period=scope;
Y0=AdaptativeIntegrate[Function[\[Omega]1,SmileSymetrizedBiHestonVanillaIntegrandCC[Y,\[Alpha]1,\[Beta]1,a,b,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,0][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax][[2]];
tt=Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonVanillaIntegrandCC[Y,\[Alpha]1,\[Beta]1,a,b,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period,period/100}];
ListPlot[tt,Joined->True,PlotLabel->"U1:2nd Inv. Fourier:",PlotRange->All]]


SmileBiHestonVanilla2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},\[Beta]m,prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"VanillaSpreadoption",printflag];
KListPositive=Select[KList,#>=0&];KListNegative=Select[KList,#<0&];
If[Length[KListPositive]>0,KPositivePrices=SmileBiHestonVanillaPositiveK2[S,\[Alpha]1,\[Beta]1,a,b,KListPositive,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag]];
If[(printflag==1)||(MemberQ[printflag ,1]),Print["Fin partie positive"]];
If[Length[KListNegative]>0,KNegativePrices=SmileBiHestonVanillaNegativeK2[S,\[Alpha]1,\[Beta]1,a,b,KListNegative,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag]];
prices=Join[KNegativePrices,KPositivePrices];
Table[Max[\[Alpha]1 S[[1]]^a-\[Beta]1 S[[2]]^b-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


TestBiHestonVanilla2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,scope_]:=
Module[{KList,\[Beta]m,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
Plot[SmileSymetrizedBiHestonVanillaIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2scope},PlotPoints->50,PlotRange->All,PlotLabel->"Integrand spreadoption : K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


Test2BiHestonVanilla2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_},scope_]:=Module[{period,\[Beta]m,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]},tt,Y0},
\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
period=scope;
Y0=AdaptativeIntegrate[Function[\[Omega]1,SmileSymetrizedBiHestonVanillaIntegrand2CC[Y,\[Alpha]1,\[Beta]1,a,b,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,0][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax][[2]];
tt=Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonVanillaIntegrand2CC[Y,\[Alpha]1,\[Beta]1,a,b,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period,period/100}];
ListPlot[tt,Joined->True,PlotLabel->"U1:2nd Inv. Fourier:",PlotRange->All]]


SmileBiHestonVanillaPositiveK[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=SmileBiHestonVanillaAux[S,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag]


SmileBiHestonVanillaNegativeK[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=SmileBiHestonVanillaAux[S,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag]+S[[1]]-S[[2]]-KList


SmileBiHestonVanillaPositiveK2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=SmileBiHestonVanillaAux2[S,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag]


SmileBiHestonVanillaNegativeK2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=SmileBiHestonVanillaAux2[S,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag]+S[[1]]-S[[2]]-KList


PlotRangeScale=100


SmileBiHestonVanillaAux[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]=",\[Beta]," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2 || MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]=",BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonVanillaIntegrandCC[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonVanillaIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period1},PlotPoints->50,PlotRange->All,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==5|| MemberQ[printflag,5] ,Print[Table[Plot[SmileSymetrizedBiHestonVanillaIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period1},PlotPoints->50,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1],PlotRange->{-PlotRangeScale,PlotRangeScale}],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonVanillaIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,2period2,period2/30}],Joined->True,PlotLabel->"2nd Inverse Fourier:",PlotRange->All]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonVanillaIntegrandCC[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["code integ 2 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"];
Print["code integ 1 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,as=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonVanillaIntegrandCC[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==7|| MemberQ[printflag,7],Print["\[Omega]2=",\[Omega]2," Integ_2=",as]];as[[2]]],LegendreCoef2,LegendreCoef1n,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==7|| MemberQ[printflag,7],Print["Integ_1=",res]];
res[[2]]]


SmileBiHestonVanillaAux2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]m=",\[Beta]m // MatrixForm," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2|| MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]=",BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonVanillaIntegrand2CC[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonVanillaIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period1},PlotPoints->50,PlotRange->All,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonVanillaIntegrand2CC[Y,\[Alpha]1,\[Beta]1,a,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period2,period2/30}],Joined->True,PlotLabel->"2nd Inverse Fourier:",PlotRange->All]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonVanillaIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["code integ 2 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"];
Print["code integ 1 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,as=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonVanillaIntegrand2CC[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==7|| MemberQ[printflag,7],Print["\[Omega]2=",\[Omega]2," Integ_2=",as]];as[[2]]],LegendreCoef2,LegendreCoef1n,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==2,Print["Integ_1=",res]];
res[[2]]]


SmileSymetrizedBiHestonVanillaIntegrand[Y_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],k1=(\[Omega]1+\[ImaginaryI] \[Lambda]1),Sk1=(-\[Omega]1+\[ImaginaryI] \[Lambda]1),k2= (\[Omega]2+\[ImaginaryI] \[Lambda]2),Sk2= (-\[Omega]2+\[ImaginaryI] \[Lambda]2),Sk1A=(-\[Omega]1+\[ImaginaryI] \[Lambda]1),k1A=(\[Omega]1-\[ImaginaryI] \[Lambda]1),k2A=(\[Omega]2-\[ImaginaryI] \[Lambda]2),\[Alpha],\[Alpha]A,Sym\[Alpha],Sym\[Alpha]A,\[Alpha]2,\[Alpha]A2,Sym\[Alpha]2,Sym\[Alpha]A2,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
Re[If[KList[[1]]>=0,
\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 k1-\[ImaginaryI] x2 k2);\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 k1-\[ImaginaryI] x2 k2A);Sym\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1-\[ImaginaryI] x2 k2);Sym\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1A-\[ImaginaryI] x2 k2A);
propagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2},\[Beta],\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1,-\[ImaginaryI] k2},\[Beta],\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2A},\[Beta],\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1A,-\[ImaginaryI] k2A},\[Beta],\[Tau]];
Table[If[KList[[i]]>0,\[Alpha] propagatorDroit VanillaPayOffFourierDroite[k1,k2,KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha] SympropagatorDroit VanillaPayOffFourierDroite[Sk1,k2,KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
\[Alpha]A propagatorGauche VanillaPayOffFourierGauche[k1,k2A,KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha]A SympropagatorGauche VanillaPayOffFourierGauche[Sk1A,k2A,KList[[i]],\[Alpha]1,\[Beta]1,a,b],
\[Alpha] propagatorDroit VanillaPayOffFourierDroite[k1,k2,\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha] SympropagatorDroit VanillaPayOffFourierDroite[Sk1,k2,\[Alpha]1,\[Beta]1,a,b]+
\[Alpha]A propagatorGauche VanillaPayOffFourierGauche[k1,k2A,\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha]A SympropagatorGauche VanillaPayOffFourierGauche[Sk1,k2A,\[Alpha]1,\[Beta]1,a,b]],{i,1,Length[KList]}],
\[Alpha]2=\[ExponentialE]^(-\[ImaginaryI] x2 k1-\[ImaginaryI] x1 k2);\[Alpha]A2=\[ExponentialE]^(-\[ImaginaryI] x2 k1-\[ImaginaryI] x1 k2A);Sym\[Alpha]2=\[ExponentialE]^(-\[ImaginaryI] x2 Sk1-\[ImaginaryI] x1 k2);Sym\[Alpha]A2=\[ExponentialE]^(-\[ImaginaryI] x2 Sk1A-\[ImaginaryI] x1 k2A);
propagatorDroit2=BiHestonLaplaceQuickTransformReverse[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2},\[Beta],\[Tau]];SympropagatorDroit2=BiHestonLaplaceQuickTransformReverse[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1,-\[ImaginaryI] k2},\[Beta],\[Tau]];
propagatorGauche2=BiHestonLaplaceQuickTransformReverse[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2A},\[Beta],\[Tau]];SympropagatorGauche2=BiHestonLaplaceQuickTransformReverse[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1A,-\[ImaginaryI] k2A},\[Beta],\[Tau]];Table[(\[Alpha]2 (propagatorDroit2 (VanillaPayOffFourierDroite[k1,k2,-KList[[i]],\[Alpha]1,\[Beta]1,a,b]))+Sym\[Alpha]2 (SympropagatorDroit2 (VanillaPayOffFourierDroite[Sk1,k2,-KList[[i]],\[Alpha]1,\[Beta]1,a,b]))) +
(\[Alpha]A2 propagatorGauche2 ( VanillaPayOffFourierGauche[k1,k2A,-KList[[i]],\[Alpha]1,\[Beta]1,a,b])+Sym\[Alpha]A2 SympropagatorGauche2 (VanillaPayOffFourierGauche[Sk1A,k2A,-KList[[i]],\[Alpha]1,\[Beta]1,a,b])),{i,1,Length[KList]}]
]]]


SmileSymetrizedBiHestonVanillaIntegrand2[Y_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],k1=(\[Omega]1+\[ImaginaryI] \[Lambda]1),Sk1=(-\[Omega]1+\[ImaginaryI] \[Lambda]1),k2= (\[Omega]2+\[ImaginaryI] \[Lambda]2),Sk2= (-\[Omega]2+\[ImaginaryI] \[Lambda]2),Sk1A=(-\[Omega]1+\[ImaginaryI] \[Lambda]1),k1A=(\[Omega]1-\[ImaginaryI] \[Lambda]1),k2A=(\[Omega]2-\[ImaginaryI] \[Lambda]2),\[Alpha],\[Alpha]A,Sym\[Alpha],Sym\[Alpha]A,\[Alpha]2,\[Alpha]A2,Sym\[Alpha]2,Sym\[Alpha]A2,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
Re[If[KList[[1]]>=0,
\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 k1-\[ImaginaryI] x2 k2);\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 k1-\[ImaginaryI] x2 k2A);Sym\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1-\[ImaginaryI] x2 k2);Sym\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1A-\[ImaginaryI] x2 k2A);
propagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2},\[Beta]m,\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1,-\[ImaginaryI] k2},\[Beta]m,\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2A},\[Beta]m,\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1A,-\[ImaginaryI] k2A},\[Beta]m,\[Tau]];

Table[If[KList[[i]]>0,\[Alpha] propagatorDroit VanillaPayOffFourierDroite[k1,k2,KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha] SympropagatorDroit VanillaPayOffFourierDroite[Sk1,k2,KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
\[Alpha]A propagatorGauche VanillaPayOffFourierGauche[k1,k2A,KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha]A SympropagatorGauche VanillaPayOffFourierGauche[Sk1A,k2A,KList[[i]],\[Alpha]1,\[Beta]1,a,b],
\[Alpha] propagatorDroit VanillaPayOffFourierDroite[k1,k2,\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha] SympropagatorDroit VanillaPayOffFourierDroite[Sk1,k2,\[Alpha]1,\[Beta]1,a,b]+
\[Alpha]A propagatorGauche VanillaPayOffFourierGauche[k1,k2A,\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha]A SympropagatorGauche VanillaPayOffFourierGauche[Sk1,k2A,\[Alpha]1,\[Beta]1,a,b]],{i,1,Length[KList]}],
\[Alpha]2=\[ExponentialE]^(-\[ImaginaryI] x2 k1-\[ImaginaryI] x1 k2);\[Alpha]A2=\[ExponentialE]^(-\[ImaginaryI] x2 k1-\[ImaginaryI] x1 k2A);Sym\[Alpha]2=\[ExponentialE]^(-\[ImaginaryI] x2 Sk1-\[ImaginaryI] x1 k2);Sym\[Alpha]A2=\[ExponentialE]^(-\[ImaginaryI] x2 Sk1A-\[ImaginaryI] x1 k2A);
propagatorDroit2=BiHestonLaplaceQuickTransformReverse2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2},\[Beta]m,\[Tau]];SympropagatorDroit2=BiHestonLaplaceQuickTransformReverse2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1,-\[ImaginaryI] k2},\[Beta]m,\[Tau]];
propagatorGauche2=BiHestonLaplaceQuickTransformReverse2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2A},\[Beta]m,\[Tau]];SympropagatorGauche2=BiHestonLaplaceQuickTransformReverse2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1A,-\[ImaginaryI] k2A},\[Beta]m,\[Tau]];Table[(\[Alpha]2 (propagatorDroit2 (VanillaPayOffFourierDroite[k1,k2,-KList[[i]],\[Alpha]1,\[Beta]1,a,b]))+Sym\[Alpha]2 (SympropagatorDroit2 (VanillaPayOffFourierDroite[Sk1,k2,-KList[[i]],\[Alpha]1,\[Beta]1,a,b]))) +
(\[Alpha]A2 propagatorGauche2 ( VanillaPayOffFourierGauche[k1,k2A,-KList[[i]],\[Alpha]1,\[Beta]1,a,b])+Sym\[Alpha]A2 SympropagatorGauche2 (VanillaPayOffFourierGauche[Sk1A,k2A,-KList[[i]],\[Alpha]1,\[Beta]1,a,b])),{i,1,Length[KList]}]
]]]


VanillaPayOffFourierDroite[k1_,k2_,\[Alpha]_,\[Beta]_,a_,b_]:=(-a^2 \[Beta] (\[Beta]/\[Alpha])^((\[ImaginaryI] k1)/a))/((\[ImaginaryI] a-k1) k1 (a b+\[ImaginaryI] b k1+\[ImaginaryI] a k2))


VanillaPayOffFourierGauche[k1_,k2_,\[Alpha]_,\[Beta]_,a_,b_]:=(a^2 \[Beta] (\[Beta]/\[Alpha])^((\[ImaginaryI] k1)/a))/((\[ImaginaryI] a-k1) k1 (a b+\[ImaginaryI] b k1+\[ImaginaryI] a k2))


VanillaPayOffFourierDroite[k1_,k2_,K_,\[Alpha]_,\[Beta]_,a_,b_]:=Module[{q,A=(\[ImaginaryI] k1)/a},q=A+(\[ImaginaryI] k2)/b;(\[ImaginaryI]    ((\[Beta]/\[Alpha])^A) )/((1+A) k1 b) ( \[Beta] (Hypergeometric2F1[-A,-1-q,-q,-( K/\[Beta])]/(1+q))+K  (  Hypergeometric2F1[-A,-q,1-q,-( K/\[Beta])]/(q)))]


VanillaPayOffFourierGauche[k1_,k2_,K_,\[Alpha]_,\[Beta]_,a_,b_]:=Module[{H,q=(\[ImaginaryI] k2)/b,m=(\[ImaginaryI] k1)/a,g1,g2,Kp=K/\[Beta]},H= Gamma[-1-m-q] Gamma[1+q]/Gamma[-m];g1=(Kp)^q;g2=(Kp)^-m;
-(\[ImaginaryI]/(b (1+m) k1 k2 (1+q))) (K/\[Alpha])^m (k2 \[Beta] (Kp g1 H (1+q)+(g2 (1+q)  Hypergeometric2F1[-m,-1-m-q,-m-q,-Kp])/(1+m+q))+K (-\[ImaginaryI] b+k2) (g1  H (-1-m-q) +(g2 q Hypergeometric2F1[-m,-m-q,1-m-q,-Kp])/(m+q)))]


SmileBiHestonUnderlying1Vanilla[S_,\[Alpha]1_,a_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,Q,prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,1,a,1,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"Underlying1Option",printflag];
prices=SmileBiHestonUnderlying1Vanilla[S,\[Alpha]1,a,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Max[\[Alpha]1 S[[1]]^a-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


SmileBiHestonUnderlying1Vanilla2[S_,\[Alpha]1_,a_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,\[Beta]m,prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,1,a,1,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"Underlying1Option",printflag];
\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
prices=SmileBiHestonUnderlying1Vanilla2[S,\[Alpha]1,a,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Max[\[Alpha]1 S[[1]]^a-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


SmileBiHestonUnderlying1Vanilla3[S_,\[Alpha]1_,a_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor,\[CapitalSigma]inf},\[CapitalSigma]inf=SolveSymetricEquation[M,-2\[Beta]^2 Transpose[Q].Q] ;
If[Length[KList1]==0,KList={KList1},KList=KList1];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,1,a,1,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"Underlying1Option",printflag];
prices=SmileBiHestonUnderlying1Vanilla[S,\[Alpha]1,a,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Max[\[Alpha]1 S[[1]]^a-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


TestBiHestonUnderlying1Vanilla[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,period_]:=
Module[{Q,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
Plot[SmileSymetrizedBiHestonUnderlying1VanillaIntegrandCC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period},PlotPoints->50,PlotRange->{-0.5,0.5},PlotLabel->"Integrand Underlying 1: K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


TestBiHestonUnderlying1Vanilla3[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,period_]:=
Module[{as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
Plot[SmileSymetrizedBiHestonUnderlying1VanillaIntegrandCC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period},PlotPoints->50,PlotRange->{-0.5,0.5},PlotLabel->"Integrand Underlying 1: K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


Test2BiHestonUnderlying1Vanilla[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_},period_]:=Module[{Q,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]},tt},
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
tt=Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying1VanillaIntegrandCC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period,period/100}];
ListPlot[tt,Joined->True,PlotLabel->"U1:2nd Inv. Fourier:",PlotRange->All]]


TestBiHestonUnderlying1Vanilla2[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,period_]:=
Module[{\[Beta]m,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
Plot[SmileSymetrizedBiHestonUnderlying1VanillaIntegrand2CC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period},PlotPoints->50,PlotRange->{-0.5,0.5},PlotLabel->"Integrand Underlying 1: K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


Test2BiHestonUnderlying1Vanilla2[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_},period_]:=Module[{\[Beta]m,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]},tt},

\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
tt=Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying1VanillaIntegrand2CC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period,period/100}];
ListPlot[tt,Joined->True,PlotLabel->"U1:2nd Inv. Fourier:",PlotRange->All]]


Test2BiHestonUnderlying1Vanilla3[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_},period_]:=Module[{\[Beta]m,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]},tt},

tt=Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying1VanillaIntegrandCC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period,period/100}];
ListPlot[tt,Joined->True,PlotLabel->"U1:2nd Inv. Fourier:",PlotRange->All]]


SmileBiHestonUnderlying1Vanilla[S_,\[Alpha]1_,a_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=SmileBiHestonUnderlying1VanillaAux[S,\[Alpha]1,a,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag] 


SmileBiHestonUnderlying1Vanilla2[S_,\[Alpha]1_,a_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=SmileBiHestonUnderlying1VanillaAux2[S,\[Alpha]1,a,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag] 


SmileBiHestonUnderlying1VanillaAux[S_,\[Alpha]1_,a1_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{a,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]=",\[Beta]," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2 || MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]=",BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonUnderlying1VanillaIntegrandCC[Y,\[Alpha]1,a1,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonUnderlying1VanillaIntegrandCC[Y,\[Alpha]1,a1,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period1},PlotPoints->50,PlotRange->All,PlotLabel->"U1:1st Inv. Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==5|| MemberQ[printflag,5] ,Print["{Y,\[Alpha]1,a1,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2}=",{Y,\[Alpha]1,a1,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2}];
Print["LegendreCoeffsFromLegendre[LegendreCoef1,0,period1]=",LegendreCoeffsFromLegendre[LegendreCoef1,0,period1]];
(* Print["Integrand over period1=",Map[(SmileSymetrizedBiHestonUnderlying1VanillaIntegrandCC[Y,\[Alpha]1,a1,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,#,0][[1]])&,LegendreCoeffsFromLegendre[LegendreCoef1,0,period1]]]*)];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying1VanillaIntegrandCC[Y,\[Alpha]1,a1,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,2period2,period2/30}],Joined->True,PlotLabel->"U1:2nd Inv. Fourier:",PlotRange->All]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["code integ 2 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"];
Print["code integ 1 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,a=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying1VanillaIntegrandCC[Y,\[Alpha]1,a1,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==7|| MemberQ[printflag,7] ,Print["\[Omega]2=",\[Omega]2," Integ_2=",a]];a[[2]]],LegendreCoef2,LegendreCoef1n,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==7|| MemberQ[printflag,7] ,Print["Integ_1=",res]];
res[[2]]]


SmileBiHestonUnderlying1VanillaAux2[S_,\[Alpha]1_,a1_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{a,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]m=",\[Beta]m //MatrixForm," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==1 || MemberQ[printflag,1]  ,Print["BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]=",BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonUnderlying1VanillaIntegrand2CC[Y,\[Alpha]1,a1,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonUnderlying1VanillaIntegrand2CC[Y,\[Alpha]1,a1,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period1},PlotPoints->50,PlotRange->All,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying1VanillaIntegrand2CC[Y,\[Alpha]1,a1,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period2,period2/30}],Joined->True,PlotLabel->"2nd Inverse Fourier:"]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["code integ 2 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"];
Print["code integ 1 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,a=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying1VanillaIntegrand2CC[Y,\[Alpha]1,a1,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==7|| MemberQ[printflag,7] ,Print["\[Omega]2=",\[Omega]2," Integ_2=",a]];a[[2]]],LegendreCoef2,LegendreCoef1n,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==7|| MemberQ[printflag,7] ,Print["Integ_1=",res]];
res[[2]]]


SmileSymetrizedBiHestonUnderlying1VanillaIntegrand[Y_,\[Alpha]1_,a_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],k1=(\[Omega]1+\[ImaginaryI] \[Lambda]1),Sk1=(-\[Omega]1+\[ImaginaryI] \[Lambda]1),k2= (\[Omega]2+\[ImaginaryI] \[Lambda]2),Sk2= (-\[Omega]2+\[ImaginaryI] \[Lambda]2),Sk1A=(-\[Omega]1+\[ImaginaryI] \[Lambda]1),k1A=(\[Omega]1-\[ImaginaryI] \[Lambda]1),k2A=(\[Omega]2-\[ImaginaryI] \[Lambda]2),\[Alpha],\[Alpha]A,Sym\[Alpha],Sym\[Alpha]A,\[Alpha]2,\[Alpha]A2,Sym\[Alpha]2,Sym\[Alpha]A2,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
Re[\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 k1-\[ImaginaryI] x2 k2);\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 k1-\[ImaginaryI] x2 k2A);Sym\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1-\[ImaginaryI] x2 k2);Sym\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1A-\[ImaginaryI] x2 k2A);
propagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2},\[Beta],\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1,-\[ImaginaryI] k2},\[Beta],\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2A},\[Beta],\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1A,-\[ImaginaryI] k2A},\[Beta],\[Tau]];
Table[\[Alpha] propagatorDroit FirstUnderlyingVanillaPayOffFourierDroite[k1,k2,KList[[i]],\[Alpha]1,a]+
Sym\[Alpha] SympropagatorDroit FirstUnderlyingVanillaPayOffFourierDroite[Sk1,k2,KList[[i]],\[Alpha]1,a]+
\[Alpha]A propagatorGauche FirstUnderlyingVanillaPayOffFourierGauche[k1,k2A,KList[[i]],\[Alpha]1,a]+
Sym\[Alpha]A SympropagatorGauche FirstUnderlyingVanillaPayOffFourierGauche[Sk1A,k2A,KList[[i]],\[Alpha]1,a],{i,1,Length[KList]}]]]



SmileSymetrizedBiHestonUnderlying1VanillaIntegrand2[Y_,\[Alpha]1_,a_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],k1=(\[Omega]1+\[ImaginaryI] \[Lambda]1),Sk1=(-\[Omega]1+\[ImaginaryI] \[Lambda]1),k2= (\[Omega]2+\[ImaginaryI] \[Lambda]2),Sk2= (-\[Omega]2+\[ImaginaryI] \[Lambda]2),Sk1A=(-\[Omega]1+\[ImaginaryI] \[Lambda]1),k1A=(\[Omega]1-\[ImaginaryI] \[Lambda]1),k2A=(\[Omega]2-\[ImaginaryI] \[Lambda]2),\[Alpha],\[Alpha]A,Sym\[Alpha],Sym\[Alpha]A,\[Alpha]2,\[Alpha]A2,Sym\[Alpha]2,Sym\[Alpha]A2,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
Re[\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 k1-\[ImaginaryI] x2 k2);\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 k1-\[ImaginaryI] x2 k2A);Sym\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1-\[ImaginaryI] x2 k2);Sym\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1A-\[ImaginaryI] x2 k2A);
propagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2},\[Beta]m,\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1,-\[ImaginaryI] k2},\[Beta]m,\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2A},\[Beta]m,\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1A,-\[ImaginaryI] k2A},\[Beta]m,\[Tau]];
Table[\[Alpha] propagatorDroit FirstUnderlyingVanillaPayOffFourierDroite[k1,k2,KList[[i]],\[Alpha]1,a]+
Sym\[Alpha] SympropagatorDroit FirstUnderlyingVanillaPayOffFourierDroite[Sk1,k2,KList[[i]],\[Alpha]1,a]+
\[Alpha]A propagatorGauche FirstUnderlyingVanillaPayOffFourierGauche[k1,k2A,KList[[i]],\[Alpha]1,a]+
Sym\[Alpha]A SympropagatorGauche FirstUnderlyingVanillaPayOffFourierGauche[Sk1A,k2A,KList[[i]],\[Alpha]1,a],{i,1,Length[KList]}]]]



FirstUnderlyingVanillaPayOffFourierDroite[k1_,k2_,K_,\[Alpha]_,a_]:=(a K (K/\[Alpha])^((\[ImaginaryI] k1)/a))/(a k1 k2+\[ImaginaryI] k1^2 k2)


FirstUnderlyingVanillaPayOffFourierGauche[k1_,k2_,K_,\[Alpha]_,a_]:=(-a K (K/\[Alpha])^((\[ImaginaryI] k1)/a))/(a k1 k2+\[ImaginaryI] k1^2 k2)


SmileBiHestonUnderlying2Vanilla[S_,\[Beta]1_,b_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,Q,prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,1,\[Beta]1,1,b,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"Underlying2Option",printflag];
prices=SmileBiHestonUnderlying2Vanilla[S,\[Beta]1,b,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Max[\[Beta]1 S[[2]]^b-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


SmileBiHestonUnderlying2Vanilla2[S_,\[Beta]1_,b_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,\[Beta]m,prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,1,\[Beta]1,1,b,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"Underlying2Option",printflag];
\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
prices=SmileBiHestonUnderlying2Vanilla2[S,\[Beta]1,b,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Max[\[Beta]1 S[[2]]^b-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


SmileBiHestonUnderlying2Vanilla3[S_,\[Beta]1_,b_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,\[CapitalSigma]inf,prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},\[CapitalSigma]inf=\[CapitalSigma]inf=SolveSymetricEquation[M,-2\[Beta]^2 Transpose[Q].Q] ;
If[Length[KList1]==0,KList={KList1},KList=KList1];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,1,\[Beta]1,1,b,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"Underlying2Option",printflag];
prices=SmileBiHestonUnderlying2Vanilla[S,\[Beta]1,b,KList,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Max[\[Beta]1 S[[2]]^b-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


TestBiHestonUnderlying2Vanilla[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,period_]:=
Module[{Q,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
Print["Valeur en 0 : ",SmileSymetrizedBiHestonUnderlying2VanillaIntegrandCC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,0][[1]]];
Plot[SmileSymetrizedBiHestonUnderlying2VanillaIntegrandCC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period},PlotPoints->50,PlotRange->{-0.5,0.5},PlotLabel->"Integrand Underlying 1: K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


Test3BiHestonUnderlying2Vanilla[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,period_]:=
Module[{Q,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
Print["Valeur en 0 : ",SmileSymetrizedBiHestonUnderlying2VanillaIntegrandCC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,0][[1]]];
Plot[SmileSymetrizedBiHestonUnderlying2VanillaIntegrandCC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period},PlotPoints->50,PlotRange->All,PlotLabel->"Integrand Underlying 1: K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


TestBiHestonUnderlying2Vanilla2[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,period_]:=
Module[{\[Beta]m,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
Print["Valeur en 0 : ",SmileSymetrizedBiHestonUnderlying2VanillaIntegrand2CC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,0][[1]]];
Plot[SmileSymetrizedBiHestonUnderlying2VanillaIntegrand2CC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period},PlotPoints->50,PlotRange->{-0.5,0.5},PlotLabel->"Integrand Underlying 1: K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


Test2BiHestonUnderlying2Vanilla[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_},period_]:=Module[{Q,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]},tt},
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
Print["Valeur en 0 : ",VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying2VanillaIntegrandCC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,0][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]];
tt=Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying2VanillaIntegrandCC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period,period/100}];
ListPlot[tt,Joined->True,PlotLabel->"U1:2nd Inv. Fourier:",PlotRange->All]]


Test2BiHestonUnderlying2Vanilla2[S_,\[Alpha]1_,a_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_},period_]:=Module[{\[Beta]m,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]},tt},

\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
Print["Valeur en 0 : ",VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying2VanillaIntegrand2CC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,0][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]];
tt=Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying2VanillaIntegrand2CC[Y,\[Alpha]1,a,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period,period/100}];
ListPlot[tt,Joined->True,PlotLabel->"U1:2nd Inv. Fourier:",PlotRange->All]]


SmileBiHestonUnderlying2Vanilla[S_, \[Beta]1_, b_, KList_, \[Tau]_, \[CapitalSigma]_, M_, \[CapitalSigma]inf_, Q_, \[Rho]_, \[Mu]_, \[Beta]_, \[Lambda]1_, \[Lambda]2_, {LegendreCoef1_, LegendreCoef1n_, period1_, period1n_, \[Epsilon]1_, imax_, startmonitortime_, plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_}, {LegendreCoef2_, period2_, period2n_, \[Epsilon]2_,kmax_,StartControl_,IncrementFactor_}, printflag_] := SmileBiHestonUnderlying2VanillaAux[S, \[Beta]1, b, KList, \[Tau], \[CapitalSigma], M, \[CapitalSigma]inf, Q, \[Rho], \[Mu], \[Beta], \[Lambda]1, \[Lambda]2, {LegendreCoef1, LegendreCoef1n, period1, period1n, \[Epsilon]1, imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2}, {LegendreCoef2, period2, period2n, \[Epsilon]2,kmax,StartControl,IncrementFactor}, printflag] 


SmileBiHestonUnderlying2Vanilla2[S_, \[Beta]1_, b_, KList_, \[Tau]_, \[CapitalSigma]_, M_, \[CapitalSigma]inf_, Q_, \[Rho]_, \[Mu]_, \[Beta]m_, \[Lambda]1_, \[Lambda]2_, {LegendreCoef1_, LegendreCoef1n_, period1_, period1n_, \[Epsilon]1_, imax_, startmonitortime_, plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_}, {LegendreCoef2_, period2_, period2n_, \[Epsilon]2_,kmax_,StartControl_,IncrementFactor_}, printflag_] := SmileBiHestonUnderlying2VanillaAux2[S, \[Beta]1, b, KList, \[Tau], \[CapitalSigma], M, \[CapitalSigma]inf, Q, \[Rho], \[Mu], \[Beta]m, \[Lambda]1, \[Lambda]2, {LegendreCoef1, LegendreCoef1n, period1, period1n, \[Epsilon]1, imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2}, {LegendreCoef2, period2, period2n, \[Epsilon]2,kmax,StartControl,IncrementFactor}, printflag] 


SmileBiHestonUnderlying2VanillaAux[S_,\[Beta]1_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{a,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]=",\[Beta]," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2 || MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]=",BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonUnderlying2VanillaIntegrandCC[Y,\[Beta]1,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonUnderlying2VanillaIntegrandCC[Y,\[Beta]1,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period1},PlotPoints->50,PlotRange->All,PlotLabel->"U2:1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying2VanillaIntegrandCC[Y,\[Beta]1,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period2,period2/30}],Joined->True,PlotLabel->"U2:2nd Inverse Fourier:",PlotRange->All]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["code integ 2 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"];
Print["code integ 1 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,a=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying2VanillaIntegrandCC[Y,\[Beta]1,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==7|| MemberQ[printflag,7],Print["\[Omega]2=",\[Omega]2," Integ_2=",a]];a[[2]]],LegendreCoef2,LegendreCoef1n,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==7|| MemberQ[printflag,7],Print["Integ_1=",res]];
res[[2]]]


SmileBiHestonUnderlying2VanillaAux2[S_,\[Beta]1_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{a,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]m=",\[Beta]m //MatrixForm," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2 || MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]=",BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonUnderlying2VanillaIntegrand2CC[Y,\[Beta]1,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonUnderlying2VanillaIntegrand2CC[Y,\[Beta]1,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period2},PlotPoints->50,PlotRange->All,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying2VanillaIntegrand2CC[Y,\[Beta]1,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period2,period2/30}],Joined->True,PlotLabel->"2nd Inverse Fourier:",PlotRange->All]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["code integ 2 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"];
Print["code integ 1 : {i,exploded<1,Abs[increment[[1]]]>\[Epsilon],(i<imax)}"]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,a=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonUnderlying2VanillaIntegrand2CC[Y,\[Beta]1,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==7|| MemberQ[printflag,7],Print["\[Omega]2=",\[Omega]2," Integ_2=",a]];a[[2]]],LegendreCoef2,LegendreCoef1n,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==7|| MemberQ[printflag,7],Print["Integ_1=",res]];
res[[2]]]


SmileSymetrizedBiHestonUnderlying2VanillaIntegrand[Y_,\[Beta]1_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],k1=(\[Omega]1+\[ImaginaryI] \[Lambda]1),Sk1=(-\[Omega]1+\[ImaginaryI] \[Lambda]1),k2= (\[Omega]2+\[ImaginaryI] \[Lambda]2),Sk1A=(-\[Omega]1-\[ImaginaryI] \[Lambda]1),k1A=(\[Omega]1-\[ImaginaryI] \[Lambda]1),k2A=(\[Omega]2+\[ImaginaryI] \[Lambda]2),\[Alpha],\[Alpha]A,Sym\[Alpha],Sym\[Alpha]A,\[Alpha]2,\[Alpha]A2,Sym\[Alpha]2,Sym\[Alpha]A2,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
Re[\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 k1-\[ImaginaryI] x2 k2);\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 k1A-\[ImaginaryI] x2 k2A);Sym\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1-\[ImaginaryI] x2 k2);Sym\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1A-\[ImaginaryI] x2 k2A);
propagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2},\[Beta],\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1,-\[ImaginaryI] k2},\[Beta],\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] k1A,-\[ImaginaryI] k2A},\[Beta],\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1A,-\[ImaginaryI] k2A},\[Beta],\[Tau]];
Table[\[Alpha] propagatorDroit SecondUnderlyingVanillaPayOffFourierDroite[k1,k2,KList[[i]],\[Beta]1,b]+
Sym\[Alpha] SympropagatorDroit SecondUnderlyingVanillaPayOffFourierDroite[Sk1,k2,KList[[i]],\[Beta]1,b]+
\[Alpha]A propagatorGauche SecondUnderlyingVanillaPayOffFourierGauche[k1A,k2A,KList[[i]],\[Beta]1,b]+
Sym\[Alpha]A SympropagatorGauche SecondUnderlyingVanillaPayOffFourierGauche[Sk1A,k2A,KList[[i]],\[Beta]1,b],{i,1,Length[KList]}]]]



SmileSymetrizedBiHestonUnderlying2VanillaIntegrand2[Y_,\[Beta]1_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],k1=(\[Omega]1+\[ImaginaryI] \[Lambda]1),Sk1=(-\[Omega]1+\[ImaginaryI] \[Lambda]1),k2= (\[Omega]2+\[ImaginaryI] \[Lambda]2),Sk1A=(-\[Omega]1-\[ImaginaryI] \[Lambda]1),k1A=(\[Omega]1-\[ImaginaryI] \[Lambda]1),k2A=(\[Omega]2+\[ImaginaryI] \[Lambda]2),\[Alpha],\[Alpha]A,Sym\[Alpha],Sym\[Alpha]A,\[Alpha]2,\[Alpha]A2,Sym\[Alpha]2,Sym\[Alpha]A2,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
Re[\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 k1-\[ImaginaryI] x2 k2);\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 k1A-\[ImaginaryI] x2 k2A);Sym\[Alpha]=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1-\[ImaginaryI] x2 k2);Sym\[Alpha]A=\[ExponentialE]^(-\[ImaginaryI] x1 Sk1A-\[ImaginaryI] x2 k2A);
propagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] k1,-\[ImaginaryI] k2},\[Beta]m,\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1,-\[ImaginaryI] k2},\[Beta]m,\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] k1A,-\[ImaginaryI] k2A},\[Beta]m,\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI] Sk1A,-\[ImaginaryI] k2A},\[Beta]m,\[Tau]];
Table[\[Alpha] propagatorDroit SecondUnderlyingVanillaPayOffFourierDroite[k1,k2,KList[[i]],\[Beta]1,b]+
Sym\[Alpha] SympropagatorDroit SecondUnderlyingVanillaPayOffFourierDroite[Sk1,k2,KList[[i]],\[Beta]1,b]+
\[Alpha]A propagatorGauche SecondUnderlyingVanillaPayOffFourierGauche[k1A,k2A,KList[[i]],\[Beta]1,b]+
Sym\[Alpha]A SympropagatorGauche SecondUnderlyingVanillaPayOffFourierGauche[Sk1A,k2A,KList[[i]],\[Beta]1,b],{i,1,Length[KList]}]]]



SecondUnderlyingVanillaPayOffFourierDroite[k1_,k2_,K_,\[Beta]_,b_]:=(b K (K/\[Beta])^((\[ImaginaryI] k2)/b))/(b k1 k2+\[ImaginaryI] k2^2 k1)


SecondUnderlyingVanillaPayOffFourierGauche[k1_,k2_,K_,\[Beta]_,b_]:=(-b K (K/\[Beta])^((\[ImaginaryI] k2)/b))/(b k1 k2+\[ImaginaryI] k2^2 k1)


SmileBiHestonMaxOption[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,Q,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"MaxOption",printflag];

prices=SmileBiHestonMaxOptionAux[S,\[Alpha]1,\[Beta]1,a,b,KList1,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Max[Max[\[Alpha]1 S[[1]]^a,\[Beta]1 S[[2]]^b]-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


TestBiHestonMaxOption[S_,\[Alpha]1_,\[Beta]1_,a_,b_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,scope_]:=Module[{KList,period2,Q,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]},\[Omega]1=0},
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
period2=scope/Sqrt[(\[CapitalSigma][[1,1]]+\[CapitalSigma][[2,2]]+\[CapitalSigma]inf[[1,1]]+\[CapitalSigma]inf[[2,2]])/4 \[Tau]];
Plot[SmileSymetrizedBiHestonMaxOptionIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period2},PlotPoints->50,PlotRange->All,PlotLabel->"Integrand spreadoption : K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


SmileBiHestonMaxOption2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},\[Beta]m,prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"MaxOption",printflag];
prices=SmileBiHestonMaxOptionAux[S,\[Alpha]1,\[Beta]1,a,b,KList1,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Max[Max[\[Alpha]1 S[[1]]^a,\[Beta]1 S[[2]]^b]-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


SmileBiHestonMaxOption3[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,\[CapitalSigma]inf,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
\[CapitalSigma]inf=\[CapitalSigma]inf=SolveSymetricEquation[M,-2\[Beta]^2 Transpose[Q].Q] ;
If[Length[KList1]==0,KList={KList1},KList=KList1];

{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"MaxOption",printflag];

prices=SmileBiHestonMaxOptionAux[S,\[Alpha]1,\[Beta]1,a,b,KList1,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Max[Max[\[Alpha]1 S[[1]]^a,\[Beta]1 S[[2]]^b]-KList1[[i]],0,prices[[i]]],{i,1,Length[KList1]}]
]


TestNormalizedBiHestonMaxOption[S_,\[Alpha]1_,\[Beta]1_,a_,b_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Lambda]1_,\[Lambda]2_,scope_]:=Module[{Q,period2,\[Alpha]2=0.2/Sqrt[\[CapitalSigma][[1,1]]],\[Beta]2=0.2/Sqrt[\[CapitalSigma][[2,2]]],H,HInv,Sa,am,bm,\[CapitalSigma]a,Ma,\[CapitalSigma]infa,\[Mu],\[Omega]1=0,Y={Log[S[[1]]],Log[S[[2]]]}},H=({
 {\[Alpha]2, 0},
 {0, \[Beta]2}
});HInv=({
 {\[Alpha]2^-1, 0},
 {0, \[Beta]2^-1}
});
Sa=H.S;am=a/ \[Alpha]2;bm=b /\[Beta]2;\[CapitalSigma]a=(H.\[CapitalSigma]).H;Ma=H.M.HInv;\[CapitalSigma]infa=H.\[CapitalSigma]inf.H;\[Mu]={(\[Alpha]2 (\[Alpha]2-1))/2,(\[Beta]2 (\[Beta]2-1))/2};
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
period2=scope/Sqrt[(\[CapitalSigma][[1,1]]+\[CapitalSigma][[2,2]]+\[CapitalSigma]inf[[1,1]]+\[CapitalSigma]inf[[2,2]])/4 \[Tau]];
Plot[SmileSymetrizedBiHestonMaxOptionIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period2},PlotPoints->50,PlotRange->All,PlotLabel->"Integrand spreadoption : K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


SmileBiHestonMaxOptionAux[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]=",\[Beta]," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2 || MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]=",BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonMaxOptionIntegrandCC[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonMaxOptionIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period2},PlotPoints->50,PlotRange->All,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonMaxOptionIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period2,period2/60}],Joined->True,PlotLabel->"2nd Inverse Fourier:",PlotRange->All]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonMaxOptionIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,0.1,0.1]]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,as=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonMaxOptionIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==7|| MemberQ[printflag,7],Print["Integ_2=",as]];as[[2]]],LegendreCoef2,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==7|| MemberQ[printflag,7],Print["Integ_1=",res]];
res[[2]]]


SmileBiHestonMaxOptionAux2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]m=",\[Beta]m //MatrixForm," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2 || MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]=",BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonMaxOptionIntegrand2CC[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonMaxOptionIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period1},PlotPoints->50,PlotRange->All,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonMaxOptionIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period2,period2/30}],Joined->True,PlotLabel->"2nd Inverse Fourier:",PlotRange->All]]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,as=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonMaxOptionIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==2,Print["Integ_2=",as]];as[[2]]],LegendreCoef2,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==2,Print["Integ_1=",res]];
res[[2]]]


SmileSymetrizedBiHestonMaxOptionIntegrand[Y_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],\[Lambda]1G,\[Lambda]2G,\[Lambda]1D,\[Lambda]2D,\[Alpha]D,\[Alpha]G,Sym\[Alpha]D,Sym\[Alpha]G,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
\[Lambda]1G=(\[Lambda]1 +\[Lambda]2 a/b+a);\[Lambda]2G=(-\[Lambda]2);\[Lambda]1D=(-\[Lambda]1);\[Lambda]2D=(\[Lambda]2 +\[Lambda]1 b/a+a);
\[Alpha]D=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));\[Alpha]G=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));Sym\[Alpha]D=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));Sym\[Alpha]G=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));
propagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta],\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI](\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta],\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta],\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta],\[Tau]];
Table[Re[\[Alpha]D propagatorDroit MaxOptionPayOffFourierDroite[(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha]D SympropagatorDroit MaxOptionPayOffFourierDroite[-(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
\[Alpha]G propagatorGauche MaxOptionPayOffFourierGauche[(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha]G SympropagatorGauche MaxOptionPayOffFourierGauche[-(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b]],{i,1,Length[KList]}]
]


SmileSymetrizedBiHestonMaxOptionIntegrand2[Y_,\[Alpha]1_,\[Beta]1_,a_,b_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],\[Lambda]1G,\[Lambda]2G,\[Lambda]1D,\[Lambda]2D,\[Alpha]D,\[Alpha]G,Sym\[Alpha]D,Sym\[Alpha]G,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
\[Lambda]1G=(\[Lambda]1 +\[Lambda]2 a/b+a);\[Lambda]2G=(-\[Lambda]2);\[Lambda]1D=(-\[Lambda]1);\[Lambda]2D=(\[Lambda]2 +\[Lambda]1 b/a+a);
\[Alpha]D=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));\[Alpha]G=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));Sym\[Alpha]D=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));Sym\[Alpha]G=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));
propagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta]m,\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI](\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta]m,\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta]m,\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta]m,\[Tau]];
Table[Re[\[Alpha]D propagatorDroit MaxOptionPayOffFourierDroite[(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha]D SympropagatorDroit MaxOptionPayOffFourierDroite[-(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
\[Alpha]G propagatorGauche MaxOptionPayOffFourierGauche[(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b]+
Sym\[Alpha]G SympropagatorGauche MaxOptionPayOffFourierGauche[-(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b]],{i,1,Length[KList]}]
]


MaxOptionPayOffFourierDroite[k1_,k2_,K_,\[Alpha]_,\[Beta]_,a_,b_]:=(a K^(\[ImaginaryI] (k1/a+k2/b)) \[Alpha]^(-((\[ImaginaryI] k1)/a)) \[Beta]^(-((a+\[ImaginaryI] k2)/b)) (\[ImaginaryI] K^(a/b) (b k1+a k2) \[Beta]^2-K (a^2+\[ImaginaryI] b k1+\[ImaginaryI] a k2) \[Beta]^(a/b)))/(k1 (a^2+\[ImaginaryI] b k1+\[ImaginaryI] a k2) (b k1+a k2)) 
  si Re[a]<Im[(b k1)/a]+Im[k2]&&Im[(b k1)/a+k2]>0 &&Im[k1]<0


MaxOptionPayOffFourierGauche[k1_,k2_,K_,\[Alpha]_,\[Beta]_,a_,b_]:=-((b K^(1+(\[ImaginaryI] k1)/a+(\[ImaginaryI] k2)/b) (a (b-\[ImaginaryI] k2 (-1+\[Alpha]))-\[ImaginaryI] b k1 (-1+\[Alpha])) \[Alpha]^(-((\[ImaginaryI] k1)/a)) \[Beta]^(-((\[ImaginaryI] k2)/b)))/((\[ImaginaryI] b k1+a (b+\[ImaginaryI] k2)) k2 (b k1+a k2)))  
 si Re[a]<Im[k1]+Im[(a k2)/b]&&Im[k1+(a k2)/b]>0 && Im[k2]<0


SmileBiHestonPaysFloat1Digital[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,Q,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,c,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"MaxOption",printflag];

prices=SmileBiHestonPaysFloat1Digital[S,\[Alpha]1,\[Beta]1,a,b,c,KList1,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Min[S[[1]],Max[0,prices[[i]]]],{i,1,Length[KList1]}]
]


SmileBiHestonPaysFloat1Digital2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},\[Beta]m,prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,c,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"MaxOption",printflag];
prices=SmileBiHestonPaysFloat1DigitalAux[S,\[Alpha]1,\[Beta]1,a,b,c,KList1,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Min[S[[1]],Max[0,prices[[i]]]],{i,1,Length[KList1]}]
]


SmileBiHestonPaysFloat1Digital3[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,\[CapitalSigma]inf,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
\[CapitalSigma]inf=\[CapitalSigma]inf=SolveSymetricEquation[M,-2\[Beta]^2 Transpose[Q].Q] ;
If[Length[KList1]==0,KList={KList1},KList=KList1];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,c,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"MaxOption",printflag];

prices=SmileBiHestonPaysFloat1Digital[S,\[Alpha]1,\[Beta]1,a,b,c,KList1,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Min[S[[1]],Max[0,prices[[i]]]],{i,1,Length[KList1]}]
]


TestBiHestonPaysFloat1Digital[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,scope_]:=Module[{KList,period2,Q,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]},\[Omega]1=0},
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
period2=scope/Sqrt[(\[CapitalSigma][[1,1]]+\[CapitalSigma][[2,2]]+\[CapitalSigma]inf[[1,1]]+\[CapitalSigma]inf[[2,2]])/4 \[Tau]];
Plot[SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,c,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period2},PlotPoints->50,PlotRange->All,PlotLabel->"Integrand spreadoption : K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


SmileBiHestonPaysFloat1DigitalAux[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]=",\[Beta]," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2 || MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]=",BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonPaysFloat1DigitalIntegrandCC[Y,\[Alpha]1,\[Beta]1,a,b,c,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,c,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period2},PlotPoints->50,PlotRange->All,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,c,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period2,period2/60}],Joined->True,PlotLabel->"2nd Inverse Fourier:",PlotRange->All]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,c,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,0.1,0.1]]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,as=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,c,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==7|| MemberQ[printflag,7],Print["Integ_2=",as]];as[[2]]],LegendreCoef2,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==7|| MemberQ[printflag,7],Print["Integ_1=",res]];
res[[2]]]


SmileBiHestonPaysFloat1DigitalAux2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]m=",\[Beta]m// MatrixForm," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2 || MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]=",BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand2CC[Y,\[Alpha]1,\[Beta]1,a,b,c,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,c,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period1},PlotPoints->50,PlotRange->All,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,c,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period2,period2/30}],Joined->True,PlotLabel->"2nd Inverse Fourier:",PlotRange->All]]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,as=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,c,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==2,Print["Integ_2=",as]];as[[2]]],LegendreCoef2,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==2,Print["Integ_1=",res]];
res[[2]]]


SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand[Y_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],\[Lambda]1G,\[Lambda]2G,\[Lambda]1D,\[Lambda]2D,\[Alpha]D,\[Alpha]G,Sym\[Alpha]D,Sym\[Alpha]G,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
\[Lambda]1G=(\[Lambda]1 +\[Lambda]2 a/b+a);\[Lambda]2G=(-\[Lambda]2);\[Lambda]1D=(-\[Lambda]1);\[Lambda]2D=(\[Lambda]2 +\[Lambda]1 b/a+a);
\[Alpha]D=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));\[Alpha]G=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));Sym\[Alpha]D=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));Sym\[Alpha]G=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));
propagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta],\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI](\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta],\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta],\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta],\[Tau]];
Table[Re[\[Alpha]D propagatorDroit PaysFloat1DigitalPayOffFourierDroite[(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
Sym\[Alpha]D SympropagatorDroit PaysFloat1DigitalPayOffFourierDroite[-(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
\[Alpha]G propagatorGauche PaysFloat1DigitalPayOffFourierGauche[(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
Sym\[Alpha]G SympropagatorGauche PaysFloat1DigitalPayOffFourierGauche[-(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]],{i,1,Length[KList]}]
]


SmileSymetrizedBiHestonPaysFloat1DigitalIntegrand2[Y_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],\[Lambda]1G,\[Lambda]2G,\[Lambda]1D,\[Lambda]2D,\[Alpha]D,\[Alpha]G,Sym\[Alpha]D,Sym\[Alpha]G,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
\[Lambda]1G=(\[Lambda]1 +\[Lambda]2 a/b+a);\[Lambda]2G=(-\[Lambda]2);\[Lambda]1D=(-\[Lambda]1);\[Lambda]2D=(\[Lambda]2 +\[Lambda]1 b/a+a);
\[Alpha]D=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));\[Alpha]G=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));Sym\[Alpha]D=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));Sym\[Alpha]G=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));
propagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta]m,\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI](\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta]m,\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta]m,\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta]m,\[Tau]];
Table[Re[\[Alpha]D propagatorDroit PaysFloat1DigitalPayOffFourierDroite[(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
Sym\[Alpha]D SympropagatorDroit PaysFloat1DigitalPayOffFourierDroite[-(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
\[Alpha]G propagatorGauche PaysFloat1DigitalPayOffFourierGauche[(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
Sym\[Alpha]G SympropagatorGauche PaysFloat1DigitalPayOffFourierGauche[-(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]],{i,1,Length[KList]}]
]


PaysFloat1DigitalPayOffFourierDroite[k1_,k2_,K_,\[Alpha]_,\[Beta]_,a_,b_,c_]:=-((\[ImaginaryI] K^((c+\[ImaginaryI] k1)/a) (1/\[Alpha])^((c+\[ImaginaryI] k1)/a) Hypergeometric2F1[-((c+\[ImaginaryI] k1)/a),(\[ImaginaryI] k2)/b,1+(\[ImaginaryI] k2)/b,-(\[Beta]/K)])/((c+\[ImaginaryI] k1) k2))


PaysFloat1DigitalPayOffFourierGauche[k1_,k2_,K_,\[Alpha]_,\[Beta]_,a_,b_,c_]:=  (\[ImaginaryI] K^((c+\[ImaginaryI] k1)/a) (1/\[Alpha])^((c+\[ImaginaryI] k1)/a) Hypergeometric2F1[-((c+\[ImaginaryI] k1)/a),(\[ImaginaryI] k2)/b,1+(\[ImaginaryI] k2)/b,-(\[Beta]/K)])/((c+\[ImaginaryI] k1) k2)


SmileBiHestonPaysFloat2Digital[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,Q,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,c,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"MaxOption",printflag];

prices=SmileBiHestonPaysFloat2Digital[S,\[Alpha]1,\[Beta]1,a,b,c,KList1,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Min[S[[2]],Max[0,prices[[i]]]],{i,1,Length[KList1]}]
]


TestBiHestonPaysFloat2Digital[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,\[Beta]_,\[Rho]_,\[Mu]_,\[Lambda]1_,\[Lambda]2_,scope_]:=Module[{KList,period2,Q,as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]},\[Omega]1=0},
Q=CholeskyDecomposition[-((M.\[CapitalSigma]inf+\[CapitalSigma]inf. Transpose[M])/2)]/\[Beta];
period2=scope/Sqrt[(\[CapitalSigma][[1,1]]+\[CapitalSigma][[2,2]]+\[CapitalSigma]inf[[1,1]]+\[CapitalSigma]inf[[2,2]])/4 \[Tau]];
Plot[SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,c,{K},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period2},PlotPoints->50,PlotRange->All,PlotLabel->"Integrand spreadoption : K ="<>ToString[K]<>" \[Omega]1="<>ToString[\[Omega]1]]]


SmileBiHestonPaysFloat2Digital2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},\[Beta]m,prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
\[Beta]m=-((M.\[CapitalSigma]inf+\[CapitalSigma]inf.Transpose[M])/2).Inverse[(Transpose[Q].Q)];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,c,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"MaxOption",printflag];
prices=SmileBiHestonPaysFloat2DigitalAux[S,\[Alpha]1,\[Beta]1,a,b,c,KList1,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Min[S[[2]],Max[0,prices[[i]]]],{i,1,Length[KList1]}]
]


SmileBiHestonPaysFloat2Digital3[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList1_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Beta]_,\[Rho]_,\[Mu]_,printflag_]:=Module[{KList,LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,\[Lambda]1,\[Lambda]2,\[CapitalSigma]inf,KListPositive,KListNegative,KPositivePrices={},KNegativePrices={},prices,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
If[Length[KList1]==0,KList={KList1},KList=KList1];
\[CapitalSigma]inf=\[CapitalSigma]inf=SolveSymetricEquation[M,-2\[Beta]^2 Transpose[Q].Q] ;
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a,b,c,KList[[1]],\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],"MaxOption",printflag];

prices=SmileBiHestonPaysFloat2Digital[S,\[Alpha]1,\[Beta]1,a,b,c,KList1,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},printflag];
Table[Min[S[[2]],Max[0,prices[[i]]]],{i,1,Length[KList1]}]
]


SmileBiHestonPaysFloat2DigitalAux[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]=",\[Beta]," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2 || MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]=",BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta],\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonPaysFloat2DigitalIntegrandCC[Y,\[Alpha]1,\[Beta]1,a,b,c,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,c,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period2},PlotPoints->50,PlotRange->All,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,c,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period2,period2/60}],Joined->True,PlotLabel->"2nd Inverse Fourier:",PlotRange->All]]];
If[printflag==7|| MemberQ[printflag,7] ,Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,c,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,0.1,0.1]]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,as=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand[Y,\[Alpha]1,\[Beta]1,a,b,c,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta],\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==7|| MemberQ[printflag,7],Print["Integ_2=",as]];as[[2]]],LegendreCoef2,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==7|| MemberQ[printflag,7],Print["Integ_1=",res]];
res[[2]]]


SmileBiHestonPaysFloat2DigitalAux2[S_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,{LegendreCoef1_,LegendreCoef1n_,period1_,period1n_,\[Epsilon]1_,imax_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_,InitialTailPosition2_},{LegendreCoef2_,period2_,period2n_,\[Epsilon]2_,kmax_,StartControl_,IncrementFactor_},printflag_]:=
2/(2\[Pi])^2 Module[{as,res,res2,Y={Log[S[[1]]],Log[S[[2]]]}},
If[printflag==1 || MemberQ[printflag,1]  ,Print[" S=",S // MatrixForm," \[CapitalSigma]=",\[CapitalSigma] //MatrixForm,"M=",M//MatrixForm," \[CapitalSigma]inf=",\[CapitalSigma]inf//MatrixForm ," Q=",Q//MatrixForm ," \[Rho]=",\[Rho]//MatrixForm," \[Mu]=",\[Mu]//MatrixForm," \[Beta]m=",\[Beta]m // MatrixForm," T=",\[Tau]];
Print["Inner Integration",{{"LegendreNbMain",Length[LegendreCoef1]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef2]},{"PeriodMain",period1},{"PeriodnIncrement",period1n},{"StoppingLevel",\[Epsilon]1},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"ExplosionMonitoringStartAbcisse",StartControl},{"ExplosionMonitoringMaxLevel",IncrementFactor},
{"lambda1",\[Lambda]1},{"lambda2",\[Lambda]2}} // MatrixForm,
"Outer Integration",{{"LegendreNbMain",Length[LegendreCoef2]},{"LegendreNbIncrement",Length[LegendreCoef1n]},{"IncrementNbMax",imax},{"InitialTailFlag",initialTailFlag},{"InitialTailLegendreNb",Length[LegendreCoef1]},{"PeriodMain",period2},{"PeriodnIncrement",period2n},{"StoppingLevel",\[Epsilon]2},
{"AbcisseMaxValue",kmax},{"InitialTailUpperLimit",InitialTailPosition},
{"GrowingControlStartAbcisse",startmonitortime},{"GrowingControlMaxFactor",plafondexplosion}} // MatrixForm]];
If[printflag==2|| MemberQ[printflag,2]  ,Print["BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]=",BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI] 1,-\[ImaginaryI] 1},\[Beta]m,\[Tau]]];
Print["integrand(0.1,0.1)=",SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand2CC[Y,\[Alpha]1,\[Beta]1,a,b,c,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,0.1,0.1]]];
If[printflag==4|| MemberQ[printflag,4] ,Print[Table[Plot[SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,c,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]],{\[Omega]2,0 ,2period1},PlotPoints->50,PlotRange->All,PlotLabel->"1st Inverse Fourier: K ="<>ToString[KList[[1]]]<>" \[Omega]1="<>ToString[\[Omega]1]],{\[Omega]1,{0,0.2,2}}]]];
If[printflag==6|| MemberQ[printflag,6] ,Print[ListPlot[Table[{\[Omega]2,VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,c,{KList[[1]]},\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2][[1]]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition][[2,1]]},{\[Omega]2,0,period2,period2/30}],Joined->True,PlotLabel->"2nd Inverse Fourier:",PlotRange->All]]];
res=VectorAdaptativeIntegrateUnprotected[Function[\[Omega]2,as=VectorAdaptativeIntegrateExplosionSafe[Function[\[Omega]1,SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand2[Y,\[Alpha]1,\[Beta]1,a,b,c,KList,\[Tau],\[CapitalSigma],M,Q,\[Rho],\[Mu],\[Beta]m,\[Lambda]1,\[Lambda]2,\[Omega]1,\[Omega]2]],LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,imax,Length[KList],startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition];If[printflag==2,Print["Integ_2=",as]];as[[2]]],LegendreCoef2,period2,period2n,\[Epsilon]2,imax,Length[KList],printflag,initialTailFlag,InitialTailPosition2,kmax,StartControl,IncrementFactor];
If[printflag==2,Print["Integ_1=",res]];
res[[2]]]


SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand[Y_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],\[Lambda]1G,\[Lambda]2G,\[Lambda]1D,\[Lambda]2D,\[Alpha]D,\[Alpha]G,Sym\[Alpha]D,Sym\[Alpha]G,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
\[Lambda]1G=(\[Lambda]1 +\[Lambda]2 a/b+a);\[Lambda]2G=(-\[Lambda]2);\[Lambda]1D=(-\[Lambda]1);\[Lambda]2D=(\[Lambda]2 +\[Lambda]1 b/a+a);
\[Alpha]D=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));\[Alpha]G=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));Sym\[Alpha]D=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));Sym\[Alpha]G=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));
propagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta],\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI](\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta],\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta],\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta],\[Tau]];
Table[Re[\[Alpha]D propagatorDroit PaysFloat2DigitalPayOffFourierDroite[(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
Sym\[Alpha]D SympropagatorDroit PaysFloat2DigitalPayOffFourierDroite[-(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
\[Alpha]G propagatorGauche PaysFloat2DigitalPayOffFourierGauche[(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
Sym\[Alpha]G SympropagatorGauche PaysFloat2DigitalPayOffFourierGauche[-(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]],{i,1,Length[KList]}]
]


SmileSymetrizedBiHestonPaysFloat2DigitalIntegrand2[Y_,\[Alpha]1_,\[Beta]1_,a_,b_,c_,KList_,\[Tau]_,\[CapitalSigma]_,M_,Q_,\[Rho]_,\[Mu]_,\[Beta]m_,\[Lambda]1_,\[Lambda]2_,\[Omega]1_,\[Omega]2_]:=Module[{x1=Y[[1]],x2=Y[[2]],\[Lambda]1G,\[Lambda]2G,\[Lambda]1D,\[Lambda]2D,\[Alpha]D,\[Alpha]G,Sym\[Alpha]D,Sym\[Alpha]G,propagatorDroit,SympropagatorDroit,propagatorGauche,SympropagatorGauche,propagatorDroit2,SympropagatorDroit2,propagatorGauche2,SympropagatorGauche2},
\[Lambda]1G=(\[Lambda]1 +\[Lambda]2 a/b+a);\[Lambda]2G=(-\[Lambda]2);\[Lambda]1D=(-\[Lambda]1);\[Lambda]2D=(\[Lambda]2 +\[Lambda]1 b/a+a);
\[Alpha]D=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));\[Alpha]G=\[ExponentialE]^(-\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));Sym\[Alpha]D=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1D)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2D));Sym\[Alpha]G=\[ExponentialE]^(\[ImaginaryI] x1 (\[Omega]1+\[ImaginaryI] \[Lambda]1G)-\[ImaginaryI] x2 (\[Omega]2+\[ImaginaryI] \[Lambda]2G));
propagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho], \[Mu],\[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta]m,\[Tau]];SympropagatorDroit=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1D),-\[ImaginaryI](\[Omega]2+\[ImaginaryI] \[Lambda]2D)},\[Beta]m,\[Tau]];
propagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{-\[ImaginaryI](\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta]m,\[Tau]];SympropagatorGauche=BiHestonLaplaceQuickTransform2[M,Q,\[Rho],\[Mu], \[CapitalSigma],{\[ImaginaryI] (\[Omega]1+\[ImaginaryI] \[Lambda]1G),-\[ImaginaryI] (\[Omega]2+\[ImaginaryI] \[Lambda]2G)},\[Beta]m,\[Tau]];
Table[Re[\[Alpha]D propagatorDroit PaysFloat2DigitalPayOffFourierDroite[(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
Sym\[Alpha]D SympropagatorDroit PaysFloat2DigitalPayOffFourierDroite[-(\[Omega]1+\[ImaginaryI] \[Lambda]1D),(\[Omega]2+\[ImaginaryI] \[Lambda]2D),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
\[Alpha]G propagatorGauche PaysFloat2DigitalPayOffFourierGauche[(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]+
Sym\[Alpha]G SympropagatorGauche PaysFloat2DigitalPayOffFourierGauche[-(\[Omega]1+\[ImaginaryI] \[Lambda]1G),(\[Omega]2+\[ImaginaryI] \[Lambda]2G),KList[[i]],\[Alpha]1,\[Beta]1,a,b,c]],{i,1,Length[KList]}]
]


PaysFloat2DigitalPayOffFourierDroite[k1_,k2_,K_,\[Alpha]_,\[Beta]_,a_,b_,c_]:=(\[ImaginaryI]  (\[Beta]/\[Alpha])^((\[ImaginaryI] k1)/a)    Hypergeometric2F1[-((\[ImaginaryI] k1)/a),-((a c+\[ImaginaryI] b k1+\[ImaginaryI] a k2)/(a b)),1-(\[ImaginaryI] k1)/a-(c+\[ImaginaryI] k2)/b,-( K/\[Beta])])/(b ((\[ImaginaryI] k1)/a+(c+\[ImaginaryI] k2)/b)k1   )


PaysFloat2DigitalPayOffFourierGauche[k1_,k2_,K_,\[Alpha]_,\[Beta]_,a_,b_,c_]:=  (\[ImaginaryI]  ((K/\[Alpha])^(((\[ImaginaryI] k1)/a)))  )/(k1 (c+\[ImaginaryI] k2)) Hypergeometric2F1[-((\[ImaginaryI] k1)/a),(c+\[ImaginaryI] k2)/b,(b+c+\[ImaginaryI] k2)/b,-( \[Beta]/K)]


IntegerConvert[x_,{x1_,n1_},{x2_,n2_},nmax_]:=Module[{ntheo=n1+Max[0,Floor[(x-x1)/(x2-x1) (n2-n1)]]},Min[ntheo,nmax]]


RealConvert[x_,{x1_,n1_},{x2_,n2_},nmax_]:=Module[{ntheo=n1+Max[0,(x-x1)/(x2-x1) (n2-n1)]},Min[ntheo,nmax]]


BiHestonVanillaOptimalParameters[S_,\[Alpha]1_,\[Beta]1_,a1_,b1_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,type_]:=BiHestonVanillaOptimalParameters[S,\[Alpha]1,\[Beta]1,a1,b1,K,\[Tau],\[CapitalSigma],M,\[CapitalSigma]inf,Q,\[Rho],\[Mu],type,0]


BiHestonVanillaOptimalParameters[S_,\[Alpha]1_,\[Beta]1_,a1_,b1_,K_,\[Tau]_,\[CapitalSigma]_,M_,\[CapitalSigma]inf_,Q_,\[Rho]_,\[Mu]_,type_,printflag_]:=Module[{\[Lambda]1,\[Lambda]2,scope1,scope2,Nb1,LegendreCoef1,Nb1n,LegendreCoef1n,period1,period1n,\[Epsilon]1,Nb2,LegendreCoef2,period2,period2n,\[Epsilon]2,imax,s1=S[[1]],s2=S[[2]],Rmax,smax,smin,forward=S[[1]]-S[[2]],scopeDivisor1=1,scopeDivisor1n=1,scopeDivisor2=1,scopeDivisor2n=1,VolNb,\[CapitalSigma]moyen,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2,kmax,StartControl,IncrementFactor},
(* defaut parameters *)
\[CapitalSigma]moyen=(\[CapitalSigma][[1,1]]+\[CapitalSigma][[2,2]]+\[CapitalSigma]inf[[1,1]]+\[CapitalSigma]inf[[2,2]])/4;
scope1=3/Sqrt[\[CapitalSigma]moyen \[Tau]];scope2=4/Sqrt[\[CapitalSigma]moyen \[Tau]];
Nb1=12;Nb1n=8;Nb2=12;
period1=scope1* 1.21;period1n=scope1;
period2=scope2;period2n=scope2/10;
(* non default *)
If[type=="VanillaSpreadoption",
\[Lambda]1=1.1;\[Lambda]2=1.01;
smin=Min[\[Alpha]1 s1,\[Beta]1 s2];smax=Max[\[Alpha]1 s1,\[Beta]1 s2];
If[K!= 0,
Nb1=IntegerConvert[-Log[Abs[K]/smax],{1,12},{6,12},130];
Nb1n=IntegerConvert[-Log[Abs[K]/smax],{1,8},{6,8},130];
Nb2=IntegerConvert[-Log[Abs[K]/smax],{1,12},{6,12},130]];
Nb1=Max[Nb1,IntegerConvert[(smax-smin)/smax,{0.1,12},{0.9,30},130]];
Nb1n=Max[Nb1n,IntegerConvert[(smax-smin)/smax,{0.1,8},{0.9,20},130]];
Nb2=Max[Nb2,IntegerConvert[(smax-smin)/smax,{0.1,12},{0.9,30},130]];
Nb1=Max[Nb1,IntegerConvert[-Log[smin/smax],{0.01,12},{2,20},130]];
Nb1n=Max[Nb1n,IntegerConvert[-Log[smin/smax],{0.01,8},{2,16},130]];
Nb2=Max[Nb2,IntegerConvert[-Log[smin/smax],{0.01,12},{2,20},130]];
If[K!=0,
scopeDivisor1=RealConvert[-Log[Abs[K]/smax],{1,1},{6,1},2];
scopeDivisor1n=RealConvert[-Log[Abs[K]/smax],{1,1},{6,1},2];
scopeDivisor2=RealConvert[-Log[Abs[K]/smax],{1,1},{6,1},2];
scopeDivisor2n=RealConvert[-Log[Abs[K]/smax],{1,1},{6,4},4]];
scopeDivisor1=Max[scopeDivisor1,RealConvert[(smax-smin)/smax,{0.1,1},{0.9,2},2]];
scopeDivisor1n=Max[scopeDivisor1n,RealConvert[(smax-smin)/smax,{0.1,1},{0.9,4},4]];
scopeDivisor2=Max[scopeDivisor2,RealConvert[(smax-smin)/smax,{0.1,1},{0.9,1},2]];
scopeDivisor2n=Max[scopeDivisor2n,RealConvert[(smax-smin)/smax,{0.1,1},{0.9,4},4]];
\[Epsilon]1=0.000001;\[Epsilon]2=0.000001;imax=20;
];

If[(type=="Underlying2Option"),
\[Lambda]1=2;\[Lambda]2=1.1;
scope1=2/Sqrt[\[CapitalSigma]moyen \[Tau]];scope2=3/Sqrt[\[CapitalSigma]moyen \[Tau]];
Nb1=30;Nb1n=20;Nb2=30;
period1=scope1;period1n=scope1;
period2=scope2;period2n=scope2/10;
Nb1=IntegerConvert[-Log[\[CapitalSigma][[2,2]]],{3,30},{6,60},130];
Nb1n=IntegerConvert[-Log[\[CapitalSigma][[2,2]]],{3,20},{6,30},130];
Nb2=IntegerConvert[-Log[\[CapitalSigma][[2,2]]],{3,30},{6,50},130];
];
If[(type=="MaxOption"),
\[Lambda]1=2;\[Lambda]2=1.1;
scope1=5/Sqrt[\[CapitalSigma]moyen \[Tau]];scope2=5/Sqrt[\[CapitalSigma]moyen \[Tau]];
Nb1=30;Nb1n=20;Nb2=30;
period1=scope1;period1n=scope1;
period2=scope2;period2n=scope2/10;
Nb1=IntegerConvert[-Log[\[CapitalSigma][[2,2]]],{3,30},{6,60},130];
Nb1n=IntegerConvert[-Log[\[CapitalSigma][[2,2]]],{3,20},{6,30},130];
Nb2=IntegerConvert[-Log[\[CapitalSigma][[2,2]]],{3,30},{6,50},130];
\[Epsilon]1=0.000001;\[Epsilon]2=0.000001;imax=20;
];
If[a1!=1 || b1!=1,Nb2=Max[Nb2,20]];
VolNb=RealConvert[-Log[\[CapitalSigma]moyen],{3,1},{6.9,4.1},10];
Nb1=Floor[Nb1*VolNb];Nb2=Floor[Nb2*VolNb];
Nb2=Min[Nb2,80];
period1 /=scopeDivisor1;period1n /=scopeDivisor1n;period2 /=scopeDivisor2;period2n /=scopeDivisor2n;

If[(type=="Underlying1Option"),

(*scope1=3/Sqrt[\[CapitalSigma]moyen \[Tau]];scope2=4/Sqrt[\[CapitalSigma]moyen \[Tau]];
Nb1=30;Nb1n=20;Nb2=30;
period1=scope1*1.21;period1n=scope1;
period2=scope2;period2n=scope2/10;
Nb1=IntegerConvert[-Log[\[CapitalSigma][[1,1]]],{3,30},{6,30},130];
Nb1n=IntegerConvert[-Log[\[CapitalSigma][[1,1]]],{3,30},{6,30},130];
Nb2=IntegerConvert[-Log[\[CapitalSigma][[1,1]]],{3,30},{6,50},130];
*)
(* 
\[Lambda]1=2;\[Lambda]2=1.1;imax=10;
period1=7;period1n=5;period2=6;period2n=2;
Nb1=25;Nb2=20;Nb1n=10;\[Epsilon]1=0.0000001;\[Epsilon]2=0.000001;
startmonitortime=10;
plafondexplosion=0.1;
initialTailFlag=0;
InitialTailPosition=0;
InitialTailPosition2=0;
kmax=1000;
StartControl=30;
IncrementFactor=4;
*)
\[Lambda]1=2;\[Lambda]2=1.1;imax=10;
period1=4;period1n=2;period2=6;period2n=3;
Nb1=35;Nb2=20;Nb1n=10;\[Epsilon]1=0.0000001;\[Epsilon]2=0.000001;
startmonitortime=10;
plafondexplosion=0.1;
initialTailFlag=0;
InitialTailPosition=0;
InitialTailPosition2=0;
kmax=1000;
StartControl=30;
IncrementFactor=4;
(* avec correlation *)
\[Lambda]1=2;\[Lambda]2=1.1;imax=10;
period1=5;period1n=2;period2=6;period2n=2;
Nb1=35;Nb2=30;Nb1n=10;\[Epsilon]1=0.0000001;\[Epsilon]2=0.000001;
startmonitortime=10;
plafondexplosion=0.1;
initialTailFlag=1;
InitialTailPosition=0.5;
InitialTailPosition2=0.5;
kmax=16;
StartControl=30;
IncrementFactor=4;
(*model de marche*)
\[Lambda]1=2;\[Lambda]2=1.1;imax=60;
period1=1;period1n=3;period2=1;period2n=2;
Nb1=30;Nb2=20;Nb1n=8;\[Epsilon]1=0.0000001;\[Epsilon]2=0.00000001;
startmonitortime=10;
plafondexplosion=0.1;
initialTailFlag=1;
InitialTailPosition=0.5;
InitialTailPosition2=0.5;
kmax=16;
StartControl=30;
IncrementFactor=4;

];
If[(type=="Underlying2Option"),
\[Lambda]1=2;\[Lambda]2=1.2;
(* scope1=2/Sqrt[\[CapitalSigma]moyen \[Tau]];scope2=3/Sqrt[\[CapitalSigma]moyen \[Tau]];
Nb1=30;Nb1n=20;Nb2=30;
period1=scope1;period1n=scope1;
period2=scope2;period2n=scope2/10;
Nb1=IntegerConvert[-Log[\[CapitalSigma][[2,2]]],{3,30},{6,60},130];
Nb1n=IntegerConvert[-Log[\[CapitalSigma][[2,2]]],{3,20},{6,30},130];
Nb2=IntegerConvert[-Log[\[CapitalSigma][[2,2]]],{3,30},{6,50},130];
*)
(*
\[Lambda]1=2;\[Lambda]2=2;imax=60;
period1=1;period1n=3;period2=1;period2n=2;
Nb1=25;Nb2=15;Nb1n=8;\[Epsilon]1=0.00001;\[Epsilon]2=0.0001;
startmonitortime=10;
plafondexplosion=1;
initialTailFlag=1;
InitialTailPosition=0.05;
InitialTailPosition2=0.05;
kmax=100;
StartControl=3;
IncrementFactor=2;
*)
\[Lambda]1=2;\[Lambda]2=2;imax=60;
period1=3;period1n=3;period2=5;period2n=2;
Nb1=25;Nb2=15;Nb1n=8;\[Epsilon]1=0.00001;\[Epsilon]2=0.0001;
startmonitortime=10;
plafondexplosion=1;
initialTailFlag=1;
InitialTailPosition=0.05;
InitialTailPosition2=0.05;
kmax=100;
StartControl=3;
IncrementFactor=2;
(* avec correlation *)
\[Lambda]1=2;\[Lambda]2=2;imax=60;
period1=6;period1n=1;period2=6;period2n=1;
Nb1=35;Nb2=35;Nb1n=10;\[Epsilon]1=0.00001;\[Epsilon]2=0.0001;
startmonitortime=8;
plafondexplosion=0.1;
initialTailFlag=0;
InitialTailPosition=0.05;
InitialTailPosition2=0.05;
kmax=17;
StartControl=5;
IncrementFactor=2;

];
If[(type=="VanillaSpreadoption"),

(*scope1=3/Sqrt[\[CapitalSigma]moyen \[Tau]];scope2=4/Sqrt[\[CapitalSigma]moyen \[Tau]];
Nb1=30;Nb1n=20;Nb2=30;
period1=scope1*1.21;period1n=scope1;
period2=scope2;period2n=scope2/10;
Nb1=IntegerConvert[-Log[\[CapitalSigma][[1,1]]],{3,30},{6,30},130];
Nb1n=IntegerConvert[-Log[\[CapitalSigma][[1,1]]],{3,30},{6,30},130];
Nb2=IntegerConvert[-Log[\[CapitalSigma][[1,1]]],{3,30},{6,50},130];
*)
(*
\[Lambda]1=1.1;\[Lambda]2=1.01;imax=10;
period1=8;period1n=3;period2=3;period2n=1.;
Nb1=25;Nb2=25;Nb1n=8;\[Epsilon]1=0.000001;\[Epsilon]2=0.00001;
startmonitortime=2;
plafondexplosion=0.1;
initialTailFlag=1;
InitialTailPosition=2;
InitialTailPosition2=2;
kmax=100;
StartControl=20;
IncrementFactor=2;
*)
\[Lambda]1=1.1;\[Lambda]2=1.01;imax=10;
period1=8;period1n=3;period2=5;period2n=1.;
Nb1=25;Nb2=25;Nb1n=8;\[Epsilon]1=0.000001;\[Epsilon]2=0.00001;
startmonitortime=2;
plafondexplosion=0.1;
initialTailFlag=1;
InitialTailPosition=2;
InitialTailPosition2=2;
kmax=100;
StartControl=20;
IncrementFactor=2;
];
LegendreCoef1=LegendreCoeffs[Nb1];LegendreCoef1n=LegendreCoeffs[Nb1n];
LegendreCoef2=LegendreCoeffs[Nb2];
If[printflag==1|| MemberQ[printflag,1],Print["Nb1=",Nb1," Nb1n=",Nb1n," Nb2=",Nb2]];
{{LegendreCoef1,LegendreCoef1n,period1,period1n,\[Epsilon]1,startmonitortime,plafondexplosion,initialTailFlag,InitialTailPosition,InitialTailPosition2},{LegendreCoef2,period2,period2n,\[Epsilon]2,kmax,StartControl,IncrementFactor},imax,\[Lambda]1,\[Lambda]2}]



LegendreCoeffsRepository=Table[{i,0},{i,1,200}];


LegendreCoeffs[n_]:=Module[{ll,ll1},ll=LegendreCoeffsRepository[[n,2]];If[ll===0,ll1=LegendreCoeffsAux[n];
LegendreCoeffsRepository[[n,2]]=ll1,
ll1=ll];ll1]


LegendreCoeffsAux[n_]:=Module[{Nacc=2Naccurracy,lst},
If[n>40,Nacc=40];
If[n>56,Nacc=60];
If[n>82,Nacc=70];
If[n>95,Nacc=80];
If[n>105,Nacc=100];
If[n>130,Nacc=120];
If[n>150,Nacc=n];
lst=LegendreCoeffs[n,Nacc];
SetAccuracy[lst,16]
]


LegendreCoeffs[n_,nprec_]:=Module[{xj,i,racines,legendreWeight,legendreRoot,xxx1973},racines=NSolve[LegendreP[n,xxx1973]==0,xxx1973,nprec];
legendreWeight=Table[
2/((1- xxx1973^2)/.racines[[j]])/(D[LegendreP[n,xxx1973],xxx1973] /. racines[[j]])^2,{j,1,Length[racines]}];
legendreRoot=Table[xxx1973 /.racines[[j]],{j,1,Length[racines]}];
Sort[Table[Re[{legendreRoot[[i]],legendreWeight[[i]]}],{i,1,n}],(#1[[1]]<#2[[1]])&]]


LegendreCoeffs[n_,a_,b_]:=LegendreCoeffsFromLegendre[LegendreCoeffs[n],a,b]


AdaptativeIntegrate[Func_,LegendreCoef0_,LegendreCoefn_,period0_,periodn_,\[Epsilon]_,imax_, initialperiod_,LegendreCoefn2_]:=Module[{sum=0.0,increment=0,i=0},
sum=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn2,0,initialperiod]];
sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,initialperiod,period0]];
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]];
While[(Abs[increment]>\[Epsilon])&&(i<imax),
sum+=increment;i+=1;
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]];
];{i,sum}]


VectorAdaptativeIntegrate[Func_,LegendreCoef0_,LegendreCoefn_,period0_,periodn_,\[Epsilon]_,imax_, initialperiod_,LegendreCoefn2_]:=Module[{sum=0.0,increment=0,i=0},
sum=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn2,0,initialperiod]];
sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,initialperiod,period0]];
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]];
While[(Abs[increment[[1]]]>\[Epsilon])&&(i<imax),
sum+=increment;i+=1;
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]];
];{i,sum}]


AdaptativeIntegrate[Func_,LegendreCoef0_,LegendreCoefn_,period0_,periodn_,\[Epsilon]_,imax_]:=Module[{sum=0.0,increment=\[Epsilon] 1.1,incrementPrec=10^8,i=0},
sum=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,period0]];
While[(Abs[increment]>\[Epsilon])&&(i<imax)&&(Abs[increment]<2 Abs[incrementPrec]),sum+=increment;incrementPrec=increment;increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]];i+=1];{i,sum}]


AdaptativeIntegrate[Func_,LegendreCoef0_,period0_,periodn_,\[Epsilon]_,imax_]:=Module[{sum=0.0,increment=\[Epsilon]+1,incrementPrec=10^8,i=0},
sum=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,period0]];
While[(Abs[increment]>\[Epsilon])&&(i<imax)&&(Abs[increment]<2Abs[incrementPrec]),sum+=increment;incrementPrec=increment;
increment=Func[period0+(i+1/2)*periodn]periodn;i+=1];{i,sum}]


VectorAdaptativeIntegrate[Func_,LegendreCoef0_,LegendreCoefn_,period0_,periodn_,\[Epsilon]_,imax_,n_]:=Module[{sum=Table[0.0,{i,1,n}],increment=Table[0,{i,1,n}],i=0,incrementPrec=Table[0,{i,1,n}]},
sum=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,period0]];
While[(i==0)||((i==1)&&(Max[Abs[increment]]>\[Epsilon]))||((Max[Abs[increment]]>\[Epsilon])&&(i<imax)&&(Max[Abs[increment]]<3Max[Abs[incrementPrec]])),sum+=increment;incrementPrec=increment;
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]];i+=1];{{i,imax,Max[Abs[increment]],Max[Abs[incrementPrec]],{(Max[Abs[increment]]>\[Epsilon]),(i<imax),(Max[Abs[increment]]<3Max[Abs[incrementPrec]])}},sum}]


VectorAdaptativeIntegrate[Func_,LegendreCoef0_,period0_,periodn_,\[Epsilon]_,imax_,n_]:=Module[{sum=Table[0.0,{i,1,n}],increment=Table[\[Epsilon] 1.1,{i,1,n}],incrementPrec=Table[10^8,{i,1,n}],i=0},
sum=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,period0]];
While[(i==0)||((i==1)&&(Max[Abs[increment]]>\[Epsilon]))||((Max[Abs[increment]]>\[Epsilon])&&(i<imax)&&(Max[Abs[increment]]<3Max[Abs[incrementPrec]])),sum+=increment;incrementPrec=increment;
increment=Func[period0+(i+1/2)*periodn]periodn;i+=1];{i,sum}]


(*
VectorAdaptativeIntegrateUnprotected[Func_,LegendreCoef0_,LegendreCoefn_,period0_,periodn_,\[Epsilon]_,imax_,n_,printflag_,initialTailFlag_,InitialTailPosition_]:=Module[{sum=Table[0.0,{i,1,n}],increment=Table[0,{i,1,n}],i=0},
If[initialTailFlag>0,sum=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,InitialTailPosition]];If[printflag==8|| MemberQ[printflag,8] ,Print[" sum pre-initiale=",sum]];sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,InitialTailPosition,period0]],sum=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,period0]]];
If[printflag==8|| MemberQ[printflag,8] ,Print[" sum initiale=",sum]];
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]];
If[printflag==8|| MemberQ[printflag,8] ,Print["kini=",period0+i*periodn," increment initial=",increment]];
If[(Abs[increment[[1]]]>\[Epsilon])&&(i<imax),sum+=increment;i+=1];
While[(Abs[increment[[1]]]>\[Epsilon])&&(i<imax),
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]];sum+=increment;i+=1;If[printflag==8|| MemberQ[printflag,8] ,Print[" i=",i," Kini=",period0+i*periodn," increment =",increment]]];
If[printflag==8|| MemberQ[printflag,8] ,Print[" Sum finale=",sum]];
{{i,Abs[increment[[1]]],{If[(Abs[increment[[1]]]>\[Epsilon]),"Abs[increment[[1]]]>\[Epsilon]:"<>ToString[Abs[increment[[1]]]]],If[(i<imax),"i<imax:"<>ToString[i]]}},sum}]
*)


(*
VectorAdaptativeIntegrateUnprotected[Func_,LegendreCoef0_,LegendreCoefn_,period0_,periodn_,\[Epsilon]_,imax_,n_,printflag_,initialTailFlag_,InitialTailPosition_,kmax_]:=Module[{sum=Table[0.0,{i,1,n}],increment=Table[0,{i,1,n}],i=0},
If[initialTailFlag>0,sum=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,InitialTailPosition]];If[printflag==8|| MemberQ[printflag,8] ,Print[" sum pre-initiale=",sum]];
If[period0<kmax,sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,InitialTailPosition,period0]],
sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,InitialTailPosition,kmax]]],If[period0<kmax,sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,period0]],
sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,kmax]]]];
If[printflag==8|| MemberQ[printflag,8] ,Print[" sum initiale=",sum]];

If[period0+(i+1)*periodn<kmax,increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]],
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,Max[period0+i*periodn,kmax]]];
];
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]];
If[printflag==8|| MemberQ[printflag,8] ,Print["kini=",period0+i*periodn," increment initial=",increment]];
If[(Abs[increment[[1]]]>\[Epsilon])&&(i<imax),sum+=increment;i+=1];
While[(Abs[increment[[1]]]>\[Epsilon])&&(i<imax)&&(period0+i*periodn<kmax),
If[period0+(i+1)*periodn<kmax,increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]],
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,Max[period0+i*periodn,kmax]]]
]
;sum+=increment;i+=1;If[printflag==8|| MemberQ[printflag,8] ,Print[" i=",i," Kini=",period0+i*periodn," increment =",increment]]];
If[printflag==8|| MemberQ[printflag,8] ,Print[" Sum finale=",sum]];
{{i,Abs[increment[[1]]],{If[(Abs[increment[[1]]]<=\[Epsilon]),"increment<=\[Epsilon] :"<>ToString[Abs[increment[[1]]]]],If[(i<imax),"i>imax :"<>ToString[i]],If[(period0+i*periodn>kmax),"period0+i*periodn>kmax:"<>ToString[period0+i*periodn]]}},sum}]
*)


VectorAdaptativeIntegrateUnprotected[Func_,LegendreCoef0_,LegendreCoefn_,period0_,periodn_,\[Epsilon]_,imax_,n_,printflag_,initialTailFlag_,InitialTailPosition_,kmax_,StartControl_,IncrementFactor_]:=Module[{sum=Table[0.0,{i,1,n}],increment=Table[0,{i,1,n}],i=0,incrementPrecedent},
If[initialTailFlag>0,sum=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,InitialTailPosition]];If[printflag==8|| MemberQ[printflag,8] ,Print[" sum pre-initiale=",sum]];
If[period0<kmax,sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,InitialTailPosition,period0]],
sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,InitialTailPosition,kmax]]],If[period0<kmax,sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,period0]],
sum+=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,kmax]]]];
If[printflag==8|| MemberQ[printflag,8] ,Print[" sum initiale=",sum]];
If[period0+(i+1)*periodn<kmax,increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]],
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,Max[period0+i*periodn,kmax]]];
];
If[printflag==8|| MemberQ[printflag,8] ,Print["k={",period0+i*periodn,",",period0+(i+1)*periodn,"}  increment initial=",increment]];
If[(Abs[increment[[1]]]>\[Epsilon])&&(i<imax),sum+=increment;i+=1];
incrementPrecedent=1.1 increment;
While[(Abs[increment[[1]]]>\[Epsilon])&&(i<imax)&&(period0+i*periodn<kmax)&&(Abs[increment[[1]]]<= IncrementFactor Abs[incrementPrecedent[[1]]]),
incrementPrecedent=increment;
If[period0+(i+1)*periodn<kmax,increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn]],
increment=CoeffBasedIntegrate[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,Max[period0+i*periodn,kmax]]]
];
If[printflag==8|| MemberQ[printflag,8] ,Print[" i=",i," k={",period0+i*periodn,",",period0+(i+1)*periodn,"}  increment =",increment]];
sum+=increment;i+=1;
];
If[printflag==8|| MemberQ[printflag,8] ,Print["raison=",{If[(Abs[increment[[1]]]<=\[Epsilon]),"increment<=\[Epsilon] :"<>ToString[Abs[increment[[1]]]]],If[(i>=imax),"i>=imax :"<>ToString[i]],If[(period0+i*periodn>kmax),"period0+i*periodn>kmax:"<>ToString[period0+i*periodn]],
If[(Abs[increment[[1]]]> IncrementFactor Abs[incrementPrecedent[[1]]]),
"(Abs[increment[[1]]] > IncrementFactor Abs[incrementPrecedent[[1]]]):"<>ToString[Abs[increment[[1]]]]<>" > "<>ToString[IncrementFactor]<>" X "<>ToString[Abs[incrementPrecedent[[1]]]]]}];Print[" Sum finale=",sum]];
{{i,Abs[increment[[1]]],{If[(Abs[increment[[1]]]<=\[Epsilon]),"increment<=\[Epsilon] :"<>ToString[Abs[increment[[1]]]]],If[(i>=imax),"i>=imax :"<>ToString[i]],If[(period0+i*periodn>kmax),"period0+i*periodn>kmax:"<>ToString[period0+i*periodn]],
If[(Abs[increment[[1]]]> IncrementFactor Abs[incrementPrecedent[[1]]]),
"(Abs[increment[[1]]] > IncrementFactor Abs[incrementPrecedent[[1]]]):"<>ToString[Abs[increment[[1]]]]<>" > "<>ToString[IncrementFactor]<>" X "<>ToString[Abs[incrementPrecedent[[1]]]]]}},sum}]


VectorAdaptativeIntegrateExplosionSafe[Func_,LegendreCoef0_,LegendreCoefn_,period0_,periodn_,\[Epsilon]_,imax_,n_,startmonitortime_,plafondexplosion_,initialTailFlag_,InitialTailPosition_]:=Module[{sum=Table[0.0,{i,1,n}],increment=Table[0,{i,1,n}],i=0,incrementPrec=Table[0,{i,1,n}],exploded},
If[initialTailFlag>0,
{sum,exploded}=VectorCoeffBasedIntegrateExplosionSafe[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,InitialTailPosition],n,startmonitortime,plafondexplosion];
{increment,exploded}=VectorCoeffBasedIntegrateExplosionSafe[Func,LegendreCoeffsFromLegendre[LegendreCoef0,InitialTailPosition,period0],n,startmonitortime,plafondexplosion];
sum+=increment,
{sum,exploded}=VectorCoeffBasedIntegrateExplosionSafe[Func,LegendreCoeffsFromLegendre[LegendreCoef0,0,period0],n,startmonitortime,plafondexplosion]];
If[exploded<1,
{increment,exploded}=VectorCoeffBasedIntegrateExplosionSafe[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn],n,
startmonitortime,plafondexplosion];
While[((exploded<1)&&(Abs[increment[[1]]]>\[Epsilon])&&(i<imax)),sum+=increment;i+=1;
{increment,exploded}=VectorCoeffBasedIntegrateExplosionSafe[Func,LegendreCoeffsFromLegendre[LegendreCoefn,period0+i*periodn,period0+(i+1)*periodn],n,
startmonitortime,plafondexplosion]]];
{{i,If[exploded>0,"exploded"],If[Abs[increment[[1]]]<\[Epsilon],"Abs[increment[[1]]]<\[Epsilon]:"<>ToString[Abs[increment[[1]]]]],If[(i>=imax),"i>=imax"<>ToString[i]]},sum}]


VectorCoeffBasedIntegrateExplosionSafe[f_,coeffs_,nb_,startmonitortime_,plafond_]:=Module[{n=Length[coeffs],sum=Table[0.0,{i,1,nb}],i=1,increment=Table[0.0,{i,1,nb}],exploded=0},
increment=f[coeffs[[i,1]]];
If[coeffs[[i,1]]>startmonitortime&&Max[Abs[increment]]>plafond,exploded=1];
While[i<n&&exploded<1,sum+=increment coeffs[[i,2]];i++;increment=f[coeffs[[i,1]]] ;If[coeffs[[i,1]]>startmonitortime&&Max[Abs[increment]]>plafond,exploded=1]];
If[i==n&&exploded<1,sum+=increment coeffs[[i,2]]];
{sum,exploded}]


SolveSymetricEquation[{{M11_,M12_},{M21_,M22_}},{{h11_,h12_},{h21_,h22_}}]:=Module[{a,b,c},
a=-((-h22 M12^2+h11 M12 M21-h11 M11 M22+2 h12 M12 M22-h11 M22^2)/(2 (M11+M22) (-M12 M21+M11 M22)));
b=(-h22 M11 M12+2 h12 M11 M22-h11 M21 M22)/(2 (M11+M22) (-M12 M21+M11 M22));
c=-((-h22 M11^2+2 h12 M11 M21+h22 M12 M21-h11 M21^2-h22 M11 M22)/(2 (M11+M22) (-M12 M21+M11 M22)));
{{a,b},{b,c}}]


Solve\[CapitalSigma]infFrom\[Beta][{{M11_,M12_},{M21_,M22_}},{{Q11_,Q12_},{Q21_,Q22_}},\[Beta]_]:=
Module[{a,b,c,h11=- (Q11^2+Q21^2) \[Beta],
h12=- (Q11 Q12+Q21 Q22) \[Beta],
h22=-(Q12^2+Q22^2) \[Beta]},Print[{h11,h12,h22}];
a=-((-h22 M12^2+h11 M12 M21-h11 M11 M22+2 h12 M12 M22-h11 M22^2)/(2 (M11+M22) (-M12 M21+M11 M22)));
b=(-h22 M11 M12+2 h12 M11 M22-h11 M21 M22)/(2 (M11+M22) (-M12 M21+M11 M22));
c=-((-h22 M11^2+2 h12 M11 M21+h22 M12 M21-h11 M21^2-h22 M11 M22)/(2 (M11+M22) (-M12 M21+M11 M22)));
{{a,b},{b,c}}]



SolveQFrom\[CapitalSigma]inf[{{M11_,M12_},{M21_,M22_}},{S11_,S12_,S22_},\[Beta]_]:=Module[{a,b,c,Q11,Q12,Q21,Q22},
a=(-2 M11 S11-2 M12 S12)/\[Beta];
b=(-M21 S11-M11 S12-M22 S12-M12 S22)/\[Beta];
c=(-2 M21 S12-2 M22 S22)/\[Beta];
Q11=Sqrt[a];
Q12=b/Sqrt[a];
Q21=0;
Q22=Sqrt[c- b^2/a];
{{Q11,Q12},{Q21,Q22}}
]



